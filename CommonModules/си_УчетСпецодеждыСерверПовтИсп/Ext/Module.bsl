
#Область СлужебныйПрограммныйИнтерфейс

// Текст запроса остатки материалов в эксплуатации
//
Функция ТекстЗапросаОстаткиМатериаловВЭксплуатации() Экспорт
	ТекстЗапроса=		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	си_МатериалыВЭксплуатацииОстатки.Номенклатура,
	|	си_МатериалыВЭксплуатацииОстатки.ДокументПередачи,
	|	си_МатериалыВЭксплуатацииОстатки.Сотрудник,
	|	си_МатериалыВЭксплуатацииОстатки.НазначениеИспользования,
	|	си_МатериалыВЭксплуатацииОстатки.КоличествоОстаток,
	|	си_МатериалыВЭксплуатацииОстатки.СтоимостьОстаток,
	|	си_МатериалыВЭксплуатацииОстатки.СписаннаяСтоимостьОстаток,
	|	си_МатериалыВЭксплуатацииОстатки.ОстаточныйСрокИспользования КАК ОстаточныйСрокИспользования,
	|	си_МатериалыВЭксплуатацииОстатки.Характеристика,
	|	0 КАК СостояниеСпецодежды
	|ИЗ
	|	РегистрНакопления.си_МатериалыВЭксплуатации.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И ПодразделениеОрганизации = &ПодразделениеОстатков
	|				И СтруктурноеПодразделение = &СтруктурноеПодразделение
	|				И ВидУчетаНУ = ВЫБОР
	|					КОГДА &НеобходимостьОтраженияВНУ
	|						ТОГДА &ВидУчетаНУ
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыУчетаНУ.ПустаяСсылка)
	|				КОНЕЦ
	|				И (Номенклатура, Характеристика, НазначениеИспользования, Сотрудник, ДокументПередачи) В
	|					(ВЫБРАТЬ
	|						ВТ_Материалы.Номенклатура,
	|						ВТ_Материалы.Характеристика,
	|						ВТ_Материалы.НазначениеИспользования,
	|						ВТ_Материалы.Сотрудник,
	|						ВТ_Материалы.ДокументПередачи
	|					ИЗ
	|						ТаблицаМатериалы КАК ВТ_Материалы)) КАК си_МатериалыВЭксплуатацииОстатки
	|ГДЕ
	|	(си_МатериалыВЭксплуатацииОстатки.КоличествоОстаток > 0
	|			ИЛИ си_МатериалыВЭксплуатацииОстатки.СписаннаяСтоимостьОстаток > 0
	|			ИЛИ си_МатериалыВЭксплуатацииОстатки.СтоимостьОстаток > 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстаточныйСрокИспользования";
	Возврат ТекстЗапроса;
КонецФункции

// Текст запроса остатки материалов БУ
//
Функция ТекстЗапросаОстаткиМатериаловБУ() Экспорт
	ТекстЗапроса=		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	си_МатериалыНаСкладеОстатки.Номенклатура,
	|	си_МатериалыНаСкладеОстатки.ДокументПередачи,
	|	си_МатериалыНаСкладеОстатки.НазначениеИспользования,
	|	си_МатериалыНаСкладеОстатки.КоличествоОстаток,
	|	си_МатериалыНаСкладеОстатки.СтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.ОстаточныйСрокИспользования КАК ОстаточныйСрокИспользования,
	|	си_МатериалыНаСкладеОстатки.Характеристика,
	|	си_МатериалыНаСкладеОстатки.СостояниеСпецодежды КАК СостояниеСпецодежды,
	|	си_МатериалыНаСкладеОстатки.ДокументВозврата КАК ДокументВозврата
	|ИЗ
	|	РегистрНакопления.си_МатериалыНаСкладе.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И СтруктурноеПодразделение = &СтруктурноеПодразделение
	|				И Склад = &СкладОстатков
	|				И ВидУчетаНУ = ВЫБОР
	|					КОГДА &НеобходимостьОтраженияВНУ
	|						ТОГДА &ВидУчетаНУ
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыУчетаНУ.ПустаяСсылка)
	|				КОНЕЦ
	|				И (Номенклатура, Характеристика, ДокументПередачи, НазначениеИспользования,ДокументВозврата) В
	|					(ВЫБРАТЬ
	|						ВТ_Материалы.Номенклатура,
	|						ВТ_Материалы.Характеристика,
	|						ВТ_Материалы.ДокументПередачи,
	|						ВТ_Материалы.НазначениеИспользования,
	|						ВТ_Материалы.ДокументВозврата
	|					ИЗ
	|						ТаблицаМатериалы КАК ВТ_Материалы)) КАК си_МатериалыНаСкладеОстатки
	|ГДЕ
	|	(си_МатериалыНаСкладеОстатки.КоличествоОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СтоимостьОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток > 0)
	|	И си_МатериалыНаСкладеОстатки.СостояниеСпецодежды = ЗНАЧЕНИЕ(Перечисление.си_СостояниеСпецодеждыИИнвентаряНаСкладе.НаСкладеБывшаяВУпотреблении)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстаточныйСрокИспользования";
	
	Возврат ТекстЗапроса;
КонецФункции

// Текст запроса остатки материалов Новая
//
Функция ТекстЗапросаОстаткиМатериаловНовая() Экспорт
	ТекстЗапроса=		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	си_МатериалыНаСкладеОстатки.Номенклатура,
	|	си_МатериалыНаСкладеОстатки.ДокументПередачи,
	|	си_МатериалыНаСкладеОстатки.НазначениеИспользования,
	|	си_МатериалыНаСкладеОстатки.КоличествоОстаток,
	|	си_МатериалыНаСкладеОстатки.СтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.ОстаточныйСрокИспользования КАК ОстаточныйСрокИспользования,
	|	си_МатериалыНаСкладеОстатки.Характеристика,
	|	си_МатериалыНаСкладеОстатки.СостояниеСпецодежды КАК СостояниеСпецодежды,
	|	си_МатериалыНаСкладеОстатки.ДокументВозврата
	|ИЗ
	|	РегистрНакопления.си_МатериалыНаСкладе.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И СтруктурноеПодразделение = &СтруктурноеПодразделение
	|				И Склад = &СкладОстатков
	|				И ВидУчетаНУ = ВЫБОР
	|					КОГДА &НеобходимостьОтраженияВНУ
	|						ТОГДА &ВидУчетаНУ
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыУчетаНУ.ПустаяСсылка)
	|				КОНЕЦ
	|				И (Номенклатура) В
	|					(ВЫБРАТЬ
	|						ВТ_Материалы.Номенклатура
	|					ИЗ
	|						ТаблицаМатериалы КАК ВТ_Материалы)
	|				И ДокументПередачи = ЗНАЧЕНИЕ(Документ.си_ПередачаМатериаловВЭксплуатацию.ПустаяСсылка)) КАК си_МатериалыНаСкладеОстатки
	|ГДЕ
	|	(си_МатериалыНаСкладеОстатки.КоличествоОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СтоимостьОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток > 0)
	|	И си_МатериалыНаСкладеОстатки.СостояниеСпецодежды = ЗНАЧЕНИЕ(Перечисление.си_СостояниеСпецодеждыИИнвентаряНаСкладе.НаСкладеНовая)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстаточныйСрокИспользования";
	
	Возврат ТекстЗапроса;
КонецФункции

// Текст запроса остатки материалов Новая
//
Функция ТекстЗапросаОстаткиМатериаловНаСкладе() Экспорт
	ТекстЗапроса=		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	си_МатериалыНаСкладеОстатки.Номенклатура,
	|	си_МатериалыНаСкладеОстатки.ДокументПередачи,
	|	си_МатериалыНаСкладеОстатки.НазначениеИспользования,
	|	си_МатериалыНаСкладеОстатки.КоличествоОстаток,
	|	си_МатериалыНаСкладеОстатки.СтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.ОстаточныйСрокИспользования КАК ОстаточныйСрокИспользования,
	|	си_МатериалыНаСкладеОстатки.Характеристика,
	|	си_МатериалыНаСкладеОстатки.СостояниеСпецодежды КАК СостояниеСпецодежды,
	|	си_МатериалыНаСкладеОстатки.ДокументВозврата
	|ИЗ
	|	РегистрНакопления.си_МатериалыНаСкладе.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И СтруктурноеПодразделение = &СтруктурноеПодразделение
	|				И Склад = &СкладОстатков
	|				И ВидУчетаНУ = ВЫБОР
	|					КОГДА &НеобходимостьОтраженияВНУ
	|						ТОГДА &ВидУчетаНУ
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыУчетаНУ.ПустаяСсылка)
	|				КОНЕЦ
	|				И (Номенклатура, Характеристика, ДокументПередачи, НазначениеИспользования) В
	|					(ВЫБРАТЬ
	|						ВТ_Материалы.Номенклатура,
	|						ВТ_Материалы.Характеристика,
	|						ВТ_Материалы.ДокументПередачи,
	|						ВТ_Материалы.НазначениеИспользования
	|					ИЗ
	|						ТаблицаМатериалы КАК ВТ_Материалы)) КАК си_МатериалыНаСкладеОстатки
	|ГДЕ
	|	(си_МатериалыНаСкладеОстатки.КоличествоОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СтоимостьОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток > 0)
	|	И си_МатериалыНаСкладеОстатки.СостояниеСпецодежды = ЗНАЧЕНИЕ(Перечисление.си_СостояниеСпецодеждыИИнвентаряНаСкладе.НаСкладеБывшаяВУпотреблении)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	си_МатериалыНаСкладеОстатки.Номенклатура,
	|	си_МатериалыНаСкладеОстатки.ДокументПередачи,
	|	си_МатериалыНаСкладеОстатки.НазначениеИспользования,
	|	си_МатериалыНаСкладеОстатки.КоличествоОстаток,
	|	си_МатериалыНаСкладеОстатки.СтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток,
	|	си_МатериалыНаСкладеОстатки.ОстаточныйСрокИспользования,
	|	си_МатериалыНаСкладеОстатки.Характеристика,
	|	си_МатериалыНаСкладеОстатки.СостояниеСпецодежды,
	|	си_МатериалыНаСкладеОстатки.ДокументВозврата
	|ИЗ
	|	РегистрНакопления.си_МатериалыНаСкладе.Остатки(
	|			&МоментВремени,
	|			Организация = &Организация
	|				И СтруктурноеПодразделение = &СтруктурноеПодразделение
	|				И Склад = &СкладОстатков
	|				И ВидУчетаНУ = ВЫБОР
	|					КОГДА &НеобходимостьОтраженияВНУ
	|						ТОГДА &ВидУчетаНУ
	|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыУчетаНУ.ПустаяСсылка)
	|				КОНЕЦ
	|				И Номенклатура В
	|					(ВЫБРАТЬ
	|						ВТ_Материалы.Номенклатура
	|					ИЗ
	|						ТаблицаМатериалы КАК ВТ_Материалы)
	|				И ДокументПередачи = ЗНАЧЕНИЕ(Документ.си_ПередачаМатериаловВЭксплуатацию.ПустаяСсылка)) КАК си_МатериалыНаСкладеОстатки
	|ГДЕ
	|	(си_МатериалыНаСкладеОстатки.КоличествоОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СтоимостьОстаток > 0
	|			ИЛИ си_МатериалыНаСкладеОстатки.СписаннаяСтоимостьОстаток > 0)
	|	И си_МатериалыНаСкладеОстатки.СостояниеСпецодежды = ЗНАЧЕНИЕ(Перечисление.си_СостояниеСпецодеждыИИнвентаряНаСкладе.НаСкладеНовая)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ОстаточныйСрокИспользования";
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ПолучитьСчетаУчетаСпецодежды() Экспорт
	ЭтоБСО = си_УчетСпецодеждыСерверПовтИсп.ПроверкаНаБСО();
	СчетаУчетаСпецодежды = Новый Структура("СпецоснасткаИСпецодеждаНаСкладе,СпецоснасткаИСпецодеждаВЭксплуатации,СпецоснасткаИСпецодеждаНаСкладеНУ,СпецоснасткаИСпецодеждаВЭксплуатацииНУ");
	Если ЭтоБСО Тогда
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладе 				= ПланыСчетов.Типовой.СпецоснасткаИСпецодеждаБывшиеВУпотреблении;
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатации			= ПланыСчетов.Типовой.СпецоснасткаИСпецодеждаВЭксплуатации;
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладеНУ 				= ПланыСчетов.Налоговый.МатериалыБывшиеВЭксплуатации;
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатацииНУ			= ПланыСчетов.Налоговый.МатериалыВЭксплуатации;
	Иначе
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладе 				= Константы.си_СчетУчетаСпецоснасткаИСпецодеждаНаСкладе.Получить();
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатации			= Константы.си_СчетУчетаСпецоснасткаИСпецодеждаВЭксплуатации.Получить();
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладеНУ 				= общ_ПереопределяемыеПроцедурыБКВызовСервераПовтИсп.ПреобразоватьСчетаБУвСчетНУ(Новый Структура("СчетБУ", СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладе));
		СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатацииНУ			= общ_ПереопределяемыеПроцедурыБКВызовСервераПовтИсп.ПреобразоватьСчетаБУвСчетНУ(Новый Структура("СчетБУ", СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатации));
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаНаСкладе) Тогда
		ОбщегоНазначения.СообщитьПользователю("Не заполнен счет учета в константе ""Счет учета: Спецоснастка и спецодежда бывшие в употреблении""");
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(СчетаУчетаСпецодежды.СпецоснасткаИСпецодеждаВЭксплуатации) Тогда
		ОбщегоНазначения.СообщитьПользователю("Не заполнен счет учета в константе ""Счет учета: Спецоснастка и спецодежда в эксплуатации""");
	КонецЕсли;
	
	Возврат СчетаУчетаСпецодежды;
	
КонецФункции

Функция ПолучитьУчетнуюПолитикуВеденияСпецодеждыИИнвентаря(Период) Экспорт
	
	ЭтоБСО = си_УчетСпецодеждыСерверПовтИсп.ПроверкаНаБСО();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	си_УчетнаяПолитикаСрезПоследних.ВедетсяКонтрольВыдачиСпецодеждыПоНормам,
	|	си_УчетнаяПолитикаСрезПоследних.СпособРасчетаНормВыдачиСпецодеждыИИнвентаря,
	|	си_УчетнаяПолитикаСрезПоследних.АмортизироватьМатериалыНаСкладеВМесяцВозврата,
	|	си_УчетнаяПолитикаСрезПоследних.ПорядокНачисленияАмортизации,
	|	си_УчетнаяПолитикаСрезПоследних.ВидКонтроляНорм
	|ИЗ
	|	РегистрСведений.си_УчетнаяПолитика.СрезПоследних(&Период, ) КАК си_УчетнаяПолитикаСрезПоследних";
	Запрос.УстановитьПараметр("Период",Период);
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	УчетнаяПолитика = Новый Структура();
	УчетнаяПолитика.Вставить("ВедетсяКонтрольВыдачиСпецодеждыПоНормам",	Ложь);
	УчетнаяПолитика.Вставить("СпособРасчетаНормВыдачиСпецодеждыИИнвентаря", Неопределено);
	УчетнаяПолитика.Вставить("АмортизироватьМатериалыНаСкладеВМесяцВозврата", Ложь);
	УчетнаяПолитика.Вставить("ПорядокНачисленияАмортизации", Неопределено);
	Если Выборка.Следующий() Тогда 
		УчетнаяПолитика.ВедетсяКонтрольВыдачиСпецодеждыПоНормам 		= Выборка.ВедетсяКонтрольВыдачиСпецодеждыПоНормам;
		УчетнаяПолитика.СпособРасчетаНормВыдачиСпецодеждыИИнвентаря 	= Выборка.СпособРасчетаНормВыдачиСпецодеждыИИнвентаря;
		УчетнаяПолитика.АмортизироватьМатериалыНаСкладеВМесяцВозврата 	= Выборка.АмортизироватьМатериалыНаСкладеВМесяцВозврата;
		УчетнаяПолитика.ПорядокНачисленияАмортизации 					= Выборка.ПорядокНачисленияАмортизации;
	Иначе
		ОбщегоНазначения.СообщитьПользователю("Не обнаружены настройки учетной политики по ведению спецодежды и инвентаря на указанную дату!");
	КонецЕсли;
	
	Возврат УчетнаяПолитика;
	
КонецФункции

// Определяет ведение складского учета
// 
// Возвращаемое значение:
//  Истина - вдется учет по складам, ложь - иначе.
//
Функция ВедетсяУчетПоСкладам() Экспорт
	
	БУ = ПланыСчетов.Типовой.Товары.ПолучитьОбъект();	
	
	Если БУ.ВидыСубконто.Найти(ПланыВидовХарактеристик.ВидыСубконтоТиповые.Склады, "ВидСубконто") <> Неопределено Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции // ВедетсяУчетПоСкладам()

Функция ВедетсяУчетПоХарактеристикам() Экспорт
	
	УчетПоХарактеристикам = Константы.си_УчетСпецодеждыПоХарактеристикам.Получить();
	
	Возврат УчетПоХарактеристикам;
	
КонецФункции

Функция НаименованиеПодсистемы() Экспорт
	Возврат "УчетСпецодеждыИИнвентаря2";
КонецФункции

Функция ПроверкаНаБСО() Экспорт
	
	Если Метаданные.Константы.Найти("бсо_ВестиОбъемноеПланированиеРабот") = Неопределено Тогда 
		ЭтоБСО = Ложь;
	Иначе
		ЭтоБСО = Истина;
	КонецЕсли;
	Возврат ЭтоБСО;
КонецФункции

#КонецОбласти

