
// Заполняет список пунктов подменю выбора значениями переданной коллекции объектов метаданных,
// соответствующей перечислению видов операций для данного документа, с фильтром по переданному списку.
// Всем кнопкам назначается одно переданное действие.
// Обычно используется для заполнения пунктов подменю "Подменю" командной панели
// формы документа значениями перечисления "Вид операции" для данного вида документа
//
// Параметры:
//  ЭлементМеню                   - кнопка командной панели формы, соответствующая подменю, которое надо заполнить, 
//  ОбъектЗаполнения              - коллекция для заполнения пунктов подменю, 
//  ОбъектОбработкиВыбора         - действие, которое надо выполнить при выборе любого пункта подменю.
//  СписокИсключения              - список значений перечисления, которые не должны добавляться
//
Процедура УстановитьПодменюВыбора(ЭлементМеню, ОбъектЗаполнения, 
													ОбъектОбработкиВыбора, СписокИсключения) Экспорт

	Для каждого ЭлементЗаполнения Из ОбъектЗаполнения Цикл

		Если СписокИсключения.НайтиПоЗначению(ЭлементЗаполнения.Имя) = Неопределено Тогда

		ЭлементМеню.Кнопки.Добавить(ЭлементЗаполнения.Имя, ТипКнопкиКоманднойПанели.Действие, 
		                            ЭлементЗаполнения.Синоним, ОбъектОбработкиВыбора);

		ЭлементМеню.Кнопки[ЭлементЗаполнения.Имя].ИзменяетДанные = Истина;
		КонецЕсли;

	КонецЦикла;

КонецПроцедуры // РаботаСДиалогами.УстановитьПодменюВыбора()

Функция ПолучитьОсновнуюВерсию() Экспорт
	Возврат Справочники.КТ_ВерсииБюджета.НайтиПоРеквизиту("Основная", Истина);
КонецФункции // ПолучитьОсновнуюВерсию()

Функция ОсновнойРеквизитФормы(Форма)
	Попытка
		Возврат Форма.ДокументСписок;
	Исключение
		Попытка
			Возврат Форма.СправочникСписок;
		Исключение
			Возврат Форма.РегистрСведенийСписок;
		КонецПопытки;
	КонецПопытки;
КонецФункции // ОсновнойРеквизитФормы()

Процедура ОбновлениеОтображенияОбновитьВерсии(Форма, Открытие=Ложь) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоСправочник = Метаданные.Справочники.Содержит(Мд);
	ЭтоРегистрСв = Метаданные.РегистрыСведений.Содержит(Мд);
	МдРеквизиты = ?(ЭтоРегистрСв, Мд.Измерения, Мд.Реквизиты);
	Если МдРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСв И Мд.РежимЗаписи=Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	ЭлСписокФормы = ?(ЭтоСправочник, Форма.ЭлементыФормы.СправочникСписок, ?(ЭтоРегистрСв, Форма.ЭлементыФормы.РегистрСведенийСписок, Форма.ЭлементыФормы.ДокументСписок));
	Если ЭлСписокФормы.Колонки.Найти("ВерсияБюджета")=Неопределено Тогда
		НовКол = ЭлСписокФормы.Колонки.Вставить(1, "Версия бюджета");
		НовКол.Имя = "ВерсияБюджета";
		НовКол.Данные = "ВерсияБюджета";
		НовКол.Ширина = 12;
	КонецЕсли;
	Если Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если ЭлСписокФормы.Колонки.Найти("ДоступЗакрыт")=Неопределено Тогда
			НовКол = ЭлСписокФормы.Колонки.Вставить(1, "Доступ");
			НовКол.Имя = "ДоступЗакрыт";
			НовКол.ДанныеФлажка = "ДоступЗакрыт";
			НовКол.Доступность = Ложь;
			НовКол.Ширина = 7;
			НовКол.ИзменениеРазмера = ИзменениеРазмераКолонки.НеИзменять;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ ВерсияБюджета, ВерсияБюджета.Наименование Н ИЗ "+Мд.ПолноеИмя()+" УПОРЯДОЧИТЬ ПО Н, ВерсияБюджета");
		Мас = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ВерсияБюджета");
	Исключение
		Возврат;
	КонецПопытки;
	
	Если Форма.ЭлементыФормы.ДействияФормы.Кнопки.Найти("МенюВыборВерсии")=Неопределено Тогда
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("РазделительВерсии", ТипКнопкиКоманднойПанели.Разделитель);
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("МенюВыборВерсии", ТипКнопкиКоманднойПанели.Подменю, "Выбор версии бюджета");
		
		МожноКопировать = Истина;
		Если ЭтоРегистрСв Тогда
			//Для каждого Рекв Из Мд.Измерения Цикл
			//	Если Не МожноКопировать Тогда
			//		Прервать;
			//	КонецЕсли;
			//	Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			//		МдРекв = Метаданные.НайтиПоТипу(пмТип);
			//		Если МдРекв=Неопределено Тогда
			//			Продолжить;
			//		ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
			//			Продолжить;
			//		ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
			//			Продолжить;
			//		КонецЕсли;
			//		
			//		МожноКопировать = Ложь;
			//		Прервать;
			//	КонецЦикла;
			//КонецЦикла;
			//Для каждого Рекв Из Мд.Ресурсы Цикл
			//	Если Не МожноКопировать Тогда
			//		Прервать;
			//	КонецЕсли;
			//	Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			//		МдРекв = Метаданные.НайтиПоТипу(пмТип);
			//		Если МдРекв=Неопределено Тогда
			//			Продолжить;
			//		ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
			//			Продолжить;
			//		ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
			//			Продолжить;
			//		КонецЕсли;
			//		
			//		МожноКопировать = Ложь;
			//		Прервать;
			//	КонецЦикла;
			//КонецЦикла;
		КонецЕсли;
		Для каждого Рекв Из Мд.Реквизиты Цикл
			Если Не МожноКопировать Тогда
				Прервать;
			КонецЕсли;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
		КонецЦикла;
		Если Не ЭтоРегистрСв Тогда
			Для каждого Тч Из Мд.ТабличныеЧасти Цикл
				Если Не МожноКопировать Тогда
					Прервать;
				КонецЕсли;
				Для каждого Рекв Из Тч.Реквизиты Цикл
					Если Не МожноКопировать Тогда
						Прервать;
					КонецЕсли;
					Для каждого пмТип Из Рекв.Тип.Типы() Цикл
						МдРекв = Метаданные.НайтиПоТипу(пмТип);
						Если МдРекв=Неопределено Тогда
							Продолжить;
						ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
							Продолжить;
						ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
							Продолжить;
						КонецЕсли;
						
						МожноКопировать = Ложь;
						Прервать;
					КонецЦикла;
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
		
		Если МожноКопировать Тогда
			Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ПолноеКопирование", ТипКнопкиКоманднойПанели.Действие, "Скопировать версию", Форма.ДействиеКнопкиПолноеКопирование);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			Кн.Картинка = БиблиотекаКартинок.СкопироватьОбъект;
			Кн.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
		КонецЕсли;
	КонецЕсли;
	
	Пока Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Количество()>0 Цикл
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Удалить(0);
	КонецЦикла;
	
	Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Добавить("Версия0", ТипКнопкиКоманднойПанели.Действие, "Без фильтра", Форма.ДействиеКнопкиВерсии);
	КнОсн = Кн;
	Для каждого пмВерсия Из Мас Цикл
		Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Добавить("Версия"+СокрЛП(пмВерсия.Код), ТипКнопкиКоманднойПанели.Действие, ?(пмВерсия.Пустая(), "(пусто)", пмВерсия), Форма.ДействиеКнопкиВерсии);
		Кн.Подсказка = "";
		Кн.Пояснение = "";
		Если пмВерсия.Основная Тогда
			КнОсн = Кн;
		КонецЕсли;
	КонецЦикла;
	
	Если Не СписокФормы.Отбор.ВерсияБюджета.Использование И Открытие Тогда
		ДействияФормыВыборВерсии(Форма, КнОсн);
	Иначе
		ТекВерсия = СписокФормы.Отбор.ВерсияБюджета.Значение;
		Если СписокФормы.Отбор.ВерсияБюджета.Использование И Не (Мас.Найти(ТекВерсия)=Неопределено) Тогда
			ДействияФормыВыборВерсии(Форма, Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки["Версия"+СокрЛП(ТекВерсия.Код)]);
		ИначеЕсли СписокФормы.Отбор.ВерсияБюджета.Использование Тогда
			ДействияФормыВыборВерсии(Форма, Кн);
		Иначе
			ДействияФормыВыборВерсии(Форма, Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки["Версия0"]);
		КонецЕсли;
	КонецЕсли;
	
	КнИзмДост = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Найти("ИзненитьДоступ");
	Если Не КнИзмДост=Неопределено Тогда
		Если КнИзмДост.ТипКнопки=ТипКнопкиКоманднойПанели.Подменю Тогда
			Пока КнИзмДост.Кнопки.Количество()>0 Цикл
				КнИзмДост.Кнопки.Удалить(0);
			КонецЦикла;
		КонецЕсли;
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Удалить(КнИзмДост);
	КонецЕсли;
	Если РольДоступна("АдминистраторБюджетирования") И Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если СписокФормы.Отбор.ВерсияБюджета.Использование Тогда
			КнИзмДост = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ИзненитьДоступ", ТипКнопкиКоманднойПанели.Подменю, "Закрыть / Открыть доступ");
			КнИзмДост.Подсказка = "";
			КнИзмДост.Пояснение = "";
			КнИзмДост.Картинка = БиблиотекаКартинок.ТабличныйДокументТолькоПросмотр;
			КнИзмДост.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступОдну", ТипКнопкиКоманднойПанели.Действие, "Изменить доступ у текущей позиции", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступВсеОткрыть", ТипКнопкиКоманднойПанели.Действие, "Открыть доступ для всех позиций", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступВсеЗакрыть", ТипКнопкиКоманднойПанели.Действие, "Закрыть доступ для всех позиций", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
		Иначе
			Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ИзненитьДоступ", ТипКнопкиКоманднойПанели.Действие, "Закрыть / Открыть доступ", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			Кн.Картинка = БиблиотекаКартинок.ТабличныйДокументТолькоПросмотр;
			Кн.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ДействияФормыВыборВерсии(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	
	Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Текст = "Фильтр по версии: "+Кнопка.Текст;
	Если Кнопка.Имя="Версия0" Тогда
		СписокФормы.Отбор.ВерсияБюджета.Использование = Ложь;
	Иначе
		СписокФормы.Отбор.ВерсияБюджета.Использование = Истина;
		СписокФормы.Отбор.ВерсияБюджета.Значение = Справочники.КТ_ВерсииБюджета.НайтиПоКоду(Сред(Кнопка.Имя, 7));
	КонецЕсли;
КонецПроцедуры

Процедура ДействияФормыПолноеКопирование(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоДок = Метаданные.Документы.Содержит(Мд);
	ЭтоРегистрСв = Метаданные.РегистрыСведений.Содержит(Мд);
	МдРеквизиты = ?(ЭтоРегистрСв, Мд.Измерения, Мд.Реквизиты);
	Если МдРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСв И Мд.РежимЗаписи=Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЕСТЬNULL(Версии.Ссылка, Спр.ВерсияБюджета) КАК Версия,
	|	ВЫБОР КОГДА Спр.ВерсияБюджета ЕСТЬ NULL ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК Пусто
	|ИЗ Справочник.КТ_ВерсииБюджета КАК Версии ПОЛНОЕ СОЕДИНЕНИЕ "+Мд.ПолноеИмя()+" КАК Спр ПО (Спр.ВерсияБюджета = Версии.Ссылка)
	|ГДЕ "+?(ЭтоРегистрСв, "", "(НЕ ЕСТЬNULL(Спр.ПометкаУдаления, ЛОЖЬ)) И ")+"(НЕ ЕСТЬNULL(Версии.ЭтоГруппа, ЛОЖЬ)) И (НЕ ЕСТЬNULL(Версии.ПометкаУдаления, ЛОЖЬ))
	|УПОРЯДОЧИТЬ ПО Пусто, Версия";
	Выб = Запрос.Выполнить().Выбрать();
	
	ФормаВыбора = ПолучитьОбщуюФорму("КТ_ФормаВыбораНовойВерсииbug");
	ФормаВыбора.НачЗнч = ?(СписокФормы.Отбор.ВерсияБюджета.Использование, СписокФормы.Отбор.ВерсияБюджета.Значение, Неопределено);
	ФормаВыбора.Список1 = Новый Массив;
	ФормаВыбора.Список2 = Новый Массив;
	
	Пока Выб.Следующий() Цикл
		Если Выб.Пусто Тогда
			ФормаВыбора.Список2.Добавить(Выб.Версия);
		Иначе
			ФормаВыбора.Список1.Добавить(Выб.Версия);
		КонецЕсли;
	КонецЦикла;
	
	Рез = ФормаВыбора.ОткрытьМодально();
	Если Рез=Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтрРекв = "";
	МасТч = Новый Массив;
	Если ЭтоРегистрСв Тогда
		Для каждого Рекв Из Мд.Измерения Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
		Для каждого Рекв Из Мд.Ресурсы Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Для каждого Рекв Из Мд.Реквизиты Цикл
		МожноКопировать = Истина;
		Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			МдРекв = Метаданные.НайтиПоТипу(пмТип);
			Если МдРекв=Неопределено Тогда
				Продолжить;
			ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
				Продолжить;
			ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			МожноКопировать = Ложь;
			Прервать;
		КонецЦикла;
		
		Если МожноКопировать Тогда
			СтрРекв = СтрРекв+", "+Рекв.Имя;
		КонецЕсли;
	КонецЦикла;
	Если ЭтоРегистрСв Тогда
		СтрРекв = "Период"+СтрРекв;
	ИначеЕсли ЭтоДок Тогда
		СтрРекв = Сред(СтрРекв, 3);//"Дата"+СтрРекв;
	Иначе
		СтрРекв = "Наименование"+СтрРекв;
	КонецЕсли;
	
	Если Не ЭтоРегистрСв Тогда
		Для каждого Тч Из Мд.ТабличныеЧасти Цикл
			МасТч.Добавить(Тч.Имя);
		КонецЦикла;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ВерсияБюджета", Рез.Версия1);
	Запрос.Текст = "ВЫБРАТЬ * ИЗ "+Мд.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета"+?(ЭтоРегистрСв, "", " И (НЕ ПометкаУдаления)");
	Выб = Запрос.Выполнить().Выбрать();
	нн = 0;
	Пока Выб.Следующий() Цикл
		нн = нн+1;
		Состояние(""+нн+"/"+Выб.Количество()+?(ЭтоРегистрСв, "", " "+Выб.Ссылка));
		
		Попытка
			Если ЭтоРегистрСв Тогда
				НовОбъект = РегистрыСведений[Мд.Имя].СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				НовОбъект.ВерсияБюджета = Рез.Версия2;
				НовОбъект.Период = Дата(Число(Рез.Версия2.Год), Месяц(НовОбъект.Период), День(НовОбъект.Период));
				НовОбъект.Записать(Ложь);
			Иначе
				Если ЭтоДок Тогда
					НовОбъект = Документы[Мд.Имя].СоздатьДокумент();
					НовОбъект.Дата = ТекущаяДата();
				Иначе
					НовОбъект = Справочники[Мд.Имя].СоздатьЭлемент();
				КонецЕсли;
				
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				Если Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
					НовОбъект.ДоступЗакрыт = Ложь;
				КонецЕсли;
				НовОбъект.ВерсияБюджета = Рез.Версия2;
				НовОбъект.Год = Рез.Версия2.Год;
				
				Для каждого Тч Из МасТч Цикл
					ВыбТч = Выб[Тч].Выбрать();
					Пока ВыбТч.Следующий() Цикл
						ЗаполнитьЗначенияСвойств(НовОбъект[Тч].Добавить(), ВыбТч, , "НомерСтроки");
					КонецЦикла;
				КонецЦикла;
				
				Попытка
					НовОбъект.ПерезаполнитьПриСоздании();
				Исключение
				КонецПопытки;
				
				Если ЭтоДок Тогда
					НовОбъект.УстановитьНовыйНомер();
					НовОбъект.Записать();
					Если Выб.Проведен Тогда
						НовОбъект.Записать(РежимЗаписиДокумента.Проведение);
					КонецЕсли;
				Иначе
					НовОбъект.УстановитьНовыйКод();
					НовОбъект.Записать();
				КонецЕсли;
			КонецЕсли;
		Исключение
			Сообщить("Ошибка копирования:"+?(ЭтоРегистрСв, "", " "+Выб.Ссылка+"! ")+ОписаниеОшибки(), СтатусСообщения.Важное);
		КонецПопытки;
	КонецЦикла;
	
	Предупреждение("Копирование завершено.");
КонецПроцедуры

Процедура ДействияФормыИзменитьДоступ(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоСправочник = Метаданные.Справочники.Содержит(Мд);
	Если Мд.Реквизиты.Найти("ВерсияБюджета")=Неопределено Или Мд.Реквизиты.Найти("ДоступЗакрыт")=Неопределено Или Не РольДоступна("АдминистраторБюджетирования") Тогда
		Возврат;
	КонецЕсли;
	
	Если СписокФормы.Отбор.ВерсияБюджета.Использование И Лев(Кнопка.Имя, 17)="ИзненитьДоступВсе" Тогда
		Если Вопрос(Сред(Кнопка.Имя, 18)+" доступ для всех позиций?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
		Запрос = Новый Запрос("ВЫБРАТЬ Ссылка, ДоступЗакрыт ИЗ "+Мд.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета И НЕ ДоступЗакрыт = &ДоступЗакрыт");
		Запрос.УстановитьПараметр("ВерсияБюджета", СписокФормы.Отбор.ВерсияБюджета.Значение);
		Запрос.УстановитьПараметр("ДоступЗакрыт", Не Кнопка.Имя="ИзненитьДоступВсеОткрыть");
		Выб = Запрос.Выполнить().Выбрать();
		Попытка
			Пока Выб.Следующий() Цикл
				Об = Выб.Ссылка.ПолучитьОбъект();
				Об.ДоступЗакрыт = Не Кнопка.Имя="ИзненитьДоступВсеОткрыть";
				Об.Записать();
			КонецЦикла;
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	Иначе
		ЭлСписокФормы = ?(ЭтоСправочник, Форма.ЭлементыФормы.СправочникСписок, Форма.ЭлементыФормы.ДокументСписок);
		Тд = ЭлСписокФормы.ТекущиеДанные;
		Если Тд = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Об = Тд.Ссылка.ПолучитьОбъект();
		Об.ДоступЗакрыт = Не Об.ДоступЗакрыт;
		Попытка
			Об.Записать();
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры

Процедура ПередОткрытиемПодготовитьВерсию(Форма) Экспорт
	ОбновлениеОтображенияОбновитьВерсии(Форма, Истина);
КонецПроцедуры

Процедура ПриОткрытииФормыОбъекта(Форма) Экспорт
	Попытка
		ОбъектФормы = Форма.ДокументОбъект;
	Исключение
		ОбъектФормы = Форма.СправочникОбъект;
	КонецПопытки;
	Мд = ОбъектФормы.Метаданные();
	Если Мд.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Не Мд.Реквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если ОбъектФормы.ДоступЗакрыт Тогда
			Если ОбъектФормы.ЭтоНовый() Тогда
				ОбъектФормы.ДоступЗакрыт = Ложь;
			Иначе
				Форма.ТолькоПросмотр = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
