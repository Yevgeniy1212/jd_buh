

Функция ПолучитьОсновнуюВерсию() Экспорт
	Возврат Справочники.КТ_ВерсииБюджета.НайтиПоРеквизиту("Основная", Истина);
КонецФункции // ПолучитьОсновнуюВерсию()

Функция ПолучитьГодСтрокойПоВерсииБюджета(ВерсияБюджета) Экспорт
	
	Возврат СтрЗаменить(ВерсияБюджета.Год, Символы.НПП, "");
	
КонецФункции

Функция ВернутьКонстанту() Экспорт
  Возврат Константы.КТ_ДатаПереходаНаРаспределениеПоЦФО.Получить(); 
КонецФункции

#Если ТолстыйКлиент Тогда
	
Функция ОсновнойРеквизитФормы(Форма)
	Попытка
		Возврат Форма.ДокументСписок;
	Исключение
		Попытка
			Возврат Форма.СправочникСписок;
		Исключение
			Возврат Форма.РегистрСведенийСписок;
		КонецПопытки;
	КонецПопытки;
КонецФункции // ОсновнойРеквизитФормы()

Процедура ОбновлениеОтображенияОбновитьВерсии(Форма, Открытие=Ложь) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоСправочник = Метаданные.Справочники.Содержит(Мд);
	ЭтоРегистрСв = Метаданные.РегистрыСведений.Содержит(Мд);
	МдРеквизиты = ?(ЭтоРегистрСв, Мд.Измерения, Мд.Реквизиты);
	Если МдРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСв И Мд.РежимЗаписи=Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	ЭлСписокФормы = ?(ЭтоСправочник, Форма.ЭлементыФормы.СправочникСписок, ?(ЭтоРегистрСв, Форма.ЭлементыФормы.РегистрСведенийСписок, Форма.ЭлементыФормы.ДокументСписок));
	Если ЭлСписокФормы.Колонки.Найти("ВерсияБюджета")=Неопределено Тогда
		НовКол = ЭлСписокФормы.Колонки.Вставить(1, "Версия бюджета");
		НовКол.Имя = "ВерсияБюджета";
		НовКол.Данные = "ВерсияБюджета";
		НовКол.Ширина = 12;
	КонецЕсли;
	Если Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если ЭлСписокФормы.Колонки.Найти("ДоступЗакрыт")=Неопределено Тогда
			НовКол = ЭлСписокФормы.Колонки.Вставить(1, "Доступ");
			НовКол.Имя = "ДоступЗакрыт";
			НовКол.ДанныеФлажка = "ДоступЗакрыт";
			НовКол.Доступность = Ложь;
			НовКол.Ширина = 7;
			НовКол.ИзменениеРазмера = ИзменениеРазмераКолонки.НеИзменять;
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ ВерсияБюджета, ВерсияБюджета.Наименование Н ИЗ "+Мд.ПолноеИмя()+" УПОРЯДОЧИТЬ ПО Н, ВерсияБюджета");
		Мас = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ВерсияБюджета");
	Исключение
		Возврат;
	КонецПопытки;
	
	Если Форма.ЭлементыФормы.ДействияФормы.Кнопки.Найти("МенюВыборВерсии")=Неопределено Тогда
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("РазделительВерсии", ТипКнопкиКоманднойПанели.Разделитель);
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("МенюВыборВерсии", ТипКнопкиКоманднойПанели.Подменю, "Выбор версии бюджета");
		
		МожноКопировать = Истина;
		Если ЭтоРегистрСв Тогда
			//Для каждого Рекв Из Мд.Измерения Цикл
			//	Если Не МожноКопировать Тогда
			//		Прервать;
			//	КонецЕсли;
			//	Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			//		МдРекв = Метаданные.НайтиПоТипу(пмТип);
			//		Если МдРекв=Неопределено Тогда
			//			Продолжить;
			//		ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
			//			Продолжить;
			//		ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
			//			Продолжить;
			//		КонецЕсли;
			//		
			//		МожноКопировать = Ложь;
			//		Прервать;
			//	КонецЦикла;
			//КонецЦикла;
			//Для каждого Рекв Из Мд.Ресурсы Цикл
			//	Если Не МожноКопировать Тогда
			//		Прервать;
			//	КонецЕсли;
			//	Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			//		МдРекв = Метаданные.НайтиПоТипу(пмТип);
			//		Если МдРекв=Неопределено Тогда
			//			Продолжить;
			//		ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
			//			Продолжить;
			//		ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
			//			Продолжить;
			//		КонецЕсли;
			//		
			//		МожноКопировать = Ложь;
			//		Прервать;
			//	КонецЦикла;
			//КонецЦикла;
		КонецЕсли;
		Для каждого Рекв Из Мд.Реквизиты Цикл
			Если Не МожноКопировать Тогда
				Прервать;
			КонецЕсли;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
		КонецЦикла;
		Если Не ЭтоРегистрСв Тогда
			Для каждого Тч Из Мд.ТабличныеЧасти Цикл
				Если Не МожноКопировать Тогда
					Прервать;
				КонецЕсли;
				Для каждого Рекв Из Тч.Реквизиты Цикл
					Если Не МожноКопировать Тогда
						Прервать;
					КонецЕсли;
					Для каждого пмТип Из Рекв.Тип.Типы() Цикл
						МдРекв = Метаданные.НайтиПоТипу(пмТип);
						Если МдРекв=Неопределено Тогда
							Продолжить;
						ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
							Продолжить;
						ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
							Продолжить;
						КонецЕсли;
						
						МожноКопировать = Ложь;
						Прервать;
					КонецЦикла;
				КонецЦикла;
			КонецЦикла;
		КонецЕсли;
		
		Если МожноКопировать Тогда
			Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ПолноеКопирование", ТипКнопкиКоманднойПанели.Действие, "Скопировать версию", Форма.ДействиеКнопкиПолноеКопирование);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			Кн.Картинка = БиблиотекаКартинок.СкопироватьОбъект;
			Кн.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
		КонецЕсли;
	КонецЕсли;
	
	Пока Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Количество()>0 Цикл
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Удалить(0);
	КонецЦикла;
	
	Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Добавить("Версия0", ТипКнопкиКоманднойПанели.Действие, "Без фильтра", Форма.ДействиеКнопкиВерсии);
	КнОсн = Кн;
	Для каждого пмВерсия Из Мас Цикл
		Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки.Добавить("Версия"+СокрЛП(пмВерсия.Код), ТипКнопкиКоманднойПанели.Действие, ?(пмВерсия.Пустая(), "(пусто)", пмВерсия), Форма.ДействиеКнопкиВерсии);
		Кн.Подсказка = "";
		Кн.Пояснение = "";
		Если пмВерсия.Основная Тогда
			КнОсн = Кн;
		КонецЕсли;
	КонецЦикла;
	
	Если Не СписокФормы.Отбор.ВерсияБюджета.Использование И Открытие Тогда
		ДействияФормыВыборВерсии(Форма, КнОсн);
	Иначе
		ТекВерсия = СписокФормы.Отбор.ВерсияБюджета.Значение;
		Если СписокФормы.Отбор.ВерсияБюджета.Использование И Не (Мас.Найти(ТекВерсия)=Неопределено) Тогда
			ДействияФормыВыборВерсии(Форма, Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки["Версия"+СокрЛП(ТекВерсия.Код)]);
		ИначеЕсли СписокФормы.Отбор.ВерсияБюджета.Использование Тогда
			ДействияФормыВыборВерсии(Форма, Кн);
		Иначе
			ДействияФормыВыборВерсии(Форма, Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Кнопки["Версия0"]);
		КонецЕсли;
	КонецЕсли;
	
	КнИзмДост = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Найти("ИзненитьДоступ");
	Если Не КнИзмДост=Неопределено Тогда
		Если КнИзмДост.ТипКнопки=ТипКнопкиКоманднойПанели.Подменю Тогда
			Пока КнИзмДост.Кнопки.Количество()>0 Цикл
				КнИзмДост.Кнопки.Удалить(0);
			КонецЦикла;
		КонецЕсли;
		Форма.ЭлементыФормы.ДействияФормы.Кнопки.Удалить(КнИзмДост);
	КонецЕсли;
	Если РольДоступна("АдминистраторБюджетирования") И Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если СписокФормы.Отбор.ВерсияБюджета.Использование Тогда
			КнИзмДост = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ИзненитьДоступ", ТипКнопкиКоманднойПанели.Подменю, "Закрыть / Открыть доступ");
			КнИзмДост.Подсказка = "";
			КнИзмДост.Пояснение = "";
			КнИзмДост.Картинка = БиблиотекаКартинок.ТабличныйДокументТолькоПросмотр;
			КнИзмДост.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступОдну", ТипКнопкиКоманднойПанели.Действие, "Изменить доступ у текущей позиции", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступВсеОткрыть", ТипКнопкиКоманднойПанели.Действие, "Открыть доступ для всех позиций", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			
			Кн = КнИзмДост.Кнопки.Добавить("ИзненитьДоступВсеЗакрыть", ТипКнопкиКоманднойПанели.Действие, "Закрыть доступ для всех позиций", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
		Иначе
			Кн = Форма.ЭлементыФормы.ДействияФормы.Кнопки.Добавить("ИзненитьДоступ", ТипКнопкиКоманднойПанели.Действие, "Закрыть / Открыть доступ", Форма.ДействиеКнопкиИзменитьДоступ);
			Кн.Подсказка = "";
			Кн.Пояснение = "";
			Кн.Картинка = БиблиотекаКартинок.ТабличныйДокументТолькоПросмотр;
			Кн.Отображение = ОтображениеКнопкиКоманднойПанели.НадписьКартинка;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

Процедура ДействияФормыВыборВерсии(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	
	Форма.ЭлементыФормы.ДействияФормы.Кнопки.МенюВыборВерсии.Текст = "Фильтр по версии: "+Кнопка.Текст;
	Если Кнопка.Имя="Версия0" Тогда
		СписокФормы.Отбор.ВерсияБюджета.Использование = Ложь;
	Иначе
		СписокФормы.Отбор.ВерсияБюджета.Использование = Истина;
		СписокФормы.Отбор.ВерсияБюджета.Значение = Справочники.КТ_ВерсииБюджета.НайтиПоКоду(Сред(Кнопка.Имя, 7));
	КонецЕсли;
КонецПроцедуры

Процедура ДействияФормыПолноеКопирование(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоДок = Метаданные.Документы.Содержит(Мд);
	ЭтоРегистрСв = Метаданные.РегистрыСведений.Содержит(Мд);
	МдРеквизиты = ?(ЭтоРегистрСв, Мд.Измерения, Мд.Реквизиты);
	Если МдРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСв И Мд.РежимЗаписи=Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЕСТЬNULL(Версии.Ссылка, Спр.ВерсияБюджета) КАК Версия,
	|	ВЫБОР КОГДА Спр.ВерсияБюджета ЕСТЬ NULL ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК Пусто
	|ИЗ Справочник.КТ_ВерсииБюджета КАК Версии ПОЛНОЕ СОЕДИНЕНИЕ "+Мд.ПолноеИмя()+" КАК Спр ПО (Спр.ВерсияБюджета = Версии.Ссылка)
	|ГДЕ "+?(ЭтоРегистрСв, "", "(НЕ ЕСТЬNULL(Спр.ПометкаУдаления, ЛОЖЬ)) И ")+"(НЕ ЕСТЬNULL(Версии.ЭтоГруппа, ЛОЖЬ)) И (НЕ ЕСТЬNULL(Версии.ПометкаУдаления, ЛОЖЬ))
	|УПОРЯДОЧИТЬ ПО Пусто, Версия";
	Выб = Запрос.Выполнить().Выбрать();
	
	ФормаВыбора = ПолучитьОбщуюФорму("КТ_ФормаВыбораНовойВерсииbug");
	ФормаВыбора.НачЗнч = ?(СписокФормы.Отбор.ВерсияБюджета.Использование, СписокФормы.Отбор.ВерсияБюджета.Значение, Неопределено);
	ФормаВыбора.Список1 = Новый Массив;
	ФормаВыбора.Список2 = Новый Массив;
	
	Пока Выб.Следующий() Цикл
		Если Выб.Пусто Тогда
			ФормаВыбора.Список2.Добавить(Выб.Версия);
		Иначе
			ФормаВыбора.Список1.Добавить(Выб.Версия);
		КонецЕсли;
	КонецЦикла;
	
	Рез = ФормаВыбора.ОткрытьМодально();
	Если Рез=Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СтрРекв = "";
	МасТч = Новый Массив;
	Если ЭтоРегистрСв Тогда
		Для каждого Рекв Из Мд.Измерения Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
		Для каждого Рекв Из Мд.Ресурсы Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Для каждого Рекв Из Мд.Реквизиты Цикл
		МожноКопировать = Истина;
		Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			МдРекв = Метаданные.НайтиПоТипу(пмТип);
			Если МдРекв=Неопределено Тогда
				Продолжить;
			ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
				Продолжить;
			ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			МожноКопировать = Ложь;
			Прервать;
		КонецЦикла;
		
		Если МожноКопировать Тогда
			СтрРекв = СтрРекв+", "+Рекв.Имя;
		КонецЕсли;
	КонецЦикла;
	Если ЭтоРегистрСв Тогда
		СтрРекв = "Период"+СтрРекв;
	ИначеЕсли ЭтоДок Тогда
		СтрРекв = Сред(СтрРекв, 3);//"Дата"+СтрРекв;
	Иначе
		СтрРекв = "Наименование"+СтрРекв;
	КонецЕсли;
	
	Если Не ЭтоРегистрСв Тогда
		Для каждого Тч Из Мд.ТабличныеЧасти Цикл
			МасТч.Добавить(Тч.Имя);
		КонецЦикла;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ВерсияБюджета", Рез.Версия1);
	Запрос.Текст = "ВЫБРАТЬ * ИЗ "+Мд.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета"+?(ЭтоРегистрСв, "", " И (НЕ ПометкаУдаления)");
	Выб = Запрос.Выполнить().Выбрать();
	нн = 0;
	Пока Выб.Следующий() Цикл
		нн = нн+1;
		Состояние(""+нн+"/"+Выб.Количество()+?(ЭтоРегистрСв, "", " "+Выб.Ссылка));
		
		Попытка
			Если ЭтоРегистрСв Тогда
				НовОбъект = РегистрыСведений[Мд.Имя].СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				НовОбъект.ВерсияБюджета = Рез.Версия2;
				НовОбъект.Период = Дата(Число(Рез.Версия2.Год), Месяц(НовОбъект.Период), День(НовОбъект.Период));
				НовОбъект.Записать(Ложь);
			Иначе
				Если ЭтоДок Тогда
					НовОбъект = Документы[Мд.Имя].СоздатьДокумент();
					НовОбъект.Дата = ТекущаяДата();
				Иначе
					НовОбъект = Справочники[Мд.Имя].СоздатьЭлемент();
				КонецЕсли;
				
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				Если Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
					НовОбъект.ДоступЗакрыт = Ложь;
				КонецЕсли;
				НовОбъект.ВерсияБюджета = Рез.Версия2;
				НовОбъект.Год = Рез.Версия2.Год;
				
				Для каждого Тч Из МасТч Цикл
					ВыбТч = Выб[Тч].Выбрать();
					Пока ВыбТч.Следующий() Цикл
						ЗаполнитьЗначенияСвойств(НовОбъект[Тч].Добавить(), ВыбТч, , "НомерСтроки");
					КонецЦикла;
				КонецЦикла;
				
				Попытка
					НовОбъект.ПерезаполнитьПриСоздании();
				Исключение
				КонецПопытки;
				
				Если ЭтоДок Тогда
					НовОбъект.УстановитьНовыйНомер();
					НовОбъект.Записать();
					Если Выб.Проведен Тогда
						НовОбъект.Записать(РежимЗаписиДокумента.Проведение);
					КонецЕсли;
				Иначе
					НовОбъект.УстановитьНовыйКод();
					НовОбъект.Записать();
				КонецЕсли;
			КонецЕсли;
		Исключение
			Сообщить("Ошибка копирования:"+?(ЭтоРегистрСв, "", " "+Выб.Ссылка+"! ")+ОписаниеОшибки(), СтатусСообщения.Важное);
		КонецПопытки;
	КонецЦикла;
	
	Предупреждение("Копирование завершено.");
КонецПроцедуры

Процедура ДействияФормыИзменитьДоступ(Форма, Кнопка) Экспорт
	СписокФормы = ОсновнойРеквизитФормы(Форма);
	Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	ЭтоСправочник = Метаданные.Справочники.Содержит(Мд);
	Если Мд.Реквизиты.Найти("ВерсияБюджета")=Неопределено Или Мд.Реквизиты.Найти("ДоступЗакрыт")=Неопределено Или Не РольДоступна("АдминистраторБюджетирования") Тогда
		Возврат;
	КонецЕсли;
	
	Если СписокФормы.Отбор.ВерсияБюджета.Использование И Лев(Кнопка.Имя, 17)="ИзненитьДоступВсе" Тогда
		Если Вопрос(Сред(Кнопка.Имя, 18)+" доступ для всех позиций?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
		Запрос = Новый Запрос("ВЫБРАТЬ Ссылка, ДоступЗакрыт ИЗ "+Мд.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета И НЕ ДоступЗакрыт = &ДоступЗакрыт");
		Запрос.УстановитьПараметр("ВерсияБюджета", СписокФормы.Отбор.ВерсияБюджета.Значение);
		Запрос.УстановитьПараметр("ДоступЗакрыт", Не Кнопка.Имя="ИзненитьДоступВсеОткрыть");
		Выб = Запрос.Выполнить().Выбрать();
		Попытка
			Пока Выб.Следующий() Цикл
				Об = Выб.Ссылка.ПолучитьОбъект();
				Об.ДоступЗакрыт = Не Кнопка.Имя="ИзненитьДоступВсеОткрыть";
				Об.Записать();
			КонецЦикла;
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	Иначе
		ЭлСписокФормы = ?(ЭтоСправочник, Форма.ЭлементыФормы.СправочникСписок, Форма.ЭлементыФормы.ДокументСписок);
		Тд = ЭлСписокФормы.ТекущиеДанные;
		Если Тд = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		Об = Тд.Ссылка.ПолучитьОбъект();
		Об.ДоступЗакрыт = Не Об.ДоступЗакрыт;
		Попытка
			Об.Записать();
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры

Процедура ПередОткрытиемПодготовитьВерсию(Форма) Экспорт
	ОбновлениеОтображенияОбновитьВерсии(Форма, Истина);
КонецПроцедуры

Процедура ПриОткрытииФормыОбъекта(Форма) Экспорт
	Попытка
		ОбъектФормы = Форма.ДокументОбъект;
	Исключение
		ОбъектФормы = Форма.СправочникОбъект;
	КонецПопытки;
	Мд = ОбъектФормы.Метаданные();
	Если Мд.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Не Мд.Реквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
		Если ОбъектФормы.ДоступЗакрыт Тогда
			Если ОбъектФормы.ЭтоНовый() Тогда
				ОбъектФормы.ДоступЗакрыт = Ложь;
			Иначе
				Форма.ТолькоПросмотр = Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
	
#КонецЕсли


///////////////////////////////////////////////////////////////
//

Процедура ПриСозданииНаСервере(Форма, Объект) Экспорт
	
	МассивПодстрокИмениФормы = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Форма.ИмяФормы, ".");
	
	ИмяТипаЗначенияОбъекта = Метаданные.НайтиПоТипу(Тип(МассивПодстрокИмениФормы.Получить(0) + "Ссылка." + МассивПодстрокИмениФормы.Получить(1)));
	
	МетаданныеОбъекта = Объект.Ссылка.Метаданные();
	МетаданныеОбъектаРеквизиты = МетаданныеОбъекта.Реквизиты;

	Если МетаданныеОбъектаРеквизиты.Найти("ДоступЗакрыт") <> Неопределено Тогда
		Форма.ТолькоПросмотр = Объект.ДоступЗакрыт;
		
		Для Каждого ФормаКоманднаяПанельПодчиненныеЭлементы Из Форма.КоманднаяПанель.ПодчиненныеЭлементы Цикл
			Если ФормаКоманднаяПанельПодчиненныеЭлементы.Вид = ВидГруппыФормы.Подменю Тогда
				ФормаКоманднаяПанельПодчиненныеЭлементы.Видимость = Не Объект.ДоступЗакрыт;
			КонецЕсли;
		КонецЦикла;
		
		Для Каждого ФормаПодчиненныеЭлементы Из Форма.ПодчиненныеЭлементы Цикл
			Если ТипЗнч(ФормаПодчиненныеЭлементы) = Тип("ТаблицаФормы") Тогда
				Для Каждого ФормаПодчиненныеЭлементыКоманднаяПанельПодчиненныеЭлементы Из ФормаПодчиненныеЭлементы.КоманднаяПанель.ПодчиненныеЭлементы Цикл
					Если ФормаПодчиненныеЭлементыКоманднаяПанельПодчиненныеЭлементы.Вид = ВидГруппыФормы.Подменю Тогда
						ФормаПодчиненныеЭлементыКоманднаяПанельПодчиненныеЭлементы.Видимость = Не Объект.ДоступЗакрыт;
					ИначеЕсли ФормаПодчиненныеЭлементыКоманднаяПанельПодчиненныеЭлементы.Вид = ВидКнопкиФормы.КнопкаКоманднойПанели Тогда
						ФормаПодчиненныеЭлементыКоманднаяПанельПодчиненныеЭлементы.Видимость = Не Объект.ДоступЗакрыт;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	//Если МетаданныеОбъекта.Реквизиты.Найти("ВерсияБюджета") <> Неопределено Тогда
	//	ПолеФормыВерсияБюджета = Форма.Элементы.Найти("ВерсияБюджета");
	//	Если ПолеФормыВерсияБюджета <> Неопределено Тогда
	//		ПолеФормыВерсияБюджета.КнопкаОткрытия = Ложь;
	//		ПолеФормыВерсияБюджета.ЦветФона = ЦветаСтиля.ФонУправляющегоПоля;
	//	КонецЕсли;
	//КонецЕсли;
	
	ПолеФормыНомер = Форма.Элементы.Найти("Номер");
	Если ПолеФормыНомер <> Неопределено Тогда
		ПолеФормыНомер.ОтображениеПредупрежденияПриРедактировании = ОтображениеПредупрежденияПриРедактировании.Отображать;
		ПолеФормыНомер.ПредупреждениеПриРедактировании = "Номер заполняется при записи автоматически";
	КонецЕсли
	
КонецПроцедуры

Функция ПолучитьСписокВерсийБюджета() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	КТ_ВерсииБюджета.Ссылка КАК Значение,
	|	КТ_ВерсииБюджета.Наименование КАК Представление,
	|	КТ_ВерсииБюджета.Основная КАК Пометка
	|ИЗ
	|	Справочник.КТ_ВерсииБюджета КАК КТ_ВерсииБюджета
	|ГДЕ
	|	НЕ КТ_ВерсииБюджета.ПометкаУдаления";
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Количество() > 0 Тогда
		СписокВерсий = Новый СписокЗначений;
		Пока Выборка.Следующий() Цикл
			ЗаполнитьЗначенияСвойств(СписокВерсий.Добавить(), Выборка);
		КонецЦикла;
	КонецЕсли;
	
КонецФункции

// Процедура - Заполнить командную панель бюджетирование
//
Процедура ЗаполнитьКоманднуюПанельБюджетирование(Форма) Экспорт
	
	МассивПодстрокИмениФормы = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(Форма.ИмяФормы, ".");
	
	МетаданныеОбъекта = Метаданные.НайтиПоТипу(Тип(МассивПодстрокИмениФормы.Получить(0) + ?(МассивПодстрокИмениФормы.Получить(0) <> "ЖурналДокументов", "Ссылка.", "Менеджер.") + МассивПодстрокИмениФормы.Получить(1)));
	ЭтоСправочник = ОбщегоНазначения.ЭтоСправочник(МетаданныеОбъекта);
	ЭтоДокумент = ОбщегоНазначения.ЭтоДокумент(МетаданныеОбъекта);
	ЭтоРегистрСведений = ОбщегоНазначения.ЭтоРегистрСведений(МетаданныеОбъекта);
	Если МассивПодстрокИмениФормы.Получить(0) = "ЖурналДокументов" Тогда
		МетаданныеОбъектаРеквизиты = МетаданныеОбъекта.Графы;
	Иначе
		МетаданныеОбъектаРеквизиты = ?(ЭтоРегистрСведений, МетаданныеОбъекта.Измерения, МетаданныеОбъекта.Реквизиты);
	КонецЕсли;
	
	Если МетаданныеОбъектаРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСведений И МетаданныеОбъекта.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ ТаблицаВерсийБюджета.ВерсияБюджета КАК ВерсияБюджета ИЗ "+МетаданныеОбъекта.ПолноеИмя()+" КАК ТаблицаВерсийБюджета УПОРЯДОЧИТЬ ПО ТаблицаВерсийБюджета.ВерсияБюджета.Наименование, ВерсияБюджета");
		МассивВерсийБюджетаОбъекта = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ВерсияБюджета");
	Исключение
		Возврат;
	КонецПопытки;
	
	//Фильтр ВерсияБюджета
	////////////////////////////////////////
	ЭлементПодменюВерсияБюджета = Форма.Элементы.Добавить("ГруппаКоманднаяПанельВерсияБюджета", Тип("ГруппаФормы"), Форма.Элементы.ФормаКоманднаяПанель);
	ЭлементПодменюВерсияБюджета.Вид = ВидГруппыФормы.Подменю;
	ЭлементПодменюВерсияБюджета.Заголовок = "Все версии";
	ЭлементПодменюВерсияБюджета.Отображение = ОтображениеКнопки.КартинкаИТекст;
	ЭлементПодменюВерсияБюджета.Картинка	= БиблиотекаКартинок.ИсторияВерсий;
	
	// Подменю ВерсияБюджета
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	КТ_ВерсииБюджета.Ссылка КАК Значение,
	|	КТ_ВерсииБюджета.Наименование КАК Представление,
	|	КТ_ВерсииБюджета.Основная КАК Пометка
	|ИЗ
	|	Справочник.КТ_ВерсииБюджета КАК КТ_ВерсииБюджета
	|ГДЕ
	|	НЕ КТ_ВерсииБюджета.ПометкаУдаления
	|	И КТ_ВерсииБюджета.Ссылка В(&МассивВерсийБюджета)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	НЕОПРЕДЕЛЕНО,
	|	""Все версии"",
	|	ЛОЖЬ");
	
	Запрос.УстановитьПараметр("МассивВерсийБюджета", МассивВерсийБюджетаОбъекта);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	нИндекс = 1;
	
	Пока Выборка.Следующий() Цикл
		
		ИмяЭлемента = "КнопкаПодменюВерсияБюджета" + Формат(нИндекс, "ЧДЦ=0; ЧН=0; ЧГ=");
		
		Кнопка = Форма.Элементы.Добавить(ИмяЭлемента, Тип("КнопкаФормы"), ЭлементПодменюВерсияБюджета);
		Кнопка.Заголовок	= Выборка.Представление;
		Кнопка.Пометка		= Выборка.Пометка;
		Кнопка.Шрифт		= Новый Шрифт(,,Выборка.Пометка);
		
		Команда = Форма.Команды.Добавить(ИмяЭлемента);
		Команда.Действие	= "Подключаемый_КомандаОбработкаОтборПоВерсииБюджета";
		Команда.Заголовок	= Кнопка.Заголовок;
		Команда.Отображение = ОтображениеКнопки.Текст;
		Команда.Подсказка   = "Версия бюджета: " + Выборка.Представление;
		
		Кнопка.ИмяКоманды	= Команда.Имя;
		
		НоваяСтрока = Форма.ТаблицаСоответствияЭлементовУправленияСсылкам.Добавить();
		НоваяСтрока.Имя		= Кнопка.Имя;
		НоваяСтрока.Ссылка	= Выборка.Значение;
		
		нИндекс = нИндекс + 1;
		
		Если Выборка.Пометка Тогда
			КТ_ОбщегоНазначенияКлиентСервер.УстановитьНедоступныйОтборСписка(Форма.Список, "ВерсияБюджета", Выборка.Значение);
			ЭлементПодменюВерсияБюджета.Заголовок = Строка(Выборка.Значение);
		КонецЕсли;
		
	КонецЦикла;
	
	
	Если Не РольДоступна("АдминистраторБюджетирования") Тогда
		Возврат;
		//Если права нет, то следущие процедуры выполняться не будут.
	КонецЕсли;
	
	//Команда СкопироватьВерсию
	////////////////////////////////////////		
	ИмяЭлемента = "КнопкаКоманднаяПанельПолноеКопирование";
	
	Кнопка = Форма.Элементы.Добавить(ИмяЭлемента, Тип("КнопкаФормы"), Форма.Элементы.ФормаКоманднаяПанель);
	Кнопка.Заголовок	= "Скопировать версию";
	
	Команда = Форма.Команды.Добавить(ИмяЭлемента);
	Команда.Действие	= "Подключаемый_КомандаОбработкаПолноеКопированиеПоВерсииБюджета";
	Команда.Заголовок	= Кнопка.Заголовок;
	Команда.Отображение = ОтображениеКнопки.КартинкаИТекст;
	Команда.Картинка	= БиблиотекаКартинок.СкопироватьОбъект;
	Команда.Подсказка   = "Скопировать версию";
	
	Кнопка.ИмяКоманды	= Команда.Имя;
	
	
	//Команда ИзменитьДоступ
	////////////////////////////////////////
	ЭлементПодменюВерсияБюджета = Форма.Элементы.Добавить("ГруппаКоманднаяПанельИзменитьДоступ", Тип("ГруппаФормы"), Форма.Элементы.ФормаКоманднаяПанель);
	ЭлементПодменюВерсияБюджета.Вид = ВидГруппыФормы.Подменю;
	ЭлементПодменюВерсияБюджета.Заголовок = "Изменить доступ";
	ЭлементПодменюВерсияБюджета.Отображение	= ОтображениеКнопки.КартинкаИТекст;
	ЭлементПодменюВерсияБюджета.Картинка	= БиблиотекаКартинок.ТабличныйДокументТолькоПросмотр;
	
	СписокКнопок = Новый Соответствие;
	СписокКнопок.Вставить(1, "Для текущий позиции");
	СписокКнопок.Вставить(2, "Открыть для всех позиций");
	СписокКнопок.Вставить(3, "Закрыть для всех позиций");
	
	ИмяЭлемента = "КнопкаКоманднаяПанельИзменитьДоступ";
	
	Для ИндексКнопки = 1 По СписокКнопок.Количество() Цикл 
		Кнопка = Форма.Элементы.Добавить(ИмяЭлемента+Строка(ИндексКнопки), Тип("КнопкаФормы"), ЭлементПодменюВерсияБюджета);
		Кнопка.Заголовок	= СписокКнопок.Получить(ИндексКнопки);
		
		Команда = Форма.Команды.Добавить(ИмяЭлемента+Строка(ИндексКнопки));
		Команда.Действие	= "Подключаемый_КомандаОбработкаИзменитьДоступПоВерсииБюджета";
		Команда.Заголовок	= Кнопка.Заголовок;
		Команда.Отображение = ОтображениеКнопки.Текст;
		Команда.Подсказка   = СписокКнопок.Получить(ИндексКнопки);
		
		Кнопка.ИмяКоманды	= Команда.Имя;
	КонецЦикла;
	
КонецПроцедуры


// Процедура - Копирование данных по версии бюджета
//
// Параметры:
//  Форма				 - 	 - 
//  МетаданныеОбъекта	 - 	 - 
//
Процедура ПолноеКопированиеДанныхПоВерсииБюджета(СсылкаНаОбъектМетаданных, ВерсияБюджетаИсточник, ВерсияБюджетаПриемник) Экспорт
	//СписокФормы = Форма.Список;
	//Мд = Метаданные.НайтиПоТипу(ТипЗнч(СписокФормы));
	МетаданныеОбъекта = СсылкаНаОбъектМетаданных.Метаданные();
	ЭтоДокумент = Метаданные.Документы.Содержит(МетаданныеОбъекта);
	ЭтоРегистрСведений = Метаданные.РегистрыСведений.Содержит(МетаданныеОбъекта);
	МдРеквизиты = ?(ЭтоРегистрСведений, МетаданныеОбъекта.Измерения, МетаданныеОбъекта.Реквизиты);
	Если МдРеквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
		Возврат;
	ИначеЕсли ЭтоРегистрСведений И МетаданныеОбъекта.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат;
	КонецЕсли;
	
	//Запрос = Новый Запрос;
	//Запрос.Текст =
	//"ВЫБРАТЬ РАЗЛИЧНЫЕ
	//|	ЕСТЬNULL(Версии.Ссылка, Спр.ВерсияБюджета) КАК Версия,
	//|	ВЫБОР КОГДА Спр.ВерсияБюджета ЕСТЬ NULL ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК Пусто
	//|ИЗ Справочник.КТ_ВерсииБюджета КАК Версии ПОЛНОЕ СОЕДИНЕНИЕ "+МетаданныеОбъекта.ПолноеИмя()+" КАК Спр ПО (Спр.ВерсияБюджета = Версии.Ссылка)
	//|ГДЕ "+?(ЭтоРегистрСведений, "", "(НЕ ЕСТЬNULL(Спр.ПометкаУдаления, ЛОЖЬ)) И ")+"(НЕ ЕСТЬNULL(Версии.ЭтоГруппа, ЛОЖЬ)) И (НЕ ЕСТЬNULL(Версии.ПометкаУдаления, ЛОЖЬ))
	//|УПОРЯДОЧИТЬ ПО Пусто, Версия";
	//Выб = Запрос.Выполнить().Выбрать();
	//
	//ФормаВыбора = ПолучитьОбщуюФорму("КТ_ФормаВыбораНовойВерсииbug");
	//ФормаВыбора.НачЗнч = ?(СписокФормы.Отбор.ВерсияБюджета.Использование, СписокФормы.Отбор.ВерсияБюджета.Значение, Неопределено);
	//ФормаВыбора.Список1 = Новый Массив;
	//ФормаВыбора.Список2 = Новый Массив;
	//
	//Пока Выб.Следующий() Цикл
	//	Если Выб.Пусто Тогда
	//		ФормаВыбора.Список2.Добавить(Выб.Версия);
	//	Иначе
	//		ФормаВыбора.Список1.Добавить(Выб.Версия);
	//	КонецЕсли;
	//КонецЦикла;
	//
	//Рез = ФормаВыбора.ОткрытьМодально();
	//Если Рез=Неопределено Тогда
	//	Возврат;
	//КонецЕсли;
	
	СтрРекв = "";
	МасТч = Новый Массив;
	Если ЭтоРегистрСведений Тогда
		Для каждого Рекв Из МетаданныеОбъекта.Измерения Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
		Для каждого Рекв Из МетаданныеОбъекта.Ресурсы Цикл
			МожноКопировать = Истина;
			Для каждого пмТип Из Рекв.Тип.Типы() Цикл
				МдРекв = Метаданные.НайтиПоТипу(пмТип);
				Если МдРекв=Неопределено Тогда
					Продолжить;
				ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
					Продолжить;
				ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				МожноКопировать = Ложь;
				Прервать;
			КонецЦикла;
			
			Если МожноКопировать Тогда
				СтрРекв = СтрРекв+", "+Рекв.Имя;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Для каждого Рекв Из МетаданныеОбъекта.Реквизиты Цикл
		МожноКопировать = Истина;
		Для каждого пмТип Из Рекв.Тип.Типы() Цикл
			МдРекв = Метаданные.НайтиПоТипу(пмТип);
			Если МдРекв=Неопределено Тогда
				Продолжить;
			ИначеЕсли Не (Метаданные.Справочники.Содержит(МдРекв) Или Метаданные.Документы.Содержит(МдРекв)) Тогда
				Продолжить;
			ИначеЕсли МдРекв.Реквизиты.Найти("ВерсияБюджета")=Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			МожноКопировать = Ложь;
			Прервать;
		КонецЦикла;
		
		Если МожноКопировать Тогда
			СтрРекв = СтрРекв+", "+Рекв.Имя;
		КонецЕсли;
	КонецЦикла;
	Если ЭтоРегистрСведений Тогда
		СтрРекв = "Период"+СтрРекв;
	ИначеЕсли ЭтоДокумент Тогда
		СтрРекв = Сред(СтрРекв, 3);//"Дата"+СтрРекв;
	Иначе
		СтрРекв = "Наименование"+СтрРекв;
	КонецЕсли;
	
	Если Не ЭтоРегистрСведений Тогда
		Для каждого Тч Из МетаданныеОбъекта.ТабличныеЧасти Цикл
			МасТч.Добавить(Тч.Имя);
		КонецЦикла;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВерсияБюджета", ВерсияБюджетаИсточник);
	Запрос.Текст = "ВЫБРАТЬ * ИЗ "+МетаданныеОбъекта.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета"+?(ЭтоРегистрСведений, "", " И (НЕ ПометкаУдаления)");
	Выб = Запрос.Выполнить().Выбрать();
	нн = 0;
	Пока Выб.Следующий() Цикл
		нн = нн+1;
		//Состояние(""+нн+"/"+Выб.Количество()+?(ЭтоРегистрСв, "", " "+Выб.Ссылка));
		
		Попытка
			Если ЭтоРегистрСведений Тогда
				НовОбъект = РегистрыСведений[МетаданныеОбъекта.Имя].СоздатьМенеджерЗаписи();
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				НовОбъект.ВерсияБюджета = ВерсияБюджетаПриемник;
				НовОбъект.Период = Дата(Число(ВерсияБюджетаПриемник.Год), Месяц(НовОбъект.Период), День(НовОбъект.Период));
				НовОбъект.Записать(Ложь);
			Иначе
				Если ЭтоДокумент Тогда
					НовОбъект = Документы[МетаданныеОбъекта.Имя].СоздатьДокумент();
					НовОбъект.Дата = ТекущаяДата();
				Иначе
					НовОбъект = Справочники[МетаданныеОбъекта.Имя].СоздатьЭлемент();
				КонецЕсли;
				
				ЗаполнитьЗначенияСвойств(НовОбъект, Выб, СтрРекв);
				Если Не МдРеквизиты.Найти("ДоступЗакрыт")=Неопределено Тогда
					НовОбъект.ДоступЗакрыт = Ложь;
				КонецЕсли;
				НовОбъект.ВерсияБюджета = ВерсияБюджетаПриемник;
				Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(НовОбъект, "Год") Тогда
					НовОбъект.Год = СтрЗаменить(ВерсияБюджетаПриемник.Год, Символы.НПП, "");
				КонецЕсли;
				
				Для каждого Тч Из МасТч Цикл
					ВыбТч = Выб[Тч].Выбрать();
					Пока ВыбТч.Следующий() Цикл
						ЗаполнитьЗначенияСвойств(НовОбъект[Тч].Добавить(), ВыбТч, , "НомерСтроки");
					КонецЦикла;
				КонецЦикла;
				
				Попытка
					НовОбъект.ПерезаполнитьПриСоздании();
				Исключение
				КонецПопытки;
				
				Если ЭтоДокумент Тогда
					НовОбъект.УстановитьНовыйНомер();
					НовОбъект.Записать();
					Если Выб.Проведен Тогда
						НовОбъект.Записать(РежимЗаписиДокумента.Проведение);
					КонецЕсли;
				Иначе
					НовОбъект.УстановитьНовыйКод();
					НовОбъект.Записать();
				КонецЕсли;
			КонецЕсли;
		Исключение
			Сообщить("Ошибка копирования:"+?(ЭтоРегистрСведений, "", " "+Выб.Ссылка+"! ")+ОписаниеОшибки(), СтатусСообщения.Важное);
		КонецПопытки;
	КонецЦикла;
	
	Сообщить("Копирование завершено.");
КонецПроцедуры

// Процедура - Команда обработка изменить доступ по версии бюджета
//
// Параметры:
//  Форма	 - 	 - 
//  Кнопка	 - 	 - 
//
Процедура ИзменениеДоступаКОбъектамПоВерсииБюджета(ОбъектДанных, ИмяКоманды, ТекущаяВерсияБюджета, ТекущийОбъектСсылка = Неопределено) Экспорт
	
	Если ТипЗнч(ОбъектДанных) = Тип("Строка") Тогда
		МассивПодстрокИмениФормы = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ОбъектДанных, ".");
		МетаданныеОбъекта = Метаданные.НайтиПоТипу(Тип(МассивПодстрокИмениФормы.Получить(0) + ?(МассивПодстрокИмениФормы.Получить(0) <> "ЖурналДокументов", "Ссылка.", "Менеджер.") + МассивПодстрокИмениФормы.Получить(1)));
	Иначе 
		МетаданныеОбъекта = ОбъектДанных.Метаданные();
	КонецЕсли;
	
	ЭтоСправочник = ОбщегоНазначения.ЭтоСправочник(МетаданныеОбъекта);
	Если МассивПодстрокИмениФормы.Получить(0) = "ЖурналДокументов" Тогда
		МетаданныеОбъектаРеквизиты = МетаданныеОбъекта.Графы;
	Иначе
		МетаданныеОбъектаРеквизиты = МетаданныеОбъекта.Реквизиты;
	КонецЕсли;
	
	Если МетаданныеОбъектаРеквизиты.Найти("ВерсияБюджета") = Неопределено 
		Или МетаданныеОбъектаРеквизиты.Найти("ДоступЗакрыт") = Неопределено
		Или Не РольДоступна("АдминистраторБюджетирования") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущаяВерсияБюджета <> Неопределено 
		И ИмяКоманды <> "КнопкаКоманднаяПанельИзменитьДоступ1" Тогда
		//Если Вопрос(Сред(Кнопка.Имя, 18)+" доступ для всех позиций?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		//	Возврат;
		//КонецЕсли;
		Запрос = Новый Запрос("ВЫБРАТЬ Ссылка, ДоступЗакрыт ИЗ "+МетаданныеОбъекта.ПолноеИмя()+" ГДЕ ВерсияБюджета = &ВерсияБюджета И НЕ ДоступЗакрыт = &ДоступЗакрыт");
		Запрос.УстановитьПараметр("ВерсияБюджета", ТекущаяВерсияБюджета);
		Запрос.УстановитьПараметр("ДоступЗакрыт", Не ИмяКоманды="КнопкаКоманднаяПанельИзменитьДоступ2");
		Выборка = Запрос.Выполнить().Выбрать();
		Попытка
			Пока Выборка.Следующий() Цикл
				ОбъектДоступа = Выборка.Ссылка.ПолучитьОбъект();
				ОбъектДоступа.ДоступЗакрыт = Не ИмяКоманды="КнопкаКоманднаяПанельИзменитьДоступ2";
				ОбъектДоступа.Записать();
			КонецЦикла;
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	Иначе
		Если ТекущийОбъектСсылка = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		ОбъектДоступа = ТекущийОбъектСсылка.ПолучитьОбъект();
		ОбъектДоступа.ДоступЗакрыт = Не ОбъектДоступа.ДоступЗакрыт;
		Попытка
			ОбъектДоступа.Записать();
		Исключение
			Сообщить("Ошибка изменения доступа!");
		КонецПопытки;
	КонецЕсли;
КонецПроцедуры

// Функция - Получить массив версий бюджета объекта по имени формы
//
// Параметры:
//  ИмяФормы - 	 - 
// 
// Возвращаемое значение:
//   - 
//
Функция ПолучитьМассивВерсийБюджетаОбъектаПоПолномуИмениФормы(ОбъектДанных) Экспорт
	
	МассивВерсийБюджетаОбъекта = Новый Массив;
	
	Если ТипЗнч(ОбъектДанных) = Тип("Строка") Тогда
		МассивПодстрокИмениФормы = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(ОбъектДанных, ".");
		МетаданныеОбъекта = Метаданные.НайтиПоТипу(Тип(МассивПодстрокИмениФормы.Получить(0) + "Ссылка." + МассивПодстрокИмениФормы.Получить(1)));
	Иначе 
		МетаданныеОбъекта = ОбъектДанных.Метаданные();
	КонецЕсли;
	
	ЭтоРегистрСведений = ОбщегоНазначения.ЭтоРегистрСведений(МетаданныеОбъекта);
	МетаданныеОбъектаРеквизиты = ?(ЭтоРегистрСведений, МетаданныеОбъекта.Измерения, МетаданныеОбъекта.Реквизиты);
	
	Если МетаданныеОбъектаРеквизиты.Найти("ВерсияБюджета") = Неопределено Тогда
		Возврат МассивВерсийБюджетаОбъекта;
	ИначеЕсли ЭтоРегистрСведений И МетаданныеОбъекта.РежимЗаписи = Метаданные.СвойстваОбъектов.РежимЗаписиРегистра.ПодчинениеРегистратору Тогда
		Возврат МассивВерсийБюджетаОбъекта;
	КонецЕсли;
	
	Попытка
		//	Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ ТаблицаВерсийБюджета.ВерсияБюджета КАК ВерсияБюджета ИЗ "+МетаданныеОбъекта.ПолноеИмя()+" КАК ТаблицаВерсийБюджета УПОРЯДОЧИТЬ ПО ТаблицаВерсийБюджета.ВерсияБюджета.Наименование, ВерсияБюджета");
		Запрос = Новый Запрос("ВЫБРАТЬ ТаблицаВерсийБюджета.ВерсияБюджета КАК ВерсияБюджета ИЗ "+МетаданныеОбъекта.ПолноеИмя()+" КАК ТаблицаВерсийБюджета СГРУППИРОВАТЬ ПО ТаблицаВерсийБюджета.ВерсияБюджета УПОРЯДОЧИТЬ ПО ТаблицаВерсийБюджета.ВерсияБюджета.Наименование, ВерсияБюджета");
		Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ВерсияБюджета");
	Исключение
		Возврат МассивВерсийБюджетаОбъекта;
	КонецПопытки;
	
КонецФункции

Функция КТ_УстановитьВидПоступления(СтрокаТЧ, НазваниеТЧ) Экспорт
	
	//для товаров
	ВидПоступленияТМЗ_БезНДС = Константы.КТ_ВидПоступленияТМЗ_БезНДС.Получить();
	ВидПоступленияТМЗ_СНДС = Константы.КТ_ВидПоступленияТМЗ_СНДС.Получить();
	//для ОС
	ВидПоступленияОС_БезНДС = Константы.КТ_ВидПоступленияОС_БезНДС.Получить();
	ВидПоступленияОС_СНДС = Константы.КТ_ВидПоступленияОС_СНДС.Получить();
	//для услуг	
	ВидПоступленияУслуги_БезНДС = Константы.КТ_ВидПоступленияУслуги_БезНДС.Получить();
	ВидПоступленияУслуги_СНДС = Константы.КТ_ВидПоступленияУслуги_СНДС.Получить();
	
	Если НазваниеТЧ = "Товары" Тогда
		Если ЗначениеЗаполнено(ВидПоступленияТМЗ_БезНДС) И ЗначениеЗаполнено(ВидПоступленияТМЗ_СНДС) Тогда
			СтрокаТЧ.НДСВидПоступления = ?(СтрокаТЧ.СтавкаНДС.Ставка = 0, ВидПоступленияТМЗ_БезНДС, ВидПоступленияТМЗ_СНДС); 
		КонецЕсли;
	ИначеЕсли НазваниеТЧ = "ОС" Тогда
		Если ЗначениеЗаполнено(ВидПоступленияОС_БезНДС) И ЗначениеЗаполнено(ВидПоступленияОС_СНДС) Тогда
			СтрокаТЧ.НДСВидПоступления = ?(СтрокаТЧ.СтавкаНДС.Ставка = 0, ВидПоступленияОС_БезНДС, ВидПоступленияОС_СНДС); 
		КонецЕсли;
	Иначе
		Если ЗначениеЗаполнено(ВидПоступленияУслуги_БезНДС) И ЗначениеЗаполнено(ВидПоступленияУслуги_СНДС) Тогда
			СтрокаТЧ.НДСВидПоступления = ?(СтрокаТЧ.СтавкаНДС.Ставка = 0, ВидПоступленияУслуги_БезНДС, ВидПоступленияУслуги_СНДС); 
		КонецЕсли;
	КонецЕсли;
	
КонецФункции
