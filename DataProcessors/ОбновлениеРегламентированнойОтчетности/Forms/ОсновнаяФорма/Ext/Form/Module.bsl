
////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Готовит дерево значений, в котором будет храниться список регламентированных 
// отчетов, на основе списка, хранящегося в макете обработке. Показывает дерево
// для установи пользователем отметок - какие именно отчеты следует обновлять.
//   На основе подготовленого списка выполяет обновление списка отчетов в 
// справочнике регламентированные отчеты.
//
&НаКлиенте
Процедура ОбновитьСписокОтчетов()
		
	ЗаполнитьДеревоОтчетов();

	Если ДеревоОтчетов.ПолучитьЭлементы().Количество() = 0 Тогда
		// нет обновлений
		Возврат;
	КонецЕсли;
	        	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ДеревоОтчетов", ДеревоОтчетов);
	ОписаниеОповещения = Новый ОписаниеОповещения("ОбновитьСписокОтчетовЗавершение", ЭтотОбъект);
	ФормаВыбораОтчетов = ОткрытьФорму("Обработка.ОбновлениеРегламентированнойОтчетности.Форма.ФормаВыбораОтчетов", ПараметрыФормы, , "дляВыбораРегламОтчетов",,,ОписаниеОповещения,РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры // ОбновитьСписокОтчетов()

// ЗаполнитьДеревоОтчетов()
//
&НаСервере
Процедура ЗаполнитьДеревоОтчетов()
	
	СписокОтчетов = РеквизитФормыВЗначение("Объект").ПолучитьСписокОтчетов();
	
	Если СписокОтчетов.Строки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
			
	// Заполним список отчетов
	ЗначениеВРеквизитФормы(СписокОтчетов, "ДеревоОтчетов");
		
КонецПроцедуры // ЗаполнитьДеревоОтчетов()

// ЗаполнитьСписокОтчетов()
//
&НаСервере
Процедура ЗаполнитьСписокОтчетов()
	
	РеквизитФормыВЗначение("Объект").ЗаполнитьСписокОтчетов(РеквизитФормыВЗначение("ДеревоОтчетов"));
	РеквизитФормыВЗначение("Объект").УстановитьСнятьПометкуНаУдалениеИСкрытьВосстановитьОтчеты(РеквизитФормыВЗначение("ДеревоОтчетов"));
		
КонецПроцедуры // ЗаполнитьСписокОтчетов()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

// ПриОткрытии()
//
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Отказ = Истина;

	ОписаниеОповещения = Новый ОписаниеОповещения("ПриОткрытииЗавершение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, НСтр("ru='Обновить комплект отчетности?'"), РежимДиалогаВопрос.ДаНет, , КодВозвратаДиалога.Да);
	
КонецПроцедуры // ПриОткрытии()


////////////////////////////////////////////////////////////////////////////////
// СЕРВИСНЫЕ ПРОЦЕДУРЫ 

&НаКлиенте
Процедура ОбновитьСписокОтчетовЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	ДеревоВыбранныхОтчетов = Результат;
	
	Если ДеревоВыбранныхОтчетов = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	КопироватьДанныеФормы(ДеревоВыбранныхОтчетов, ДеревоОтчетов);
	
	ЗаполнитьСписокОтчетов();
	
	Оповестить("Обновить дерево отчетов", "Обновить дерево отчетов", ЭтаФорма)
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытииЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	
	Если РезультатВопроса = КодВозвратаДиалога.Да Тогда
		
		ОбновитьСписокОтчетов();
		
	КонецЕсли;
	
КонецПроцедуры
