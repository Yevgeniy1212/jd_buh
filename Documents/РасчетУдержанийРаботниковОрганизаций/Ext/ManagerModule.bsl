#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ	

// Выполняет автоматическое заполнение документа по данным документа и переданным параметрам
// 
// Параметры: 
//  нет
//
// Возвращаемое значение:
//  Логическое - удалось ли выполнить автоматическое заполнение документа
//
Процедура Автозаполнение(Объект, ПостроительЗапроса = Неопределено) Экспорт

	ГоловнаяОрганизация = ОбщегоНазначенияБКВызовСервера.ГоловнаяОрганизацияДляУчетаЗарплаты(Объект.Организация);
	
	СписокГруппИнвалидности = Новый СписокЗначений;
	СписокГруппИнвалидности.Добавить("I");
	СписокГруппИнвалидности.Добавить("II");
	
	Если ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями") Тогда
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Объект.СтруктурноеПодразделение,
								Объект.Организация,
								Перечисления.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты);
	Иначе
		Налогоплательщик = Объект.Организация;
	КонецЕсли;
	
	РасчетДляИП = (Налогоплательщик.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо);
	
	// узнаем учетную политику по налоговому учету
	ОрганизацияЯвляетсяПлательщикомСН = УчетнаяПолитикаСервер.ОрганизацияЯвляетсяПлательщикомСН(Объект.Организация, Объект.ПериодРегистрации);
	
	// При автозаполнении будем исключать физлицо, если организация является ИП на основе СНР
	ИсключитьДанныеИП = (РасчетДляИП И НЕ ОрганизацияЯвляетсяПлательщикомСН);
	
	// При заполнении СО будем учитывать требуется ли ежемесячный расчет
	ЕжемесячныйРасчетВзносовИОтчисленийЗаИП = ПроцедурыНалоговогоУчета.ПолучитьПризнакЕжемесячногоРасчетаВзносовИОтчисленийЗаИП(Объект.Организация, Объект.ПериодРегистрации);
	
	ПредоставлятьВычетВМесяцеОтсутствияДохода = УчетнаяПолитикаСервер.ПредоставлятьВычетВМесяцеОтсутствияДохода(Объект.Организация, Объект.ПериодРегистрации);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	// Установим параметры запроса
	Запрос.УстановитьПараметр("парамНачало" , Объект.ПериодРегистрации);
	Запрос.УстановитьПараметр("парамКонец" , КонецМесяца(Объект.ПериодРегистрации));
	Запрос.УстановитьПараметр("парамОрганизация" , Объект.Организация);
	Запрос.УстановитьПараметр("парамСтруктурноеПодразделение", Объект.СтруктурноеПодразделение);
	Запрос.УстановитьПараметр("парамГоловнаяОрганизация" , ГоловнаяОрганизация);
	Запрос.УстановитьПараметр("парамПодразделение" , Объект.ПодразделениеОрганизации);
	Запрос.УстановитьПараметр("Уволен", Перечисления.ПричиныИзмененияСостояния.Увольнение);
	Запрос.УстановитьПараметр("Принят", Перечисления.ПричиныИзмененияСостояния.ПриемНаРаботу);
	Запрос.УстановитьПараметр("парамПриход", ВидДвиженияНакопления.Приход);
	Запрос.УстановитьПараметр("парамИсчисление", Перечисления.РасчетыСБюджетомФондамиВидСтроки.Исчисление);
	Запрос.УстановитьПараметр("парамНалогВзнос", Перечисления.ВидыПлатежейВБюджетИФонды.Налог);
	Запрос.УстановитьПараметр("парамВнутреннееСовместительство", Перечисления.ВидыЗанятостиВОрганизации.ВнутреннееСовместительство);
	Запрос.УстановитьПараметр("парамИнвалид", Перечисления.ОтношениеКИнвалидности.Инвалид);
	Запрос.УстановитьПараметр("парамПустаяОрганизация", Справочники.Организации.ПустаяСсылка());
	Запрос.УстановитьПараметр("парамДействиеПрекратить", Перечисления.ВидыДействияСНачислением.Прекратить);
	Запрос.УстановитьПараметр("парамРегистратор", Объект.Ссылка);
	Запрос.УстановитьПараметр("парамСписокГруппИнвалидности",  СписокГруппИнвалидности);
	Запрос.УстановитьПараметр("парамПустаяДата", '00010101');
	Запрос.УстановитьПараметр("парамВидРасчета", Объект.ВидРасчета);
	Запрос.УстановитьПараметр("парамСписокСпособовРасчетовФиксированнойСуммой", ПроведениеРасчетовСервер.ПолучитьСписокСпособовРасчетовФиксированнойСуммой());
	Запрос.УстановитьПараметр("парамНалогоплательщик", Налогоплательщик);
    Запрос.УстановитьПараметр("парамИндивидуальныйПредприниматель", Налогоплательщик.ИндивидуальныйПредприниматель);
	
	УчетнаяПолитикаПоПерсоналуОрганизацииТекст = УчетнаяПолитикаСервер.ПолучитьТекстЗапросаУчетнойПолитикиПоПерсоналу();
	УчетнаяПолитикаПоПерсоналуОрганизацииТекст = СтрЗаменить(УчетнаяПолитикаПоПерсоналуОрганизацииТекст,"РАЗРЕШЕННЫЕ","");
	
	ПустоеПодразделение = Справочники.ПодразделенияОрганизаций.ПустаяСсылка();
	
	Если Объект.ПодразделениеОрганизации = ПустоеПодразделение Тогда
		ПоВсемПодразделениямОрганизации = Истина;
		УсловиеНаПодразделение = "РаботникиОрганизации.ПодразделениеОрганизации.Владелец = &парамОрганизация";
	Иначе
		ПоВсемПодразделениямОрганизации = Ложь;
		УсловиеНаПодразделение = "РаботникиОрганизации.ПодразделениеОрганизации В ИЕРАРХИИ (&парамПодразделение)";
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.ВидРасчета) Тогда
		УсловиеНаВидРасчета = "ПлановыеУдержания.ВидРасчета = &парамВидРасчета";
	Иначе
		УсловиеНаВидРасчета = "";
	КонецЕсли;
	
	//СписокРаботниковТекст
	//Описание:
	//	Выбирает список работников, отвечающих условиям отбора, числящихся на начало месяца и принятых за месяц,
	//  а также переведенных в середине месяца из других обособленных подразделений
	СписокРаботниковТекст = "
	|		// срез работников на начало месяца
	|		ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|			РаботникиОрганизации.Сотрудник.Физлицо КАК Физлицо
	|		ПОМЕСТИТЬ ВТ_СписокРаботников
	|		ИЗ
	|			(ВЫБРАТЬ
	|				МАКСИМУМ(ВЫБОР
	|					КОГДА ТИПЗНАЧЕНИЯ(РаботникиОрганизацийСрезПоследних.Регистратор) = ТИП(Документ.ПриемНаРаботуВОрганизацию)
	|						ТОГДА РаботникиОрганизацийСрезПоследних.Регистратор
	|					ИНАЧЕ ЛОЖЬ
	|				КОНЕЦ) КАК Регистратор,
	|				РаботникиОрганизацийСрезПоследних.Сотрудник.Физлицо КАК Физлицо,
	|				РаботникиОрганизацийСрезПоследних.Организация КАК Организация
	|			ИЗ
	|				РегистрСведений.РаботникиОрганизаций.СрезПоследних(&парамНачало, Организация = &парамГоловнаяОрганизация И Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство) КАК РаботникиОрганизацийСрезПоследних
	|
	|			СГРУППИРОВАТЬ ПО
	|				РаботникиОрганизацийСрезПоследних.Сотрудник.Физлицо,
	|				РаботникиОрганизацийСрезПоследних.Организация) КАК АктуальныйСписокРаботников
	|				ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций.СрезПоследних(
	|					&парамНачало, 
	|					Организация = &парамГоловнаяОрганизация 
	|					И (Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство)) КАК РаботникиОрганизации
	|				ПО АктуальныйСписокРаботников.Физлицо = РаботникиОрганизации.Сотрудник.Физлицо
	|					И АктуальныйСписокРаботников.Организация = РаботникиОрганизации.Организация
	|					И (ВЫБОР
	|						КОГДА АктуальныйСписокРаботников.Регистратор <> ЛОЖЬ
	|							ТОГДА РаботникиОрганизации.Регистратор = АктуальныйСписокРаботников.Регистратор
	|						ИНАЧЕ ИСТИНА
	|					КОНЕЦ)
	|		ГДЕ
	|			РаботникиОрганизации.ОбособленноеПодразделение = &парамОрганизация
	|			И РаботникиОрганизации.Организация = &парамГоловнаяОрганизация
	|			И РаботникиОрганизации.СтруктурноеПодразделение = &парамСтруктурноеПодразделение
	|			И РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
	|		" + ?(ПоВсемПодразделениямОрганизации, "", " И " + УсловиеНаПодразделение) + "
	|		
	|		ОБЪЕДИНИТЬ
	|
	|		// движения работников за месяц
	|		ВЫБРАТЬ
	|			РаботникиОрганизации.Сотрудник.Физлицо КАК ФизЛицо
	|		ИЗ
	|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизации
	|				ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|									ТекущееНазначение.Регистратор,
	|									ТекущееНазначение.НомерСтроки,
	|									МАКСИМУМ(ПредыдущееНазначение.Период) КАК ДатаПредыдущегоНазначения
	|								ИЗ
	|									РегистрСведений.РаботникиОрганизаций КАК ТекущееНазначение
	|									ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций КАК ПредыдущееНазначение
	|										ПО ТекущееНазначение.Сотрудник = ПредыдущееНазначение.Сотрудник
	|											И ПредыдущееНазначение.Организация = &парамГоловнаяОрганизация
	|											И ПредыдущееНазначение.Период < ТекущееНазначение.Период
	|											И ПредыдущееНазначение.Активность
	|								ГДЕ
	|									ТекущееНазначение.Период > &парамНачало
	|									И ТекущееНазначение.Период <= &парамКонец
	|									И ТекущееНазначение.Организация = &парамГоловнаяОрганизация
	|									И ТекущееНазначение.ОбособленноеПодразделение = &парамОрганизация
	|									И ТекущееНазначение.Активность
	|								СГРУППИРОВАТЬ ПО
	|									ТекущееНазначение.Регистратор,
	|									ТекущееНазначение.НомерСтроки) КАК ДатыПредыдущихНазначений
	|				ПО РаботникиОрганизации.Регистратор = ДатыПредыдущихНазначений.Регистратор
	|					И РаботникиОрганизации.НомерСтроки = ДатыПредыдущихНазначений.НомерСтроки
	|					
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций КАК ПредыдущиеНазначения
	|				ПО РаботникиОрганизации.Сотрудник = ПредыдущиеНазначения.Сотрудник
	|					И ПредыдущиеНазначения.Организация = &парамГоловнаяОрганизация
	|					И ДатыПредыдущихНазначений.ДатаПредыдущегоНазначения = ПредыдущиеНазначения.Период
	|					И ПредыдущиеНазначения.Активность
	|		
	|		ГДЕ
	|			РаботникиОрганизации.Период > &парамНачало
	|			И РаботникиОрганизации.Период <= &парамКонец
	|			И РаботникиОрганизации.Организация = &парамГоловнаяОрганизация
	|			И (РаботникиОрганизации.Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство)
	|			И (РаботникиОрганизации.ПричинаИзмененияСостояния = &Принят
	|					ИЛИ РаботникиОрганизации.ОбособленноеПодразделение <> ПредыдущиеНазначения.ОбособленноеПодразделение
	|					ИЛИ РаботникиОрганизации.СтруктурноеПодразделение <> ПредыдущиеНазначения.СтруктурноеПодразделение)
	|			И РаботникиОрганизации.ОбособленноеПодразделение = &парамОрганизация
	|			И РаботникиОрганизации.СтруктурноеПодразделение = &парамСтруктурноеПодразделение
	|			И РаботникиОрганизации.Активность
	|			" + ?(ПоВсемПодразделениямОрганизации, "", " И " + УсловиеНаПодразделение) + "
	|";
	Запрос.Текст = СписокРаботниковТекст;
	Запрос.Выполнить();
	СписокРаботниковТекст = "ВТ_СписокРаботников";
	
	// заполнение табличной части "Удержания"
	//Основной текст запроса
	УдержанияТекст = "
    | ВЫБРАТЬ РАЗРЕШЕННЫЕ
    |	РасчетЕдиногоПлатежа.Ссылка КАК Ссылка,
    |	РасчетЕдиногоПлатежа.Ссылка.Организация КАК Организация,
    |	РасчетЕдиногоПлатежа.ФизЛицо КАК ФизЛицо,
    |	РасчетЕдиногоПлатежа.Ссылка.ПериодРегистрации КАК ПериодРегистрации,
    |	РасчетЕдиногоПлатежа.ДокументОснование КАК ДокументОснование,
    |   РасчетЕдиногоПлатежа.ВидРасчета КАК ВидРасчета 
    |ПОМЕСТИТЬ ВТ_РанееСделанныеУдержания
    |ИЗ
    |	Документ.РасчетЕдиногоПлатежа.Удержания КАК РасчетЕдиногоПлатежа
    |ГДЕ
    |	РасчетЕдиногоПлатежа.Ссылка.Проведен
    |	И РасчетЕдиногоПлатежа.Ссылка.ПериодРегистрации = &парамНачало
    |
    |ОБЪЕДИНИТЬ ВСЕ
    |
    |ВЫБРАТЬ
    |	РасчетУдержанийРаботниковОрганизаций.Ссылка,
    |	РасчетУдержанийРаботниковОрганизаций.Ссылка.Организация,
    |	РасчетУдержанийРаботниковОрганизаций.ФизЛицо,
    |	РасчетУдержанийРаботниковОрганизаций.Ссылка.ПериодРегистрации,
    |	РасчетУдержанийРаботниковОрганизаций.ДокументОснование,
    |   РасчетУдержанийРаботниковОрганизаций.ВидРасчета КАК ВидРасчета 
    |ИЗ
    |	Документ.РасчетУдержанийРаботниковОрганизаций.Удержания КАК РасчетУдержанийРаботниковОрганизаций
    |ГДЕ
    |	РасчетУдержанийРаботниковОрганизаций.Ссылка <> &парамРегистратор
    |	И РасчетУдержанийРаботниковОрганизаций.Ссылка.Проведен
    |	И РасчетУдержанийРаботниковОрганизаций.Ссылка.ПериодРегистрации = &парамНачало
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ
    |	ПлановыеУдержания.ФизЛицо,
	|	ПлановыеУдержания.ВидРасчета,
	|	ПлановыеУдержания.ВидРасчета.СпособРасчета КАК СпособРасчета,
	|	ПлановыеУдержания.Размер КАК Размер,
	|
	|	ВЫБОР
	|		КОГДА ПлановыеУдержания.Период < &парамНачало ТОГДА &парамНачало
	|		ИНАЧЕ ПлановыеУдержания.Период
	|	КОНЕЦ КАК ДатаНачала,
	|
	|	ВЫБОР
	|		КОГДА ПлановыеУдержания.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1)
	|				И ПлановыеУдержания.ПериодЗавершения <= &парамКонец
	|			ТОГДА КОНЕЦПЕРИОДА(ПлановыеУдержания.ПериодЗавершения, ДЕНЬ)
	|		ИНАЧЕ МИНИМУМ(ЕСТЬNULL(ДОБАВИТЬКДАТЕ(СледующиеПлановыеУдержания.Период, ДЕНЬ, -1), &парамКонец))
	|	КОНЕЦ КАК ДатаОкончания,
	|
	|	ПлановыеУдержания.ДокументОснование
	|ПОМЕСТИТЬ ВТ_ДанныеПлановыхУдержаний
	|ИЗ
	|	" + СписокРаботниковТекст + " КАК Работники
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПлановыеУдержанияРаботниковОрганизаций КАК ПлановыеУдержания
	|		ПО Работники.ФизЛицо = ПлановыеУдержания.ФизЛицо
	|			И ПлановыеУдержания.Активность
	|
    |	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&парамКонец, ) КАК УчетнаяПолитикаНУ
    |		ПО (ПлановыеУдержания.Организация = УчетнаяПолитикаНУ.Организация)
    |
    |	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПлановыеУдержанияРаботниковОрганизаций КАК СледующиеПлановыеУдержания
	|		ПО ПлановыеУдержания.Организация = СледующиеПлановыеУдержания.Организация
	|			И ПлановыеУдержания.Физлицо = СледующиеПлановыеУдержания.Физлицо
	|			И ПлановыеУдержания.ВидРасчета = СледующиеПлановыеУдержания.ВидРасчета
	|			И ПлановыеУдержания.ДокументОснование = СледующиеПлановыеУдержания.ДокументОснование
	|			И СледующиеПлановыеУдержания.Период > ПлановыеУдержания.Период
	|			И СледующиеПлановыеУдержания.Период <= &парамКонец
	|			И СледующиеПлановыеУдержания.Активность
	|
	|	// для предотвращения дублирования удержаний за один период регистрации в одном и том же ОбособленномПодразделении,
	|	// а для расчетов фиксированной суммой - один раз в целом по головной организации
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_РанееСделанныеУдержания КАК РанееСделанныеУдержания
	|		ЛЕВОЕ СОЕДИНЕНИЕ (" + УчетнаяПолитикаПоПерсоналуОрганизацииТекст + ") КАК ВТ_УчетнаяПолитикаПоПерсоналуОрганизации
	|			ПО РанееСделанныеУдержания.Организация = ВТ_УчетнаяПолитикаПоПерсоналуОрганизации.Организация
	|		ПО ВЫБОР
	|				КОГДА ПлановыеУдержания.ВидРасчета.СпособРасчета В (&парамСписокСпособовРасчетовФиксированнойСуммой)
	|					ТОГДА ВЫБОР
	|							КОГДА ВТ_УчетнаяПолитикаПоПерсоналуОрганизации.ВедениеУчетаПоГоловнойОрганизации = ИСТИНА ТОГДА
	|								ВЫБОР
	|									КОГДА РанееСделанныеУдержания.Организация.ГоловнаяОрганизация = &парамПустаяОрганизация
	|										ТОГДА РанееСделанныеУдержания.Организация
	|									ИНАЧЕ РанееСделанныеУдержания.Организация.ГоловнаяОрганизация
	|								КОНЕЦ
	|							ИНАЧЕ РанееСделанныеУдержания.Организация
	|						  КОНЕЦ = &парамГоловнаяОрганизация
	|				ИНАЧЕ РанееСделанныеУдержания.Организация = &парамОрганизация
	|			КОНЕЦ
	|			И РанееСделанныеУдержания.ФизЛицо = ПлановыеУдержания.ФизЛицо 
	|			И РанееСделанныеУдержания.ВидРасчета = ПлановыеУдержания.ВидРасчета 
	|			И ВЫБОР
	|				КОГДА НЕ (РанееСделанныеУдержания.ДокументОснование.Ссылка ЕСТЬ NULL)
	|					ТОГДА РанееСделанныеУдержания.ДокументОснование = ПлановыеУдержания.ДокументОснование
	|				ИНАЧЕ ИСТИНА
	|			  КОНЕЦ
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ГражданствоФизЛиц.СрезПоследних(&парамКонец, ) КАК ГражданствоФизЛиц
	|		ПО Работники.Физлицо = ГражданствоФизЛиц.Физлицо
	|
	|ГДЕ
	|	ПлановыеУдержания.Организация = &парамГоловнаяОрганизация
	|	И ПлановыеУдержания.Период <= &парамКонец
	|	И ВЫБОР
	|		КОГДА ПлановыеУдержания.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1) 
	|				И ПлановыеУдержания.ПериодЗавершения < &парамНачало ТОГДА ПлановыеУдержания.ДействиеЗавершения
	|		ИНАЧЕ ПлановыеУдержания.Действие
	|	  КОНЕЦ <> &парамДействиеПрекратить
	|	И РанееСделанныеУдержания.ФизЛицо ЕСТЬ NULL
    |	И (УчетнаяПолитикаНУ.ПорядокОбложенияДоходовРаботников = ЗНАЧЕНИЕ(Перечисление.ПорядокОбложенияДоходовРаботников.Общеустановленный)  
    |	ИЛИ  УчетнаяПолитикаНУ.ПорядокОбложенияДоходовРаботников ЕСТЬ NULL
    |	ИЛИ  ГражданствоФизЛиц.НеЯвляетсяНалоговымРезидентомРК)
	|	" + ?(УсловиеНаВидРасчета <> "", " И " + УсловиеНаВидРасчета, "") + "
	|
	|СГРУППИРОВАТЬ ПО
	|	ПлановыеУдержания.ФизЛицо,
	|	ПлановыеУдержания.ВидРасчета,
	|	ПлановыеУдержания.Размер,
	|
	|	ПлановыеУдержания.Период,
	|	ПлановыеУдержания.ПериодЗавершения,
	|	ПлановыеУдержания.ДокументОснование
	|
	|ИМЕЮЩИЕ
	|	МИНИМУМ(ЕСТЬNULL(ДОБАВИТЬКДАТЕ(СледующиеПлановыеУдержания.Период, ДЕНЬ, -1), &парамКонец)) >= &парамНачало
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ДанныеПлановыхУдержаний.ФизЛицо,
	|	ВТ_ДанныеПлановыхУдержаний.ВидРасчета,
	|	ВТ_ДанныеПлановыхУдержаний.СпособРасчета,
	|	МАКСИМУМ(ВТ_ДанныеПлановыхУдержаний.ДатаНачала) КАК ДатаНачала,
	|	ВТ_ДанныеПлановыхУдержаний.ДокументОснование
	|ПОМЕСТИТЬ ВТ_ПериодыПлановыхУдержаний
	|ИЗ
	|	ВТ_ДанныеПлановыхУдержаний КАК ВТ_ДанныеПлановыхУдержаний
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_ДанныеПлановыхУдержаний.ФизЛицо,
	|	ВТ_ДанныеПлановыхУдержаний.СпособРасчета,
	|	ВТ_ДанныеПлановыхУдержаний.ВидРасчета,
	|	ВТ_ДанныеПлановыхУдержаний.ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеПлановыхУдержаний.ФизЛицо,
	|	ДанныеПлановыхУдержаний.ВидРасчета,
	|	ДанныеПлановыхУдержаний.СпособРасчета,
	|	ДанныеПлановыхУдержаний.Размер,
	|	ДанныеПлановыхУдержаний.ДатаНачала,
	|	ДанныеПлановыхУдержаний.ДатаОкончания,
	|	ДанныеПлановыхУдержаний.ДокументОснование
	|ИЗ
	|	ВТ_ДанныеПлановыхУдержаний КАК ДанныеПлановыхУдержаний
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ПериодыПлановыхУдержаний КАК ВТ_ПериодыПлановыхУдержаний
	|		ПО ДанныеПлановыхУдержаний.ФизЛицо = ВТ_ПериодыПлановыхУдержаний.ФизЛицо
	|			И ДанныеПлановыхУдержаний.ВидРасчета = ВТ_ПериодыПлановыхУдержаний.ВидРасчета
	|			И ДанныеПлановыхУдержаний.СпособРасчета = ВТ_ПериодыПлановыхУдержаний.СпособРасчета
	|			И ДанныеПлановыхУдержаний.ДокументОснование = ВТ_ПериодыПлановыхУдержаний.ДокументОснование
	|			И ДанныеПлановыхУдержаний.ДатаНачала = ВТ_ПериодыПлановыхУдержаний.ДатаНачала
	|УПОРЯДОЧИТЬ ПО
	|	ДанныеПлановыхУдержаний.Физлицо.Наименование,
	|	ДанныеПлановыхУдержаний.ДокументОснование,
	|	ДанныеПлановыхУдержаний.ВидРасчета,
	|	ДанныеПлановыхУдержаний.ДатаНачала
	|";	
	
	Запрос.Текст = УдержанияТекст;
	ТЗУдержания = Запрос.Выполнить().Выгрузить();
	
	// Удалим из таблицы удержаний удержания почтового сбора, если для соответствующего документа-основания нет удержаний алиментов.
	// Такое может быть, если удержание по ИЛ фикс. суммой и уже было удержано в текущем месяце в другой обособленной организации.
	ТЗУдержания.Индексы.Добавить("ДокументОснование");
	ТЗУдержания.Индексы.Добавить("СпособРасчета");
	
	СтруктураПоиска = Новый Структура("СпособРасчета");
	СтруктураПоиска.СпособРасчета = Перечисления.СпособыРасчетаОплатыТруда.ПочтовыйСбор;
	НайденныеСтрокиПочтовогоСбора = ТЗУдержания.НайтиСтроки(СтруктураПоиска);
	
	МассивУдаляемыхСтрок = Новый Массив();
	
	СтруктураПоиска.Очистить();
	СтруктураПоиска.Вставить("ДокументОснование");
	Для Каждого СтрокаПочтовогоСбора Из НайденныеСтрокиПочтовогоСбора Цикл
		СтруктураПоиска.ДокументОснование = СтрокаПочтовогоСбора.ДокументОснование;
		НайденныеСтрокиДокумента = ТЗУдержания.НайтиСтроки(СтруктураПоиска);
		Если НайденныеСтрокиДокумента.Количество() = 1 Тогда // только одна строка с таким документом-основанием - сам почтовый сбор
			// запоминаем, что надо удалить такую строку из таблицы значений
			МассивУдаляемыхСтрок.Добавить(СтрокаПочтовогоСбора);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого УдаляемаяСтрока Из МассивУдаляемыхСтрок Цикл
		ТЗУдержания.Удалить(УдаляемаяСтрока);
	КонецЦикла;	
	
	Объект.Удержания.Загрузить(ТЗУдержания);
	
	Если УсловиеНаВидРасчета <> "" Тогда
		// если стоит отбор по виду удержания, то больше ничего не заполняем
		Возврат;
	КонецЕсли;
	
	// Добавим еще и тех человек, которые не являются работниками, но в расчетном месяце имеют
	// зарегистрированные суммы в регистре ИПНСведенияОДоходах или ОПВСведенияОДоходах, и 
	// при этом по ним нет расчетов ИПН и ОПВ за период регистрации (напр, акты закупа)
	СписокРаботниковТекст = "
	|ВЫБРАТЬ
	|	РаботникиОрганизации.ФизЛицо
	|ПОМЕСТИТЬ ВТ_Работники
	|ИЗ
	|	" + СписокРаботниковТекст + " КАК РаботникиОрганизации
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ИПНСведенияОДоходах.ФизЛицо
	|ИЗ
	|	РегистрНакопления.ИПНСведенияОДоходах КАК ИПНСведенияОДоходах
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций.СрезПоследних(
	|				&парамКонец, 
	|				Организация = &парамГоловнаяОрганизация 
	|				И Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство) КАК РаботникиОрганизации
	|		ПО ИПНСведенияОДоходах.ФизЛицо = РаботникиОрганизации.Сотрудник.ФизЛицо
	|			И (ВЫБОР 
	|				КОГДА (РаботникиОрганизации.ПричинаИзмененияСостояния = &Уволен
	|					И ДОБАВИТЬКДАТЕ(РаботникиОрганизации.Период, ДЕНЬ, -1) >= &парамНачало)
	|					ИЛИ РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|
	|ГДЕ
	|	ИПНСведенияОДоходах.Организация = &парамОрганизация И
	|	ИПНСведенияОДоходах.ПериодРегистрации = &парамНачало И	
	|	РаботникиОрганизации.Сотрудник ЕСТЬ NULL И
	|	ИПНСведенияОДоходах.Активность
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ОПВСведенияОДоходах.ФизЛицо
	|ИЗ
	|	РегистрНакопления.ОПВСведенияОДоходах КАК ОПВСведенияОДоходах
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций.СрезПоследних(
	|				&парамКонец, 
	|				Организация = &парамГоловнаяОрганизация 
	|				И Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство) КАК РаботникиОрганизации
	|		ПО ОПВСведенияОДоходах.ФизЛицо = РаботникиОрганизации.Сотрудник.ФизЛицо
	|			И (ВЫБОР 
	|				КОГДА (РаботникиОрганизации.ПричинаИзмененияСостояния = &Уволен
	|					И ДОБАВИТЬКДАТЕ(РаботникиОрганизации.Период, ДЕНЬ, -1) >= &парамНачало)
	|					ИЛИ РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|
	|ГДЕ
	|	ОПВСведенияОДоходах.Организация = &парамОрганизация И
	|	ОПВСведенияОДоходах.ПериодРегистрации = &парамНачало И
	|	РаботникиОрганизации.Сотрудник ЕСТЬ NULL И
	|	ОПВСведенияОДоходах.Активность
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ВОСМССведенияОДоходах.ФизЛицо
	|ИЗ
	|	РегистрНакопления.ВОСМССведенияОДоходах КАК ВОСМССведенияОДоходах
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций.СрезПоследних(
	|				&парамКонец, 
	|				Организация = &парамГоловнаяОрганизация 
	|				И Сотрудник.ВидЗанятости <> &парамВнутреннееСовместительство) КАК РаботникиОрганизации
	|		ПО ВОСМССведенияОДоходах.ФизЛицо = РаботникиОрганизации.Сотрудник.ФизЛицо
	|			И (ВЫБОР 
	|				КОГДА (РаботникиОрганизации.ПричинаИзмененияСостояния = &Уволен
	|					И ДОБАВИТЬКДАТЕ(РаботникиОрганизации.Период, ДЕНЬ, -1) >= &парамНачало)
	|					ИЛИ РаботникиОрганизации.ПричинаИзмененияСостояния <> &Уволен
	|					ТОГДА ИСТИНА
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|
	|ГДЕ
	|	ВОСМССведенияОДоходах.Организация = &парамОрганизация И
	|	ВОСМССведенияОДоходах.ПериодРегистрации = &парамНачало И
	|	РаботникиОрганизации.Сотрудник ЕСТЬ NULL И
	|	ВОСМССведенияОДоходах.Активность
	|";	
	Запрос.Текст = СписокРаботниковТекст;
	Запрос.Выполнить();
	СписокРаботниковТекст = "ВТ_Работники";
	
	Если Объект.ПериодРегистрации < Дата('2018-01-01') Тогда  // Логика расчета вычетов с 2018 года изменилась
		// заполнение табличной части "НалоговыеВычеты"
		НалоговыеВычетыТекст = "
		|ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	ИПНПлановыеВычеты.ФизЛицо,
		|	&парамНачало КАК МесяцНалоговогоПериода,
		|	ИПНПлановыеВычеты.ВычетИПН,
		|	ИПНПлановыеВычеты.ДокументОснование
		|ИЗ
		|	РегистрНакопления.ИПНСведенияОДоходах КАК ИПНСведенияОДоходах // берем вычеты только по тем лицам, по которым был доход в месяце
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
		|		ПО ИПНСведенияОДоходах.ФизЛицо = Работники.ФизЛицо
		|	
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ИПНПлановыеНалоговыеВычетыФизлиц.СрезПоследних(
		|			&парамКонец,
		|			Налогоплательщик = &парамНалогоплательщик
		|			И МесяцНалоговогоПериода МЕЖДУ &парамНачало И &парамКонец) КАК ИПНПлановыеВычеты
		|		ПО ИПНСведенияОДоходах.ФизЛицо = ИПНПлановыеВычеты.ФизЛицо
		|			И ИПНПлановыеВычеты.СуммаВычета <> 0
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ИПНСведенияОДоходах КАК УжеУчтенныеВычеты
		|		ПО ИПНПлановыеВычеты.ФизЛицо = УжеУчтенныеВычеты.ФизЛицо
		|			И ИПНПлановыеВычеты.ВычетИПН = УжеУчтенныеВычеты.ВидРасчета
		|			И ИПНПлановыеВычеты.ДокументОснование = УжеУчтенныеВычеты.ДокументОснование
		|			И УжеУчтенныеВычеты.Налогоплательщик = &парамНалогоплательщик
		|			И УжеУчтенныеВычеты.ПериодРегистрации МЕЖДУ &парамНачало И &парамКонец
		|			И УжеУчтенныеВычеты.Активность
		|ГДЕ
		|	ИПНСведенияОДоходах.ПериодРегистрации = &парамНачало
		|	И ИПНСведенияОДоходах.Организация = &парамОрганизация
		|	И НЕ (ИПНСведенияОДоходах.ВидРасчета ССЫЛКА Справочник.ВычетыИПН)
		|	И УжеУчтенныеВычеты.ФизЛицо ЕСТЬ NULL // только те вычеты, которые еще не были предоставлены в месяце
		|	И ИПНСведенияОДоходах.Активность
		|
		|УПОРЯДОЧИТЬ ПО
		|	ИПНПлановыеВычеты.ФизЛицо.Наименование
		|";
		
		Запрос.Текст = НалоговыеВычетыТекст;
		ТЗНалоговыеВычеты = Запрос.Выполнить().Выгрузить();
		Объект.НалоговыеВычеты.Загрузить(ТЗНалоговыеВычеты);
	КонецЕсли;
	
	// заполнение табличной части "ИсчисленныйИПН"
	
	Если ПредоставлятьВычетВМесяцеОтсутствияДохода Тогда
		ИсчисленныйИПНТекст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	Работники.ФизЛицо,
		|	&парамНачало КАК МесяцНалоговогоПериода
		|ПОМЕСТИТЬ ВТ_РаботникиВрем
		|ИЗ
		|	РегистрНакопления.ИПНСведенияОДоходах КАК ИПНСведенияОДоходах
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
		|		ПО ИПНСведенияОДоходах.ФизЛицо = Работники.ФизЛицо
		|
		|ГДЕ
		|	ИПНСведенияОДоходах.ПериодРегистрации = &парамНачало И
		|	ИПНСведенияОДоходах.Организация = &парамОрганизация И
		|	НЕ (ИПНСведенияОДоходах.ВидРасчета ССЫЛКА Справочник.ВычетыИПН) И
		|	ИПНСведенияОДоходах.Активность
		|	" + ?(ИсключитьДанныеИП, "И ИПНСведенияОДоходах.ФизЛицо <> &парамИндивидуальныйПредприниматель", "") + "        
		|
		|;
		|
		|//////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	Работники.ФизЛицо КАК ФизЛицо,
		|	Работники.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода
		|ИЗ
		|	ВТ_РаботникиВрем КАК Работники
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Работники.ФизЛицо,
		|	&парамНачало КАК МесяцНалоговогоПериода
		|ИЗ
		|	" + СписокРаботниковТекст + " КАК Работники
		|ГДЕ
		|	Работники.ФизЛицо НЕ В(ВЫБРАТЬ РАЗЛИЧНЫЕ Т.ФизЛицо ИЗ ВТ_РаботникиВрем КАК Т)
		|	
		|УПОРЯДОЧИТЬ ПО
		|	ФизЛицо
		|АВТОУПОРЯДОЧИВАНИЕ
		|";
		
		Запрос.Текст = ИсчисленныйИПНТекст;
		ТЗИсчисленныйИПН = Запрос.Выполнить().Выгрузить();
		Объект.ИсчисленныйИПН.Загрузить(ТЗИсчисленныйИПН);
		
		Запрос.Текст = "УНИЧТОЖИТЬ ВТ_РаботникиВрем";
		Запрос.Выполнить();
	Иначе
		ИсчисленныйИПНТекст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	Работники.ФизЛицо,
		|	&парамНачало КАК МесяцНалоговогоПериода
		|ИЗ
		|	РегистрНакопления.ИПНСведенияОДоходах КАК ИПНСведенияОДоходах
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
		|		ПО ИПНСведенияОДоходах.ФизЛицо = Работники.ФизЛицо
		|
		|ГДЕ
		|	ИПНСведенияОДоходах.ПериодРегистрации = &парамНачало И
		|	ИПНСведенияОДоходах.Организация = &парамОрганизация И
		|	НЕ (ИПНСведенияОДоходах.ВидРасчета ССЫЛКА Справочник.ВычетыИПН) И
		|	ИПНСведенияОДоходах.Активность
		|	" + ?(ИсключитьДанныеИП, "И ИПНСведенияОДоходах.ФизЛицо <> &парамИндивидуальныйПредприниматель", "") + "        
		|
		|УПОРЯДОЧИТЬ ПО
		|	Работники.ФизЛицо.Наименование
		|";
		
		////Удалить
		//Запрос.Текст = "Выбрать * из ВТ_Работники КАК Т"; Запрос.Выполнить().Выгрузить();
		
		Запрос.Текст = ИсчисленныйИПНТекст;
		ТЗИсчисленныйИПН = Запрос.Выполнить().Выгрузить();
		Объект.ИсчисленныйИПН.Загрузить(ТЗИсчисленныйИПН);
	КонецЕсли;
	
	// заполнение табличной части "ИсчисленныйОПВ"
	
	// ФизлицаБезПраваНаПенсию
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц не имеющих право на пенсионное обеспечение
	ФизлицаБезПраваНаПенсиюТекст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ГражданствоФизЛиц.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаБезПраваНаПенсию
	|ИЗ
	|	РегистрСведений.ГражданствоФизЛиц.СрезПоследних(&парамКонец) КАК ГражданствоФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО ГражданствоФизЛиц.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	(ГражданствоФизЛиц.НеИмеетПравоНаПенсию)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.ГражданствоФизЛиц.СрезПоследних(&парамКонец) КАК ГражданствоФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО ГражданствоФизЛиц.ФизЛицо = Контрагенты.ФизЛицо
	|
	|ГДЕ
	|	(ГражданствоФизЛиц.НеИмеетПравоНаПенсию)";
	Запрос.Текст = ФизлицаБезПраваНаПенсиюТекст;
	Запрос.Выполнить();
	ФизлицаБезПраваНаПенсиюТекст = "ВТ_ФизлицаБезПраваНаПенсию";
	
	// ФизлицаПенсионеры
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц достигших пенсионный возраст
	ФизлицаПенсионерыТекст = "
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СведенияОПенсионномОбеспеченииФизЛиц.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаПенсионеры
	|ИЗ
	|	РегистрСведений.СведенияОПенсионномОбеспеченииФизЛиц.СрезПоследних(&парамКонец) КАК СведенияОПенсионномОбеспеченииФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО СведенияОПенсионномОбеспеченииФизЛиц.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	(СведенияОПенсионномОбеспеченииФизЛиц.Пенсионер)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.СведенияОПенсионномОбеспеченииФизЛиц.СрезПоследних(&парамКонец) КАК СведенияОПенсионномОбеспеченииФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО СведенияОПенсионномОбеспеченииФизЛиц.ФизЛицо = Контрагенты.ФизЛицо
	|
	|ГДЕ
	|	(СведенияОПенсионномОбеспеченииФизЛиц.Пенсионер)";
	Запрос.Текст = ФизлицаПенсионерыТекст;
	Запрос.Выполнить();
	ФизлицаПенсионерыТекст = "ВТ_ФизлицаПенсионеры";

	// ФизлицаИнвалидыБессрочно
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц-инвалидов I и II группы, у которых инвалидность установлена бессрочно
	ФизлицаИнвалидыБессрочноТекст = "
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СведенияОбИнвалидностиФизлиц.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаИнвалидыБессрочно
	|ИЗ
	|	РегистрСведений.СведенияОбИнвалидностиФизлиц.СрезПоследних(&парамКонец) КАК СведенияОбИнвалидностиФизлиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО СведенияОбИнвалидностиФизлиц.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	СведенияОбИнвалидностиФизлиц.ОтношениеКИнвалидности = &парамИнвалид И
	|	СведенияОбИнвалидностиФизлиц.ГруппаИнвалидности В (&парамСписокГруппИнвалидности) И
	|	СведенияОбИнвалидностиФизлиц.СрокДействияСправки = &парамПустаяДата
	|	И НЕ СведенияОбИнвалидностиФизлиц.ИсчислятьОПВ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
    |ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.СведенияОбИнвалидностиФизлиц.СрезПоследних(&парамКонец) КАК СведенияОбИнвалидностиФизлиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО СведенияОбИнвалидностиФизлиц.ФизЛицо = Контрагенты.ФизЛицо
	|
	|ГДЕ
	|	СведенияОбИнвалидностиФизлиц.ОтношениеКИнвалидности = &парамИнвалид И
	|	СведенияОбИнвалидностиФизлиц.ГруппаИнвалидности В (&парамСписокГруппИнвалидности) И
	|	СведенияОбИнвалидностиФизлиц.СрокДействияСправки = &парамПустаяДата
	|	И НЕ СведенияОбИнвалидностиФизлиц.ИсчислятьОПВ
	|";
	Запрос.Текст = ФизлицаИнвалидыБессрочноТекст;
	Запрос.Выполнить();
	ФизлицаИнвалидыБессрочноТекст = "ВТ_ФизлицаИнвалидыБессрочно";

	ИсчисленныйОПВТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	Работники.ФизЛицо,
	|	&парамНачало КАК МесяцНалоговогоПериода
	|ИЗ
	|	РегистрНакопления.ОПВСведенияОДоходах КАК ОПВСведенияОДоходах
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО ОПВСведенияОДоходах.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	ОПВСведенияОДоходах.ПериодРегистрации = &парамНачало И
	|	ОПВСведенияОДоходах.Организация = &парамОрганизация И
	|	ОПВСведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаПенсионерыТекст + " КАК ФизлицаПенсионеры) И
	|	ОПВСведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаБезПраваНаПенсиюТекст + " КАК ФизлицаБезПраваНаПенсию) И
	|	ОПВСведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаИнвалидыБессрочноТекст + " КАК ФизлицаИнвалидыБессрочно) И
	|	ОПВСведенияОДоходах.Активность
	|	" + ?(ИсключитьДанныеИП И НЕ ЕжемесячныйРасчетВзносовИОтчисленийЗаИП, "И ОПВСведенияОДоходах.ФизЛицо <> &парамИндивидуальныйПредприниматель", "") + "        
	|
	|УПОРЯДОЧИТЬ ПО
	|	Работники.ФизЛицо.Наименование
	|";
	
	Запрос.Текст = ИсчисленныйОПВТекст;
	ТЗИсчисленныйОПВ = Запрос.Выполнить().Выгрузить();
	Объект.ИсчисленныйОПВ.Загрузить(ТЗИсчисленныйОПВ);
	
	// заполнение табличной части "ИсчисленныеВОСМС"
	// ОСМС введены с 1 июля 2017
	
	// ФизлицаИнвалиды
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц-инвалидов
	ФизлицаИнвалидыТекст = "
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СведенияОбИнвалидностиФизлиц.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаИнвалиды
	|ИЗ
	|	РегистрСведений.СведенияОбИнвалидностиФизлиц.СрезПоследних(&парамКонец) КАК СведенияОбИнвалидностиФизлиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО СведенияОбИнвалидностиФизлиц.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	СведенияОбИнвалидностиФизлиц.ОтношениеКИнвалидности = &парамИнвалид 
	|	И (СведенияОбИнвалидностиФизлиц.СрокДействияСправки = &парамПустаяДата ИЛИ КОНЕЦПЕРИОДА(СведенияОбИнвалидностиФизлиц.СрокДействияСправки, МЕСЯЦ) >= &парамКонец)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
    |ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.СведенияОбИнвалидностиФизлиц.СрезПоследних(&парамКонец) КАК СведенияОбИнвалидностиФизлиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО СведенияОбИнвалидностиФизлиц.ФизЛицо = Контрагенты.ФизЛицо
	|
	|ГДЕ
	|	СведенияОбИнвалидностиФизлиц.ОтношениеКИнвалидности = &парамИнвалид 
	|	И (СведенияОбИнвалидностиФизлиц.СрокДействияСправки = &парамПустаяДата ИЛИ КОНЕЦПЕРИОДА(СведенияОбИнвалидностиФизлиц.СрокДействияСправки, МЕСЯЦ) >= &парамКонец)
	|";
	Запрос.Текст = ФизлицаИнвалидыТекст;
	Запрос.Выполнить();
	ФизлицаИнвалидыТекст = "ВТ_ФизлицаИнвалиды";
	
	// ФизлицаУчастникиВОВ
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц участников и инвалидов ВОВ
	ФизлицаУчастникиВОВТекст = "
    |ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СведенияОФизлицахУчастникахВОВ.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаУчастникиВОВ
	|ИЗ
	|	РегистрСведений.СведенияОФизлицахУчастникахВОВ.СрезПоследних(&парамКонец) КАК СведенияОФизлицахУчастникахВОВ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО СведенияОФизлицахУчастникахВОВ.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	СведенияОФизлицахУчастникахВОВ.Статус = ЗНАЧЕНИЕ(Перечисление.КатегорииФизлицУчастниковВОВ.УчастникВОВ)
	|	ИЛИ СведенияОФизлицахУчастникахВОВ.Статус = ЗНАЧЕНИЕ(Перечисление.КатегорииФизлицУчастниковВОВ.ИнвалидВОВ)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.СведенияОФизлицахУчастникахВОВ.СрезПоследних(&парамКонец) КАК СведенияОФизлицахУчастникахВОВ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО СведенияОФизлицахУчастникахВОВ.ФизЛицо = Контрагенты.ФизЛицо
	|
	|ГДЕ
	|	СведенияОФизлицахУчастникахВОВ.Статус = ЗНАЧЕНИЕ(Перечисление.КатегорииФизлицУчастниковВОВ.УчастникВОВ)
	|	ИЛИ СведенияОФизлицахУчастникахВОВ.Статус = ЗНАЧЕНИЕ(Перечисление.КатегорииФизлицУчастниковВОВ.ИнвалидВОВ)
	|";
	Запрос.Текст = ФизлицаУчастникиВОВТекст;
	Запрос.Выполнить();
	ФизлицаУчастникиВОВТекст = "ВТ_ФизлицаУчастникиВОВ";
	
	// ФизлицаБезМедицинскогоСтрахования
	//	Поля:
	//		Физлицо
	//
	//	Описание:
	//	список физлиц не подлежащих медицинскому страхованию
	ФизлицаБезМедицинскогоСтрахованияТекст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ГражданствоФизЛиц.ФизЛицо
	|ПОМЕСТИТЬ ВТ_ФизлицаБезМедицинскогоСтрахования
	|ИЗ
	|	РегистрСведений.ГражданствоФизЛиц.СрезПоследних(&парамКонец, ) КАК ГражданствоФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО ГражданствоФизЛиц.ФизЛицо = Работники.ФизЛицо
	|ГДЕ
	|	ГражданствоФизЛиц.НеПодлежитСоциальномуМедицинскомуСтрахованию
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка
	|ИЗ
	|	РегистрСведений.ГражданствоФизЛиц.СрезПоследних(&парамКонец, ) КАК ГражданствоФизЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО ГражданствоФизЛиц.ФизЛицо = Контрагенты.ФизЛицо
	|ГДЕ
	|	ГражданствоФизЛиц.НеПодлежитСоциальномуМедицинскомуСтрахованию";
	
	Запрос.Текст = ФизлицаБезМедицинскогоСтрахованияТекст;
	Запрос.Выполнить();
	ФизлицаБезМедицинскогоСтрахованияТекст = "ВТ_ФизлицаБезМедицинскогоСтрахования";

	ИсчисленныеВОСМСТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	Работники.ФизЛицо КАК ФизЛицо,
	|	&парамНачало КАК МесяцНалоговогоПериода
	|ИЗ
	|	РегистрНакопления.ВОСМССведенияОДоходах КАК ВОСМССведенияОДоходах
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + СписокРаботниковТекст + " КАК Работники
	|		ПО ВОСМССведенияОДоходах.ФизЛицо = Работники.ФизЛицо
	|
	|ГДЕ
	|	ВОСМССведенияОДоходах.ПериодРегистрации = &парамНачало И
	|	ВОСМССведенияОДоходах.Организация = &парамОрганизация И
	|	ВОСМССведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаПенсионерыТекст + " КАК ФизлицаПенсионеры) И
	|	ВОСМССведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаИнвалидыТекст + " КАК ФизлицаИнвалиды) И
	|	ВОСМССведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаУчастникиВОВТекст + " КАК ФизлицаУчастникиВОВ) И
	|	ВОСМССведенияОДоходах.ФизЛицо НЕ В (ВЫБРАТЬ ФизЛицо ИЗ " + ФизлицаБезМедицинскогоСтрахованияТекст + " КАК ФизлицаБезМедицинскогоСтрахования) И
	|	ВОСМССведенияОДоходах.Активность
	|" + ?(ИсключитьДанныеИП И НЕ ЕжемесячныйРасчетВзносовИОтчисленийЗаИП, " И ВОСМССведенияОДоходах.ФизЛицо <> &парамИндивидуальныйПредприниматель", "") + "
	|
	|УПОРЯДОЧИТЬ ПО
	|	ФизЛицо
	|";
	
	Запрос.Текст = ИсчисленныеВОСМСТекст;
	ТЗИсчисленныеВОСМС = Запрос.Выполнить().Выгрузить();
	Объект.ИсчисленныеВОСМС.Загрузить(ТЗИсчисленныеВОСМС);
	
КонецПроцедуры // Автозаполнение()

// Процедура рассчитывает налоги и взносы.
//
Процедура РассчитатьНалогиИВзносы(Объект, НалоговыеВычетыРассчитаны = Ложь, КомментироватьРасчет = Ложь, СтруктураДополнительныхДанных = Неопределено) Экспорт
	
	Если Не ПроцедурыУправленияПерсоналомСервер.РегламентированныйКалендарьЗаполнен(НачалоМесяца(Объект.ПериодРегистрации), КонецМесяца(Объект.ПериодРегистрации)) Тогда
		Возврат;
	КонецЕсли;

	Отказ = Ложь;
	
	НачатьТранзакцию();
	
	ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
	Движения = ДокументОбъект.Движения;
	
	ПоддержкаРаботыСоСтруктурнымиПодразделениями = ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	
	Если ПоддержкаРаботыСоСтруктурнымиПодразделениями Тогда
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Объект.Организация, 
																		Объект.Организация, 
																		Перечисления.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты);
	Иначе
		Налогоплательщик = Объект.Организация;
	КонецЕсли;
	
	ПризнакиРаспределенияНалогов = УчетнаяПолитикаСервер.ПолучитьПризнакиРаспределенияНалогов(Объект.Организация, Объект.ПериодРегистрации);
	РаспределятьНалогиПоСтруктурнымЕдиницам = ПризнакиРаспределенияНалогов.РаспределятьНалогиПоСтруктурнымЕдиницам; 
	РаспределятьНалогиПоПодразделениямОрганизаций = ПризнакиРаспределенияНалогов.РаспределятьНалогиПоПодразделениямОрганизаций;
	ОтражениеПоПериодуРегистрации = УчетнаяПолитикаСервер.ОтражениеПоПериодуРегистрации(Объект.Организация, Объект.ПериодРегистрации);
	ГоловнаяОрганизация = ОбщегоНазначенияБКВызовСервера.ГоловнаяОрганизацияДляУчетаЗарплаты(Объект.Организация);
	
	//Очистим движения
	НаборОПВРасчетыСФондами = РегистрыНакопления.ОПВРасчетыСФондами.СоздатьНаборЗаписей();
	НаборОПВРасчетыСФондами.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборОПВРасчетыСФондами.Записать();

	НаборВОСМСРасчетыСФондами = РегистрыНакопления.ВОСМСРасчетыСФондами.СоздатьНаборЗаписей();
	НаборВОСМСРасчетыСФондами.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборВОСМСРасчетыСФондами.Записать(); 
	
	НаборСведенияОбИсчисленииВычетовИПН = РегистрыНакопления.СведенияОбИсчисленииВычетовИПН.СоздатьНаборЗаписей();
	НаборСведенияОбИсчисленииВычетовИПН.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборСведенияОбИсчисленииВычетовИПН.Записать();

	Если Объект.ПериодРегистрации < Дата(2018,1,1) И НЕ НалоговыеВычетыРассчитаны Тогда
	
		// удалим старые движения
		Движения.ИПНСведенияОДоходах.Очистить();
		
		ПараметрыРасчета = ПодготовитьПараметрыРасчетаДо2018(Объект, Отказ);
		Если Отказ Тогда
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли;
		
		ТаблицаИПНСведенияОДоходах = РасчетЗарплатыСервер.ПодготовитьТаблицуСведенияОДоходах(ПараметрыРасчета.Реквизиты, 
																							ПараметрыРасчета.ИПНСведенияОДоходах, 
																							"Целиком", 
																							Движения.ИПНСведенияОДоходах.ВыгрузитьКолонки(),
																							Отказ);

		РасчетЗарплатыСервер.СформироватьДвижения(ТаблицаИПНСведенияОДоходах,  	"ИПНСведенияОДоходах",	Движения, Отказ);
		
		Если НЕ Отказ Тогда
			// запишем наборы в базу
			Движения.ИПНСведенияОДоходах.Записать();
		КонецЕсли;
		
	КонецЕсли;
	
	Если Отказ Тогда
		ОтменитьТранзакцию();
		Возврат;
	КонецЕсли;
	
	// Получение результата ОПВ по ставке 10%
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ОПВ
	СписокФизлицТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйОПВ КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор";
	
	ДанныеОПВ = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаОПВ(Неопределено, Объект.ПериодРегистрации, Налогоплательщик, Объект.Ссылка, СписокФизлицТекст);
	Если ДанныеОПВ <> НеОпределено Тогда
		ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымОПВ(Объект.ИсчисленныйОПВ, Объект.ПериодРегистрации, НаборОПВРасчетыСФондами, ДанныеОПВ, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетОПВДополнительныеДанные));
	КонецЕсли;

	НаборОПВРасчетыСФондами.Записать();
	
	// Расчет ВОСМС
	
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ВОСМС
	СписокФизлицТекстВОСМС = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныеВОСМС КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор";
	
	// Расчет вычетов ИПН
	
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ИПН
	СписокФизлицТекстИПН = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйИПН КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор";
	
	Если ПроведениеРасчетовСервер.ПрименятьКорректировкуПрочихНалоговВзносовОтчислений(Объект.Организация, Объект.ПериодРегистрации) Тогда
        
   		ДополнительныеПараметрыЗапроса = Новый Структура;
        Если ПроведениеРасчетовСервер.ПрименятьВычетОПВиВОСМСДляГПХ(Объект.Организация, Объект.ПериодРегистрации) Тогда
            ДополнительныеПараметрыЗапроса.Вставить("ТолькоДоходОтНалоговогоАгента", Истина);
            // получение результата ВОСМС 
            ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, ОтражениеПоПериодуРегистрации, ДополнительныеПараметрыЗапроса);
            Если ДанныеВОСМС <> НеОпределено Тогда
                ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
                // Запишем расчитанный ВОСМС для расчета ИПН и удержаний
                НаборВОСМСРасчетыСФондами.Записать();
            КонецЕсли;
        КонецЕсли;
        
		ДанныеВычетовИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВычетовИПН(Объект.ПериодРегистрации,  Налогоплательщик, ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН);
		Если ДанныеВычетовИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВычетовИПН(Объект.ВычетыИПН, Объект.ПериодРегистрации, НаборСведенияОбИсчисленииВычетовИПН, ДанныеВычетовИПН, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам);
			// Запишем расчитанные вычеты для расчета ИПН
			НаборСведенияОбИсчисленииВычетовИПН.Записать();
		КонецЕсли;
        НаборВОСМСРасчетыСФондами.Очистить();
         
    	// Расчет ИПН
		
		// получение результата ИПН по прогрессивной шкале ставок
		ДанныеИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаИПН(Неопределено, Объект.ПериодРегистрации, Налогоплательщик, ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН);
		Если ДанныеИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымИПН(Объект.ИсчисленныйИПН, Объект.ПериодРегистрации, Неопределено, ДанныеИПН, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам,?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетИПНДополнительныеДанные));
		КонецЕсли;

		ДополнительныеПараметрыЗапроса.Вставить("ИсчисленныйИПН", Объект.ИсчисленныйИПН.Выгрузить()); 
        
        ДополнительныеПараметрыЗапроса.Удалить("ТолькоДоходОтНалоговогоАгента");
		// получение результата ВОСМС 
		ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, ОтражениеПоПериодуРегистрации, ДополнительныеПараметрыЗапроса);
		Если ДанныеВОСМС <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
			// Запишем расчитанный ВОСМС для расчета ИПН и удержаний
			НаборВОСМСРасчетыСФондами.Записать();
		КонецЕсли;
		
	Иначе

		// получение результата ВОСМС 
		ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, ОтражениеПоПериодуРегистрации);
		Если ДанныеВОСМС <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
			// Запишем расчитанный ВОСМС для расчета ИПН и удержаний
			НаборВОСМСРасчетыСФондами.Записать();
		КонецЕсли;
		
		ДанныеВычетовИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВычетовИПН(Объект.ПериодРегистрации,  Налогоплательщик, ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН);
		Если ДанныеВычетовИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВычетовИПН(Объект.ВычетыИПН, Объект.ПериодРегистрации, НаборСведенияОбИсчисленииВычетовИПН, ДанныеВычетовИПН, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам);
			// Запишем расчитанные вычеты для расчета ИПН
			НаборСведенияОбИсчисленииВычетовИПН.Записать();
		КонецЕсли;
		
		// Расчет ИПН
		
		// получение результата ИПН по прогрессивной шкале ставок
		ДанныеИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаИПН(Неопределено, Объект.ПериодРегистрации, Налогоплательщик, ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН);
		Если ДанныеИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымИПН(Объект.ИсчисленныйИПН, Объект.ПериодРегистрации, Неопределено, ДанныеИПН, Налогоплательщик, Объект.Организация, ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, , , НЕ РаспределятьНалогиПоСтруктурнымЕдиницам,?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетИПНДополнительныеДанные));
		КонецЕсли;
		
	КонецЕсли;

	// Удаляем движения
	НаборОПВРасчетыСФондами.Очистить();
	НаборОПВРасчетыСФондами.Записать();
	
	НаборВОСМСРасчетыСФондами.Очистить();
	НаборВОСМСРасчетыСФондами.Записать();

	НаборСведенияОбИсчисленииВычетовИПН.Очистить();
	НаборСведенияОбИсчисленииВычетовИПН.Записать();
	
	Если Объект.ПериодРегистрации < Дата(2018,1,1) И НЕ НалоговыеВычетыРассчитаны Тогда
		Движения.ИПНСведенияОДоходах.Очистить();
		Движения.ИПНСведенияОДоходах.Записать();
	КонецЕсли;
	
	// Завершаем транзакцию
	ЗафиксироватьТранзакцию();	

КонецПроцедуры // РассчитатьНалогиИВзносы()

// Процедура рассчитывает ресурсы удержаний. 
//
Процедура РассчитатьУдержания(Объект, ИПНиОПВРассчитаны = Ложь, Физлицо = Неопределено, КомментироватьРасчет = Ложь) Экспорт
	
	Отказ = Ложь;
	
	НачатьТранзакцию();
	
	ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
	Движения = ДокументОбъект.Движения;
	
	Если Не ИПНиОПВРассчитаны Тогда
		// сначала удалим существующие движения
		Движения.ИПНРасчетыСБюджетом.Очистить();
		Движения.ИПНРасчетыСБюджетом.Записать();
		
		Движения.ОПВРасчетыСФондами.Очистить();
		Движения.ОПВРасчетыСФондами.Записать();
		
		Движения.ВОСМСРасчетыСФондами.Очистить();
		Движения.ВОСМСРасчетыСФондами.Записать();

		ПараметрыПроведения = ПодготовитьПараметрыПроведения(Объект.Ссылка, Отказ);
		Если Отказ Тогда
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли;

		РасчетЗарплатыСервер.СформироватьДвиженияИПНРасчетыСБюджетом(ПараметрыПроведения.Реквизиты[0], ПараметрыПроведения.ИсчисленныйИПН, Движения, Отказ, Ложь);
		
		ТаблицаИсчисленныйОПВ = РасчетЗарплатыСервер.ПодготовитьТаблицуИсчисленныхНалоговВзносовОтчислений(ПараметрыПроведения.Реквизиты[0], 
																						ПараметрыПроведения.ИсчисленныйОПВ,
																						Движения.ОПВРасчетыСФондами.ВыгрузитьКолонки(),
																						Отказ);

		РасчетЗарплатыСервер.СформироватьДвижения(ТаблицаИсчисленныйОПВ,  	"ОПВРасчетыСФондами",  	Движения, Отказ);

		ТаблицаИсчисленныеВОСМС = РасчетЗарплатыСервер.ПодготовитьТаблицуИсчисленныхНалоговВзносовОтчислений(ПараметрыПроведения.Реквизиты[0], 
																						ПараметрыПроведения.ИсчисленныеВОСМС,
																						Движения.ВОСМСРасчетыСФондами.ВыгрузитьКолонки(),
																						Отказ);

		РасчетЗарплатыСервер.СформироватьДвижения(ТаблицаИсчисленныеВОСМС,  "ВОСМСРасчетыСФондами",  	Движения, Отказ);

		// запишем наборы в базу
		Движения.ИПНРасчетыСБюджетом.Записать();
		Движения.ОПВРасчетыСФондами.Записать();
		Движения.ВОСМСРасчетыСФондами.Записать();
	КонецЕсли;
	
	Если Отказ Тогда
		ОтменитьТранзакцию();
		Возврат;
	КонецЕсли; 

	ПроведениеРасчетовСервер.РассчитатьДокумент("УдержанияОрганизаций", 
												"РасчетУдержанийРаботниковОрганизаций",
												"Удержания", 
												Объект, 
												ФизЛицо,
												КомментироватьРасчет);
	
	Если Не ИПНиОПВРассчитаны Тогда
		// Удаляем движения
		
		Движения.ИПНРасчетыСБюджетом.Очистить();
		Движения.ИПНРасчетыСБюджетом.Записать();
		
		Движения.ОПВРасчетыСФондами.Очистить();
		Движения.ОПВРасчетыСФондами.Записать();
		
		Движения.ВОСМСРасчетыСФондами.Очистить();
		Движения.ВОСМСРасчетыСФондами.Записать();
	КонецЕсли;
	
	// Завершаем транзакцию
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры // РассчитатьУдержания()

// Процедура рассчитывает жилищные, страховые налоговые вычеты.
//
Процедура РассчитатьНалоговыеВычеты(Объект, Физлицо = Неопределено, КомментироватьРасчет = Ложь, КомментарийВидаРасчета = Неопределено) Экспорт 
	
	Если Объект.ПериодРегистрации >= Дата(2018, 1, 1) Тогда
		// Логика расчета вычетов в 2018 году изменена
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;

	Запрос.УстановитьПараметр("парамРегистратор", Объект.Ссылка);
	Запрос.УстановитьПараметр("парамКонец", КонецМесяца(Объект.ПериодРегистрации));
	
	ПоддержкаРаботыСоСтруктурнымиПодразделениями = ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	
	Если ПоддержкаРаботыСоСтруктурнымиПодразделениями Тогда
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Объект.Организация,
																		Объект.Организация,
																		Перечисления.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты);
	Иначе
		Налогоплательщик = Объект.Организация;
	КонецЕсли;

	НалоговыеВычеты = Объект.НалоговыеВычеты;
	
	Запрос.УстановитьПараметр("парамНалогоплательщик", Налогоплательщик);
	Запрос.УстановитьПараметр("парамФизЛицо", ФизЛицо);
	
	НалоговыеВычетыТекст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СтрокиТЧ.НомерСтроки,
	|	СтрокиТЧ.ФизЛицо,
	|	НАЧАЛОПЕРИОДА(СтрокиТЧ.МесяцНалоговогоПериода, МЕСЯЦ) КАК МесяцНалоговогоПериода,
	|	СтрокиТЧ.ВычетИПН,
	|	СтрокиТЧ.ДокументОснование
	|
	|ПОМЕСТИТЬ ВТНалоговыеВычеты
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.НалоговыеВычеты КАК СтрокиТЧ
	|ГДЕ
	|	СтрокиТЧ.Ссылка = &парамРегистратор
	|	" + ?(ФизЛицо <> Неопределено, "И ФизЛицо В (&парамФизЛицо)", "") + "
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтрокиТЧ.ФизЛицо,
	|	НАЧАЛОПЕРИОДА(СтрокиТЧ.МесяцНалоговогоПериода, МЕСЯЦ),
	|	СтрокиТЧ.ВычетИПН,
	|	СтрокиТЧ.ДокументОснование
	|";
	
	Запрос.Текст = НалоговыеВычетыТекст;
	Запрос.Выполнить();
	НалоговыеВычетыТекст = "ВТНалоговыеВычеты";
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СтрокиТЧ.НомерСтроки,
	|	ИПНПлановыеВычеты.ФизЛицо,
	|	НАЧАЛОПЕРИОДА(ИПНПлановыеВычеты.МесяцНалоговогоПериода, МЕСЯЦ) КАК МесяцНалоговогоПериода,
	|	ИПНПлановыеВычеты.ВычетИПН,
	|	ИПНПлановыеВычеты.ВычетИПН.Наименование КАК ВычетИПННаименование,
	|	ИПНПлановыеВычеты.ДокументОснование,
	|	ЕСТЬNULL(ИПНПлановыеВычеты.СуммаВычета, 0) КАК ПредоставляемыйВычет,
	|	ЕСТЬNULL(РанееПредоставленныеВычеты.СуммаВычета, 0) КАК УжеПредоставленоВычетов,
	|	ИПНПлановыеВычеты.СуммаВычета - ЕСТЬNULL(РанееПредоставленныеВычеты.СуммаВычета, 0) КАК СуммаВычета
	|ИЗ
	|	" + НалоговыеВычетыТекст + " КАК СтрокиТЧ
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ИПНПлановыеНалоговыеВычетыФизЛиц.СрезПоследних(
	|				&парамКонец,
	|				Налогоплательщик = &парамНалогоплательщик
	|				" + ?(ФизЛицо <> Неопределено, "И ФизЛицо В (&парамФизЛицо)", "") + ") КАК ИПНПлановыеВычеты
	|		ПО СтрокиТЧ.ФизЛицо = ИПНПлановыеВычеты.ФизЛицо
	|			И СтрокиТЧ.МесяцНалоговогоПериода = НАЧАЛОПЕРИОДА(ИПНПлановыеВычеты.МесяцНалоговогоПериода, МЕСЯЦ)
	|			И СтрокиТЧ.ВычетИПН = ИПНПлановыеВычеты.ВычетИПН
	|			И СтрокиТЧ.ДокументОснование = ИПНПлановыеВычеты.ДокументОснование
	|
	|	// вычтем ранее предоставленные вычеты по соответствующему документу-основанию
	|	ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|							РанееПредоставленныеВычеты.ФизЛицо,
	|							НАЧАЛОПЕРИОДА(РанееПредоставленныеВычеты.Период, МЕСЯЦ) КАК МесяцНалоговогоПериода,
	|							РанееПредоставленныеВычеты.ВидРасчета КАК ВычетИПН,
	|							РанееПредоставленныеВычеты.ДокументОснование,
	|							СУММА(РанееПредоставленныеВычеты.СуммаВычета) КАК СуммаВычета
	|						ИЗ
	|							РегистрНакопления.ИПНСведенияОДоходах КАК РанееПредоставленныеВычеты
	|							ВНУТРЕННЕЕ СОЕДИНЕНИЕ " + НалоговыеВычетыТекст + " КАК СтрокиТЧ
	|								ПО РанееПредоставленныеВычеты.ФизЛицо = СтрокиТЧ.ФизЛицо
	|									И РанееПредоставленныеВычеты.ВидРасчета = СтрокиТЧ.ВычетИПН
	|									И РанееПредоставленныеВычеты.ДокументОснование = СтрокиТЧ.ДокументОснование
	|									И РанееПредоставленныеВычеты.Период МЕЖДУ СтрокиТЧ.МесяцНалоговогоПериода И КОНЕЦПЕРИОДА(СтрокиТЧ.МесяцНалоговогоПериода, МЕСЯЦ)
	|						ГДЕ
	|							РанееПредоставленныеВычеты.Налогоплательщик = &парамНалогоплательщик
	|							И РанееПредоставленныеВычеты.Активность
	|							" + ?(ФизЛицо <> Неопределено, "И РанееПредоставленныеВычеты.ФизЛицо В (&парамФизЛицо)", "") + "
	|						СГРУППИРОВАТЬ ПО
	|							РанееПредоставленныеВычеты.ФизЛицо,
	|							НАЧАЛОПЕРИОДА(РанееПредоставленныеВычеты.Период, МЕСЯЦ),
	|							РанееПредоставленныеВычеты.ВидРасчета,
	|							РанееПредоставленныеВычеты.ДокументОснование) КАК РанееПредоставленныеВычеты
	|		ПО СтрокиТЧ.ФизЛицо = РанееПредоставленныеВычеты.ФизЛицо
	|			И СтрокиТЧ.МесяцНалоговогоПериода = РанееПредоставленныеВычеты.МесяцНалоговогоПериода
	|			И СтрокиТЧ.ВычетИПН = РанееПредоставленныеВычеты.ВычетИПН
	|			И СтрокиТЧ.ДокументОснование = РанееПредоставленныеВычеты.ДокументОснование
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИПНПлановыеВычеты.ФизЛицо.Наименование
	|";	

	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СтрокаТЧ = НалоговыеВычеты[Выборка.НомерСтроки - 1];
		СтрокаТЧ.СуммаВычета = Выборка.СуммаВычета; 
		
	КонецЦикла;    
	
КонецПроцедуры // РассчитатьНалоговыеВычеты()

// Процедура рассчитывает все табличные части документа.
//
Процедура Рассчитать(Объект, Физлицо = Неопределено, КомментироватьРасчет = Ложь, СтруктураДополнительныхДанных = Неопределено) Экспорт
	
	Если Не ПроцедурыУправленияПерсоналомСервер.РегламентированныйКалендарьЗаполнен(НачалоМесяца(Объект.ПериодРегистрации), КонецМесяца(Объект.ПериодРегистрации)) Тогда
		Возврат;
	КонецЕсли;

	Отказ = Ложь;

	// расчет связан с записью документа и его движений, поэтому выполняется в транзакции
	НачатьТранзакцию();
	
	ПоддержкаРаботыСоСтруктурнымиПодразделениями = ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	
	Если ПоддержкаРаботыСоСтруктурнымиПодразделениями Тогда
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Объект.Организация, 
																		Объект.Организация, 
																		Перечисления.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты);
	Иначе
		Налогоплательщик = Объект.Организация;
	КонецЕсли;

	ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
	
	Если НЕ ДокументОбъект.ПроверитьЗаполнение() Тогда
		ОтменитьТранзакцию();
		Возврат;
	КонецЕсли;
	
	Движения = ДокументОбъект.Движения;
	
	// ИПНРасчетыСБюджетом
	НаборИПНРасчетыСБюджетом = РегистрыНакопления.ИПНРасчетыСБюджетом.СоздатьНаборЗаписей();
	НаборИПНРасчетыСБюджетом.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборИПНРасчетыСБюджетом.Записать();
	
	// ОПВРасчетыСФондами
	НаборОПВРасчетыСФондами = РегистрыНакопления.ОПВРасчетыСФондами.СоздатьНаборЗаписей();
	НаборОПВРасчетыСФондами.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборОПВРасчетыСФондами.Записать();
	
	// ВОСМСРасчетыСФондами
	НаборВОСМСРасчетыСФондами = РегистрыНакопления.ВОСМСРасчетыСФондами.СоздатьНаборЗаписей();
	НаборВОСМСРасчетыСФондами.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборВОСМСРасчетыСФондами.Записать();
	
	// СведенияОбИсчисленииВычетовИПН
	НаборСведенияОбИсчисленииВычетовИПН = РегистрыНакопления.СведенияОбИсчисленииВычетовИПН.СоздатьНаборЗаписей();
	НаборСведенияОбИсчисленииВычетовИПН.Отбор.Регистратор.Значение = Объект.Ссылка;
	НаборСведенияОбИсчисленииВычетовИПН.Записать();

	КомментарийИПН = Неопределено;
	// чтобы налоговые вычеты попали в ветку комментария ИПН - создадим ее уже сейчас
	                                          
	Если Объект.ПериодРегистрации < Дата(2018,1,1) Тогда
		// Рассчитаем налоговые вычеты
		РассчитатьНалоговыеВычеты(Объект, ФизЛицо, КомментироватьРасчет, КомментарийИПН);

		ПараметрыРасчета = ПодготовитьПараметрыРасчетаДо2018(Объект, Отказ);
		Если Отказ Тогда
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли;
		
		Реквизиты = ПараметрыРасчета.Реквизиты;
		
		ТаблицаИПНСведенияОДоходах = РасчетЗарплатыСервер.ПодготовитьТаблицуСведенияОДоходах(Реквизиты,
																							ПараметрыРасчета.ИПНСведенияОДоходах, 
																							"Целиком", 
																							Движения.ИПНСведенияОДоходах.ВыгрузитьКолонки(),
																							Отказ);

		РасчетЗарплатыСервер.СформироватьДвижения(ТаблицаИПНСведенияОДоходах,  	"ИПНСведенияОДоходах",	Движения, Отказ);
	
		Если Отказ Тогда
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли; 
		
		// запишем набор записей с налоговыми вычетами
		Движения.ИПНСведенияОДоходах.Записать();
	
	Иначе
		ПараметрыРасчета = ПодготовитьПараметрыРасчетаПосле2018(Объект, Отказ);
		
		Если Отказ Тогда
			ОтменитьТранзакцию();
			Возврат;
		КонецЕсли;
		
		Реквизиты = ПараметрыРасчета.Реквизиты;
	КонецЕсли;
	
	// Расчет ОПВ
	
	// Получение результата ОПВ по ставке 10%
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ОПВ
	СписокФизлицТекст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйОПВ КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор
	|	" + ?(ФизЛицо <> Неопределено, "И Работники.ФизЛицо В (&парамФизЛицо)", "");
	
	ДополнительныеПараметрыЗапроса = Новый Структура();
	ДополнительныеПараметрыЗапроса.Вставить("парамФизЛицо", ФизЛицо);
	
	ДанныеОПВ = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаОПВ(Неопределено, Объект.ПериодРегистрации, Налогоплательщик, Объект.Ссылка, СписокФизлицТекст, ДополнительныеПараметрыЗапроса);
	Если ДанныеОПВ <> НеОпределено Тогда
		ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымОПВ(Объект.ИсчисленныйОПВ, Объект.ПериодРегистрации, НаборОПВРасчетыСФондами, ДанныеОПВ, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетОПВДополнительныеДанные));
		// Запишем расчитанный ОПВ для расчета ИПН и удержаний
		НаборОПВРасчетыСФондами.Записать();
	КонецЕсли;
	
	// Расчет ВОСМС
	
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ВОСМС
	СписокФизлицТекстВОСМС = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныеВОСМС КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор
	|	" + ?(ФизЛицо <> Неопределено, "И Работники.ФизЛицо В (&парамФизЛицо)", "");
	
	// Расчет вычетов ИПН
	
	// Составим текст запроса для выбора списка физлиц, по которым надо считать ИПН
	СписокФизлицТекстИПН = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Работники.Физлицо КАК Физлицо
	|ИЗ
	|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйИПН КАК Работники
	|
	|ГДЕ
	|	Работники.Ссылка = &парамРегистратор
	|	" + ?(ФизЛицо <> Неопределено, "И Работники.ФизЛицо В (&парамФизЛицо)", "");
	
	
	Если ПроведениеРасчетовСервер.ПрименятьКорректировкуПрочихНалоговВзносовОтчислений(Объект.Организация, Объект.ПериодРегистрации) Тогда
        
        Если ПроведениеРасчетовСервер.ПрименятьВычетОПВиВОСМСДляГПХ(Объект.Организация, Объект.ПериодРегистрации) Тогда
            ДополнительныеПараметрыЗапроса.Вставить("ТолькоДоходОтНалоговогоАгента", Истина);
            // получение результата ВОСМС 
            ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, Реквизиты.ОтражениеПоПериодуРегистрации, ДополнительныеПараметрыЗапроса);
            Если ДанныеВОСМС <> НеОпределено Тогда
                ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, ФизЛицо, Ложь, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
                // Запишем расчитанный ВОСМС для расчета ИПН и удержаний
                НаборВОСМСРасчетыСФондами.Записать();
            КонецЕсли;
        КонецЕсли;

		ДанныеВычетовИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВычетовИПН(Объект.ПериодРегистрации,  Налогоплательщик, Реквизиты.ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН, ДополнительныеПараметрыЗапроса);
		Если ДанныеВычетовИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВычетовИПН(Объект.ВычетыИПН, Объект.ПериодРегистрации, НаборСведенияОбИсчисленииВычетовИПН, ДанныеВычетовИПН, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, КомментарийИПН, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам);
			// Запишем расчитанные вычеты для расчета ИПН
			НаборСведенияОбИсчисленииВычетовИПН.Записать();
        КонецЕсли;
        НаборВОСМСРасчетыСФондами.Очистить();

		// Расчет ИПН
		
		// получение результата ИПН
		ДанныеИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаИПН(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Реквизиты.ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН, ДополнительныеПараметрыЗапроса);
		Если ДанныеИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымИПН(Объект.ИсчисленныйИПН, Объект.ПериодРегистрации, НаборИПНРасчетыСБюджетом, ДанныеИПН, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, КомментарийИПН, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетИПНДополнительныеДанные));
			// Запишем расчитанный ИПН для расчета удержаний
			НаборИПНРасчетыСБюджетом.Записать();
		КонецЕсли;
		
		ДополнительныеПараметрыЗапроса.Вставить("ИсчисленныйИПН", Объект.ИсчисленныйИПН.Выгрузить()); 
        
        ДополнительныеПараметрыЗапроса.Удалить("ТолькоДоходОтНалоговогоАгента");
		// получение результата ВОСМС 
		ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, Реквизиты.ОтражениеПоПериодуРегистрации, ДополнительныеПараметрыЗапроса);
		Если ДанныеВОСМС <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
			// Запишем расчитанный ВОСМС для расчета ИПН и удержаний
			НаборВОСМСРасчетыСФондами.Записать();
		КонецЕсли;
		
	Иначе
		
		// получение результата ВОСМС 
		ДанныеВОСМС = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВОСМС(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Объект.Ссылка, СписокФизлицТекстВОСМС, Реквизиты.ОтражениеПоПериодуРегистрации, ДополнительныеПараметрыЗапроса);
		Если ДанныеВОСМС <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВОСМС(Объект.ИсчисленныеВОСМС, Объект.ПериодРегистрации, НаборВОСМСРасчетыСФондами, ДанныеВОСМС, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетВОСМСДополнительныеДанные));
			// Запишем расчитанный ВОСМС для расчета ИПН и удержаний
			НаборВОСМСРасчетыСФондами.Записать();
		КонецЕсли;
		
		ДанныеВычетовИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаВычетовИПН(Объект.ПериодРегистрации,  Налогоплательщик, Реквизиты.ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН, ДополнительныеПараметрыЗапроса);
		Если ДанныеВычетовИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымВычетовИПН(Объект.ВычетыИПН, Объект.ПериодРегистрации, НаборСведенияОбИсчисленииВычетовИПН, ДанныеВычетовИПН, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, КомментарийИПН, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам);
			// Запишем расчитанные вычеты для расчета ИПН
			НаборСведенияОбИсчисленииВычетовИПН.Записать();
		КонецЕсли;
		
		// Расчет ИПН
		
		// получение результата ИПН
		ДанныеИПН = ПроведениеРасчетовСервер.ПолучитьДанныеДляРасчетаИПН(Неопределено, Объект.ПериодРегистрации,  Налогоплательщик, Реквизиты.ГоловнаяОрганизация, Объект.Ссылка, СписокФизлицТекстИПН, ДополнительныеПараметрыЗапроса);
		Если ДанныеИПН <> НеОпределено Тогда
			ПроведениеРасчетовСервер.ЗаполнитьНаборЗаписейПоДаннымИПН(Объект.ИсчисленныйИПН, Объект.ПериодРегистрации, НаборИПНРасчетыСБюджетом, ДанныеИПН, Налогоплательщик, Объект.Организация, Реквизиты.ОтражениеПоПериодуРегистрации, , КомментироватьРасчет, КомментарийИПН, ФизЛицо, НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам, ?(СтруктураДополнительныхДанных = Неопределено, Неопределено, СтруктураДополнительныхДанных.РасчетИПНДополнительныеДанные));
			// Запишем расчитанный ИПН для расчета удержаний
			НаборИПНРасчетыСБюджетом.Записать();
		КонецЕсли;

	КонецЕсли;
	
	
	// удержания - в последнюю очередь
	РассчитатьУдержания(Объект, Истина, ФизЛицо, КомментироватьРасчет);
	
	// Удаляем движения
	
	Движения.ИПНСведенияОДоходах.Очистить();
	Движения.ИПНСведенияОДоходах.Записать();
	
	НаборИПНРасчетыСБюджетом.Очистить();
	НаборИПНРасчетыСБюджетом.Записать();
	
	НаборОПВРасчетыСФондами.Очистить();
	НаборОПВРасчетыСФондами.Записать();
	
	НаборВОСМСРасчетыСФондами.Очистить();
	НаборВОСМСРасчетыСФондами.Записать();
	
	НаборСведенияОбИсчисленииВычетовИПН.Очистить();
	НаборСведенияОбИсчисленииВычетовИПН.Записать();

	// Завершаем транзакцию
	ЗафиксироватьТранзакцию();	
	
КонецПроцедуры // Рассчитать()

////////////////////////////////////////////////////////////////////////////////
// Расчет

Функция ПодготовитьПараметрыРасчетаДо2018(Объект, Отказ)
	
	ПараметрыРасчета = Новый Структура;
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("НалоговыеВычеты", Объект.НалоговыеВычеты.Выгрузить());
	Запрос.УстановитьПараметр("Период", Объект.ПериодРегистрации);
	
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Реквизиты.Дата,
		|	Реквизиты.Организация,
		|	Реквизиты.СтруктурноеПодразделение,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.Ссылка,
		|	Реквизиты.ПодразделениеОрганизации,
		|	Реквизиты.ПодразделениеОрганизации.ЯвляетсяСтруктурнымПодразделением
		|ПОМЕСТИТЬ ВТ_ДанныеДокумента
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций КАК Реквизиты
		|ГДЕ
		|	Реквизиты.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.СтруктурноеПодразделение,
		|	ДанныеДокумента.ПериодРегистрации,
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.ПодразделениеОрганизации,
		|	ДанныеДокумента.ПодразделениеОрганизацииЯвляетсяСтруктурнымПодразделением,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(УчетнаяПолитикаПоПерсоналуОрганизаций.ВестиУчетПоГоловнойОрганизации, ИСТИНА)
		|			ТОГДА ВЫБОР
		|					КОГДА ДанныеДокумента.Организация.ГоловнаяОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|						ТОГДА ДанныеДокумента.Организация
		|					ИНАЧЕ ДанныеДокумента.Организация.ГоловнаяОрганизация
		|				КОНЕЦ
		|		ИНАЧЕ ДанныеДокумента.Организация
		|	КОНЕЦ КАК ГоловнаяОрганизация,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.РаспределятьНалогиПоСтруктурнымЕдиницам, ЛОЖЬ) КАК РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.РаспределятьНалогиПоПодразделениямОрганизаций, ЛОЖЬ) КАК РаспределятьНалогиПоПодразделениямОрганизаций,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.ОтражениеПоПериодуРегистрации, ЛОЖЬ) КАК ОтражениеПоПериодуРегистрации
		|ПОМЕСТИТЬ ВТ_Реквизиты
		|ИЗ
		|	ВТ_ДанныеДокумента КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаПоПерсоналуОрганизаций КАК УчетнаяПолитикаПоПерсоналуОрганизаций
		|		ПО ДанныеДокумента.Организация = УчетнаяПолитикаПоПерсоналуОрганизаций.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&Период, ) КАК УчетнаяПолитикаНалоговыйУчет
		|		ПО ДанныеДокумента.Организация = УчетнаяПолитикаНалоговыйУчет.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НалоговыеВычеты.НомерСтроки,
		|	НалоговыеВычеты.ФизЛицо,
		|	НалоговыеВычеты.ВычетИПН,
		|	НалоговыеВычеты.ДокументОснование,
		|	НалоговыеВычеты.МесяцНалоговогоПериода,
		|	НалоговыеВычеты.СуммаВычета
		|ПОМЕСТИТЬ ВТ_НалоговыеВычеты
		|ИЗ
		|	&НалоговыеВычеты КАК НалоговыеВычеты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Реквизиты.Дата,
		|	Реквизиты.Организация,
		|	Реквизиты.СтруктурноеПодразделение,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.Ссылка,
		|	Реквизиты.ПодразделениеОрганизации,
		|	Реквизиты.ПодразделениеОрганизацииЯвляетсяСтруктурнымПодразделением,
		|	Реквизиты.ГоловнаяОрганизация,
		|	Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций,
		|	Реквизиты.ОтражениеПоПериодуРегистрации
		|ИЗ
		|	ВТ_Реквизиты КАК Реквизиты";
		
	Результат = Запрос.Выполнить();
	Реквизиты = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(Результат.Выгрузить()[0]);
	ПараметрыРасчета.Вставить("Реквизиты", Реквизиты);
	
	Запрос.УстановитьПараметр("ПериодРегистрации", Реквизиты.ПериодРегистрации);	
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчетСрезПоследних.ОтражениеПоПериодуРегистрации, ИСТИНА)
		|			ТОГДА НАЧАЛОПЕРИОДА(Реквизиты.ПериодРегистрации, МЕСЯЦ)
		|		ИНАЧЕ НалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период,
		|	НАЧАЛОПЕРИОДА(Реквизиты.ПериодРегистрации, МЕСЯЦ) КАК ПериодРегистрации,
		|	Реквизиты.Организация КАК Налогоплательщик,
		|	Реквизиты.Организация КАК Организация,
		|	НалоговыеВычеты.ФизЛицо,
		|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
		|	НалоговыеВычеты.ВычетИПН КАК ВидРасчета,
		|	0 КАК СуммаДохода,
		|	НалоговыеВычеты.СуммаВычета КАК СуммаВычета,
		|	НалоговыеВычеты.ДокументОснование КАК ДокументОснование,
		|	Реквизиты.Организация КАК СтруктурнаяЕдиница,
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|ИЗ
		|	ВТ_НалоговыеВычеты КАК НалоговыеВычеты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&ПериодРегистрации, ) КАК УчетнаяПолитикаНалоговыйУчетСрезПоследних
		|			ПО Реквизиты.Организация = УчетнаяПолитикаНалоговыйУчетСрезПоследних.Организация
		|		ПО (ИСТИНА)";
	

	Результат = Запрос.Выполнить();	
	ПараметрыРасчета.Вставить("ИПНСведенияОДоходах", Результат.Выгрузить());
	
	Возврат ПараметрыРасчета;
	
КонецФункции

Функция ПодготовитьПараметрыРасчетаПосле2018(Объект, Отказ)
	
	ПараметрыРасчета = Новый Структура;
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Период", Объект.ПериодРегистрации);
	
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Реквизиты.Дата,
		|	Реквизиты.Организация,
		|	Реквизиты.СтруктурноеПодразделение,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.Ссылка,
		|	Реквизиты.ПодразделениеОрганизации,
		|	Реквизиты.ПодразделениеОрганизации.ЯвляетсяСтруктурнымПодразделением
		|ПОМЕСТИТЬ ВТ_ДанныеДокумента
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций КАК Реквизиты
		|ГДЕ
		|	Реквизиты.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.СтруктурноеПодразделение,
		|	ДанныеДокумента.ПериодРегистрации,
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.ПодразделениеОрганизации,
		|	ДанныеДокумента.ПодразделениеОрганизацииЯвляетсяСтруктурнымПодразделением,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(УчетнаяПолитикаПоПерсоналуОрганизаций.ВестиУчетПоГоловнойОрганизации, ИСТИНА)
		|			ТОГДА ВЫБОР
		|					КОГДА ДанныеДокумента.Организация.ГоловнаяОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|						ТОГДА ДанныеДокумента.Организация
		|					ИНАЧЕ ДанныеДокумента.Организация.ГоловнаяОрганизация
		|				КОНЕЦ
		|		ИНАЧЕ ДанныеДокумента.Организация
		|	КОНЕЦ КАК ГоловнаяОрганизация,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.РаспределятьНалогиПоСтруктурнымЕдиницам, ЛОЖЬ) КАК РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.РаспределятьНалогиПоПодразделениямОрганизаций, ЛОЖЬ) КАК РаспределятьНалогиПоПодразделениямОрганизаций,
		|	ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчет.ОтражениеПоПериодуРегистрации, ЛОЖЬ) КАК ОтражениеПоПериодуРегистрации
		|ПОМЕСТИТЬ ВТ_Реквизиты
		|ИЗ
		|	ВТ_ДанныеДокумента КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаПоПерсоналуОрганизаций КАК УчетнаяПолитикаПоПерсоналуОрганизаций
		|		ПО ДанныеДокумента.Организация = УчетнаяПолитикаПоПерсоналуОрганизаций.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&Период, ) КАК УчетнаяПолитикаНалоговыйУчет
		|		ПО ДанныеДокумента.Организация = УчетнаяПолитикаНалоговыйУчет.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Реквизиты.Дата,
		|	Реквизиты.Организация,
		|	Реквизиты.СтруктурноеПодразделение,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.Ссылка,
		|	Реквизиты.ПодразделениеОрганизации,
		|	Реквизиты.ПодразделениеОрганизацииЯвляетсяСтруктурнымПодразделением,
		|	Реквизиты.ГоловнаяОрганизация,
		|	Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций,
		|	Реквизиты.ОтражениеПоПериодуРегистрации
		|ИЗ
		|	ВТ_Реквизиты КАК Реквизиты";
		
	Результат = Запрос.Выполнить();
	Реквизиты = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(Результат.Выгрузить()[0]);
	ПараметрыРасчета.Вставить("Реквизиты", Реквизиты);
	
	//Запрос.УстановитьПараметр("ПериодРегистрации", Реквизиты.ПериодРегистрации);	
	//Запрос.Текст = 
	//	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	//	|	ВЫБОР
	//	|		КОГДА ЕСТЬNULL(УчетнаяПолитикаНалоговыйУчетСрезПоследних.ОтражениеПоПериодуРегистрации, ИСТИНА)
	//	|			ТОГДА НАЧАЛОПЕРИОДА(Реквизиты.ПериодРегистрации, МЕСЯЦ)
	//	|		ИНАЧЕ НалоговыеВычеты.МесяцНалоговогоПериода
	//	|	КОНЕЦ КАК Период,
	//	|	НАЧАЛОПЕРИОДА(Реквизиты.ПериодРегистрации, МЕСЯЦ) КАК ПериодРегистрации,
	//	|	Реквизиты.Организация КАК Налогоплательщик,
	//	|	Реквизиты.Организация КАК Организация,
	//	|	НалоговыеВычеты.ФизЛицо,
	//	|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
	//	|	НалоговыеВычеты.ВычетИПН КАК ВидРасчета,
	//	|	0 КАК СуммаДохода,
	//	|	НалоговыеВычеты.СуммаВычета КАК СуммаВычета,
	//	|	НалоговыеВычеты.ДокументОснование КАК ДокументОснование,
	//	|	Реквизиты.Организация КАК СтруктурнаяЕдиница,
	//	|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
	//	|ИЗ
	//	|	ВТ_НалоговыеВычеты КАК НалоговыеВычеты
	//	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	//	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&ПериодРегистрации, ) КАК УчетнаяПолитикаНалоговыйУчетСрезПоследних
	//	|			ПО Реквизиты.Организация = УчетнаяПолитикаНалоговыйУчетСрезПоследних.Организация
	//	|		ПО (ИСТИНА)";
	//

	//Результат = Запрос.Выполнить();	
	//ПараметрыРасчета.Вставить("ИПНСведенияОДоходах", Результат.Выгрузить());
	
	Возврат ПараметрыРасчета;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Проведение

Функция ПодготовитьПараметрыПроведения(Ссылка, Отказ) Экспорт
	
   ПараметрыПроведения = Новый Структура;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ПериодРегистрации", НачалоМесяца(Ссылка.ПериодРегистрации));
	Запрос.УстановитьПараметр("Период", Ссылка.ПериодРегистрации);
	
	НомераТаблиц = Новый Структура;
	
	Запрос.Текст = ТекстЗапросаРеквизитыДокумента(НомераТаблиц);
	Результат = Запрос.ВыполнитьПакет();
	ТаблицаРеквизиты = Результат[НомераТаблиц["Реквизиты"]].Выгрузить();
	ПараметрыПроведения.Вставить("Реквизиты", ТаблицаРеквизиты);
	
	Реквизиты = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(ТаблицаРеквизиты[0]);
	
	ПоддержкаРаботыСоСтруктурнымиПодразделениями = ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	Реквизиты.Вставить("ПоддержкаРаботыСоСтруктурнымиПодразделениями", ПоддержкаРаботыСоСтруктурнымиПодразделениями);
	ПараметрыПроведения.Реквизиты.ЗаполнитьЗначения(ПоддержкаРаботыСоСтруктурнымиПодразделениями	 , "ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	
	Запрос.УстановитьПараметр("Организация", 			   Реквизиты.ГоловнаяОрганизация);
	Запрос.УстановитьПараметр("ОбособленноеПодразделение", Реквизиты.Организация);
	Запрос.УстановитьПараметр("СтруктурноеПодразделение",  Реквизиты.СтруктурноеПодразделение);
	Запрос.УстановитьПараметр("ОкончаниеПериодаРегистрации", КонецМесяца(Реквизиты.ПериодРегистрации));
	Запрос.УстановитьПараметр("Начало", 				   НачалоМесяца(Реквизиты.ПериодРегистрации));
	Запрос.УстановитьПараметр("Окончание", 				   КонецМесяца(Реквизиты.ПериодРегистрации));
	Запрос.УстановитьПараметр("ПоддержкаРаботыСоСтруктурнымиПодразделениями", ПоддержкаРаботыСоСтруктурнымиПодразделениями);
	Запрос.УстановитьПараметр("ИндивидуальныйПредприниматель", Реквизиты.ИндивидуальныйПредприниматель);
	Запрос.УстановитьПараметр("ЕжемесячныйРасчетВзносовИОтчисленийЗаИП", Реквизиты.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП);
	
	Если ПоддержкаРаботыСоСтруктурнымиПодразделениями Тогда   			
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Реквизиты.СтруктурноеПодразделение,
																							Реквизиты.Организация,
																							ПредопределенноеЗначение("Перечисление.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты"));
	Иначе
		Налогоплательщик = Реквизиты.Организация;
	КонецЕсли;
	Запрос.УстановитьПараметр("Налогоплательщик",  Налогоплательщик);
	
	НомераТаблиц = Новый Структура;
	
	Если НЕ Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам Тогда
		
		ПодготовитьТаблицыДокумента(Запрос, Реквизиты);

		Запрос.Текст = ТекстЗапросаИсчисленныйИПН(НомераТаблиц)
						+ ТекстЗапросаИПНСведенияОДоходах(НомераТаблиц)
						+ ТекстЗапросаИсчисленныйОПВ(НомераТаблиц)
						+ ТекстЗапросаОПВСведенияОДоходах(НомераТаблиц)
						+ ТекстЗапросаОПВПодлежитПеречислениюВФонды(НомераТаблиц, Реквизиты, ПараметрыПроведения)
						+ ТекстЗапросаИсчисленныеВОСМС(НомераТаблиц)
						+ ТекстЗапросаВОСМССведенияОДоходах(НомераТаблиц)
						+ ТекстЗапросаВОСМСПодлежитПеречислениюВФонды(НомераТаблиц, Реквизиты, ПараметрыПроведения)
						+ ТекстЗапросаВзаиморасчетыСРаботникамиОрганизаций(НомераТаблиц)
						+ ТекстЗапросаВзаиморасчетыОрганизацийСКонтрагентамиФизЛицами(НомераТаблиц)
						+ ТекстЗапросаВзаиморасчетыСПолучателямиИЛ(НомераТаблиц)
						+ ТекстЗапросаВыплаченныеДоходыНУ(НомераТаблиц)
						+ ТекстЗапросаСведенияОбИсчисленииВычетовИПН(НомераТаблиц);
	Иначе
		Запрос.Текст = РаспределитьРезультатыПоСтруктурнымЕдиницам(НомераТаблиц, Реквизиты, Запрос);
	КонецЕсли;
				
	Если НЕ ПустаяСтрока(Запрос.Текст) Тогда 
		Результат = Запрос.ВыполнитьПакет();
		Для Каждого НомерТаблицы Из НомераТаблиц Цикл
			ПараметрыПроведения.Вставить(НомерТаблицы.Ключ, Результат[НомерТаблицы.Значение].Выгрузить());
		КонецЦикла;
	КонецЕсли;
	
	Возврат ПараметрыПроведения;

КонецФункции

Функция ТекстЗапросаРеквизитыДокумента(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВременнаяТаблица_ДанныеДокумента", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВременнаяТаблица_Реквизиты", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("Реквизиты", НомераТаблиц.Количество());
	
	ТекстЗапроса = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РасчетУдержанийРаботниковОрганизаций.Дата,
		|	РасчетУдержанийРаботниковОрганизаций.Организация,
		|	РасчетУдержанийРаботниковОрганизаций.СтруктурноеПодразделение,
		|	РасчетУдержанийРаботниковОрганизаций.ПериодРегистрации,
		|	РасчетУдержанийРаботниковОрганизаций.Ссылка,
		|	РасчетУдержанийРаботниковОрганизаций.ПодразделениеОрганизации,
		|	ЕСТЬNULL(РасчетУдержанийРаботниковОрганизаций.ПодразделениеОрганизации.ЯвляетсяСтруктурнымПодразделением, ЛОЖЬ) КАК ЯвляетсяСтруктурнымПодразделением
		|ПОМЕСТИТЬ ВТ_ДанныеДокумента
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций КАК РасчетУдержанийРаботниковОрганизаций
		|ГДЕ
		|	РасчетУдержанийРаботниковОрганизаций.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РасчетУдержаний.Дата,
		|	РасчетУдержаний.Организация,
		|	РасчетУдержаний.СтруктурноеПодразделение,
		|	РасчетУдержаний.ПериодРегистрации,
		|	РасчетУдержаний.Ссылка,
		|	РасчетУдержаний.ПодразделениеОрганизации,
		|	РасчетУдержаний.ПодразделениеОрганизации.ЯвляетсяСтруктурнымПодразделением,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(УчетнаяПолитикаПоПерсоналуОрганизаций.ВестиУчетПоГоловнойОрганизации, ИСТИНА)
		|			ТОГДА ВЫБОР
		|					КОГДА РасчетУдержаний.Организация.ГоловнаяОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|						ТОГДА РасчетУдержаний.Организация
		|					ИНАЧЕ РасчетУдержаний.Организация.ГоловнаяОрганизация
		|				КОНЕЦ
		|		ИНАЧЕ РасчетУдержаний.Организация
		|	КОНЕЦ КАК ГоловнаяОрганизация,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.ОтражениеПоПериодуРегистрации, ЛОЖЬ) КАК ОтражениеПоПериодуРегистрации,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ, ЛОЖЬ) КАК ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.УпрощенныйУчетИПНиОПВ, ЛОЖЬ) КАК УпрощенныйУчетИПНиОПВ,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.РаспределятьНалогиПоСтруктурнымЕдиницам, ЛОЖЬ) КАК РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.РаспределятьНалогиПоПодразделениямОрганизаций, ЛОЖЬ) КАК РаспределятьНалогиПоПодразделениямОрганизаций,
		|	ЛОЖЬ КАК ПоддержкаРаботыСоСтруктурнымиПодразделениями,
		|   ВЫБОР
		|		КОГДА РасчетУдержаний.Организация.ЮрФизЛицо = ЗНАЧЕНИЕ(Перечисление.ЮрФизЛицо.ФизЛицо) И ЕСТЬNULL(УчетнаяПолитикаНУ.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП, ЛОЖЬ)
		|			ТОГДА РасчетУдержаний.Организация.ИндивидуальныйПредприниматель 
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ КАК ИндивидуальныйПредприниматель,
		|	ЕСТЬNULL(УчетнаяПолитикаНУ.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП, ЛОЖЬ) КАК ЕжемесячныйРасчетВзносовИОтчисленийЗаИП
		|ПОМЕСТИТЬ ВТ_Реквизиты
		|ИЗ
		|	ВТ_ДанныеДокумента КАК РасчетУдержаний
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаПоПерсоналуОрганизаций КАК УчетнаяПолитикаПоПерсоналуОрганизаций
		|			ПО РасчетУдержаний.Организация = УчетнаяПолитикаПоПерсоналуОрганизаций.Организация
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&ПериодРегистрации, ) КАК УчетнаяПолитикаНУ
		|			ПО РасчетУдержаний.Организация = УчетнаяПолитикаНУ.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Реквизиты.Дата,
		|	Реквизиты.Организация,
		|	Реквизиты.СтруктурноеПодразделение,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.Ссылка,
		|	Реквизиты.ПодразделениеОрганизации,
		|	Реквизиты.ПодразделениеОрганизацииЯвляетсяСтруктурнымПодразделением,
		|	Реквизиты.ГоловнаяОрганизация,
		|	Реквизиты.ОтражениеПоПериодуРегистрации,
		|	Реквизиты.ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ,
		|	Реквизиты.УпрощенныйУчетИПНиОПВ,
		|	Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций,
		|	Реквизиты.ПоддержкаРаботыСоСтруктурнымиПодразделениями,
		|	Реквизиты.ИндивидуальныйПредприниматель,
		|	Реквизиты.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП
		|ИЗ
		|	ВТ_Реквизиты КАК Реквизиты";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Процедура ПодготовитьТаблицыДокумента(Запрос, Реквизиты)
	
	СписокСпособыРасчетаИЛ = Новый СписокЗначений;
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.УдержаниеФиксированнойСуммой);
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.ИсполнительныйЛистПроцентом);
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.ПоМесячномуРасчетномуПоказателю);
	Запрос.УстановитьПараметр("СписокСпособыРасчетаИЛ", СписокСпособыРасчетаИЛ);

	Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныйИПН.НомерСтроки,
		|	ИсчисленныйИПН.ФизЛицо,
		|	ИсчисленныйИПН.Налог,
		|	ИсчисленныйИПН.МесяцНалоговогоПериода,
		|	ИсчисленныйИПН.ОблагаемаяБаза,
		|	ИсчисленныйИПН.ПримененныйВычет,
		|	ИсчисленныйИПН.ПримененнаяЛьгота,
		|	ИсчисленныйИПН.РазрешенныйВычет,
		|	ВЫБОР
		|		КОГДА ИсчисленныйИПН.ФизЛицо ССЫЛКА Справочник.Контрагенты
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЯвляетсяКонтрагентом
		|ПОМЕСТИТЬ ВТ_ИсчисленныйИПН
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйИПН КАК ИсчисленныйИПН
		|ГДЕ
		|	ИсчисленныйИПН.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныйОПВ.НомерСтроки,
		|	ИсчисленныйОПВ.ФизЛицо,
		|	ИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	ИсчисленныйОПВ.ОблагаемаяБаза,
		|	ИсчисленныйОПВ.Взнос,
		|	ВЫБОР
		|		КОГДА ИсчисленныйОПВ.ФизЛицо ССЫЛКА Справочник.Контрагенты
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЯвляетсяКонтрагентом
		|ПОМЕСТИТЬ ВТ_ИсчисленныйОПВ
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйОПВ КАК ИсчисленныйОПВ
		|ГДЕ
		|	ИсчисленныйОПВ.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныеВОСМС.НомерСтроки,
		|	ИсчисленныеВОСМС.ФизЛицо,
		|	ИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	ИсчисленныеВОСМС.ОблагаемаяБаза,
		|	ИсчисленныеВОСМС.Взнос,
		|	ВЫБОР
		|		КОГДА ИсчисленныеВОСМС.ФизЛицо ССЫЛКА Справочник.Контрагенты
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК ЯвляетсяКонтрагентом
		|ПОМЕСТИТЬ ВТ_ИсчисленныеВОСМС
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныеВОСМС КАК ИсчисленныеВОСМС
		|ГДЕ
		|	ИсчисленныеВОСМС.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Удержания.НомерСтроки,
		|	Удержания.ФизЛицо,
		|	Удержания.Размер,
		|	Удержания.ВидРасчета,
		|	Удержания.ДокументОснование,
		|	Удержания.Результат,
		|	ВЫБОР
		|		КОГДА Реквизиты.ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ
		|			ТОГДА Удержания.Результат
		|		ИНАЧЕ ВЫБОР
		|				КОГДА Удержания.ДокументОснование.Ссылка ЕСТЬ NULL 
		|						ИЛИ НЕ Удержания.ДокументОснование.Ссылка ЕСТЬ NULL 
		|							И НЕ Удержания.ДокументОснование ССЫЛКА Документ.ИсполнительныйЛист
		|					ТОГДА Удержания.Результат
		|				ИНАЧЕ 0
		|			КОНЕЦ
		|	КОНЕЦ КАК СуммаДохода,
		|	ВЫБОР
		|		КОГДА Удержания.ВидРасчета.СпособРасчета В (&СписокСпособыРасчетаИЛ)
		|				ИЛИ Удержания.ДокументОснование.СпособПеречисления = ЗНАЧЕНИЕ(Перечисление.СпособыПеречисленияПоИсполнительномуЛисту.ЧерезКассу)
		|			ТОГДА Удержания.Результат
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СуммаУдержанияИЛ,
		|	ВЫБОР
		|		КОГДА НЕ Удержания.ВидРасчета.СпособРасчета В (&СписокСпособыРасчетаИЛ)
		|				И Удержания.ДокументОснование.СпособПеречисления <> ЗНАЧЕНИЕ(Перечисление.СпособыПеречисленияПоИсполнительномуЛисту.ЧерезКассу)
		|			ТОГДА Удержания.Результат
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СуммаСборов,
		|	Удержания.ДокументОснование.Получатель КАК Получатель
		|ПОМЕСТИТЬ ВТ_Удержания
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.Удержания КАК Удержания
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|ГДЕ
		|	Удержания.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НалоговыеВычеты.НомерСтроки,
		|	НалоговыеВычеты.ФизЛицо,
		|	НалоговыеВычеты.ВычетИПН,
		|	НалоговыеВычеты.МесяцНалоговогоПериода,
		|	НалоговыеВычеты.СуммаВычета,
		|	НалоговыеВычеты.ДокументОснование
		|ПОМЕСТИТЬ ВТ_НалоговыеВычеты
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.НалоговыеВычеты КАК НалоговыеВычеты
		|ГДЕ
		|	НалоговыеВычеты.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВычетыИПН.НомерСтроки,
		|	ВычетыИПН.ФизЛицо,
		|	ВычетыИПН.МесяцНалоговогоПериода,
		|	ВычетыИПН.ВидВычета,
		|	ВычетыИПН.РазрешенныйВычет,
		|	ВычетыИПН.ПримененныйВычет
		|ПОМЕСТИТЬ ВТ_ВычетыИПН
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ВычетыИПН КАК ВычетыИПН
		|ГДЕ
		|	ВычетыИПН.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	&ПериодРегистрации КАК ПериодВзаиморасчетов,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА Реквизиты.ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК ПериодРаботника,
		|	&Налогоплательщик КАК Налогоплательщик,
		|	&ОбособленноеПодразделение КАК Организация,
		|	СтрокаИсчисленныйИПН.ФизЛицо,
		|	СтрокаИсчисленныйИПН.ФизЛицо КАК Контрагент,
		|	СтрокаИсчисленныйИПН.ЯвляетсяКонтрагентом,
		|	-СтрокаИсчисленныйИПН.Налог КАК СуммаВзаиморасчетов,
		|	СтрокаИсчисленныйИПН.НомерСтроки
		|ПОМЕСТИТЬ ВТ_ВзаиморасчетыОрганизаций
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК СтрокаИсчисленныйИПН
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	&ОкончаниеПериодаРегистрации,
		|	&ПериодРегистрации,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА Реквизиты.ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	&Налогоплательщик,
		|	&ОбособленноеПодразделение,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	СтрокаИсчисленныйОПВ.ЯвляетсяКонтрагентом,
		|	-СтрокаИсчисленныйОПВ.Взнос,
		|	СтрокаИсчисленныйОПВ.НомерСтроки
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК СтрокаИсчисленныйОПВ
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|ГДЕ
		|	СтрокаИсчисленныйОПВ.ФизЛицо <> &ИндивидуальныйПредприниматель
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	&ОкончаниеПериодаРегистрации,
		|	&ПериодРегистрации,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА Реквизиты.ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	&Налогоплательщик,
		|	&ОбособленноеПодразделение,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	СтрокаИсчисленныеВОСМС.ЯвляетсяКонтрагентом,
		|	-СтрокаИсчисленныеВОСМС.Взнос,
		|	СтрокаИсчисленныеВОСМС.НомерСтроки
		|ИЗ
		|	ВТ_ИсчисленныеВОСМС КАК СтрокаИсчисленныеВОСМС
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|ГДЕ
		|	СтрокаИсчисленныеВОСМС.ФизЛицо <> &ИндивидуальныйПредприниматель
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	&ОкончаниеПериодаРегистрации,
		|	&ПериодРегистрации,
		|	&ПериодРегистрации,
		|	&Налогоплательщик,
		|	&ОбособленноеПодразделение,
		|	СтрокаУдержания.ФизЛицо,
		|	СтрокаУдержания.ФизЛицо,
		|	ЛОЖЬ,
		|	-СтрокаУдержания.Результат,
		|	СтрокаУдержания.НомерСтроки
		|ИЗ
		|	ВТ_Удержания КАК СтрокаУдержания
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ИсчисленныйИПН.ФизЛицо,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ ИсчисленныйИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ПОМЕСТИТЬ ВТ_ПериодыСотрудников
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК ИсчисленныйИПН
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ИсчисленныйОПВ.ФизЛицо,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ ИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК ИсчисленныйОПВ
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Удержания.ФизЛицо,
		|	&ПериодРегистрации
		|ИЗ
		|	ВТ_Удержания КАК Удержания
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	НалоговыеВычеты.ФизЛицо,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ НалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ
		|ИЗ
		|	ВТ_НалоговыеВычеты КАК НалоговыеВычеты
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ВТ_ВычетыИПН.ФизЛицо,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ ВТ_ВычетыИПН.МесяцНалоговогоПериода
		|	КОНЕЦ
		|ИЗ
		|	ВТ_ВычетыИПН КАК ВТ_ВычетыИПН
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО (ИСТИНА)";
			
		Запрос.Текст = Запрос.Текст + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета()
					 + РасчетЗарплатыСервер.СформироватьТекстЗапросаСтруктурныеЕдиницы("ВТ_ПериодыСотрудников", Истина, Реквизиты.ПоддержкаРаботыСоСтруктурнымиПодразделениями И Не Реквизиты.РаспределятьНалогиПоСтруктурнымЕдиницам);
					 
		Результат = Запрос.Выполнить();
	                                                 
КонецПроцедуры

Функция ТекстЗапросаИсчисленныйИПН(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ИсчисленныйИПН", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК МесяцНалоговогоПериода,
		|	СтрокаИсчисленныйИПН.ФизЛицо,
		|	СУММА(СтрокаИсчисленныйИПН.Налог)КАК Налог,
		|	ЛОЖЬ КАК НеОтражатьВРеглУчете,
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР 
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ 
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК СтрокаИсчисленныйИПН
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныйИПН.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|			КОНЕЦ) = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныйИПН.Налог <> 0
		|
		|СГРУППИРОВАТЬ ПО 
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	СтрокаИсчисленныйИПН.ФизЛицо,
		|	ВЫБОР 
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ 
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаИПНСведенияОДоходах(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ИПНСведенияОДоходах", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период,
		|	&ПериодРегистрации КАК ПериодРегистрации,
		|	СтрокаИсчисленныйИПН.ФизЛицо,
		|	СтрокаИсчисленныйИПН.ОблагаемаяБаза,
		|	СтрокаИсчисленныйИПН.ПримененныйВычет,
		|	СтрокаИсчисленныйИПН.ПримененнаяЛьгота,
		|	СтрокаИсчисленныйИПН.РазрешенныйВычет,
		|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
		|	NULL КАК ВидРасчета,
		|	0 КАК СуммаДохода,
		|	0 КАК СуммаВычета,
		|	NULL КАК ДокументОснование,
		|	
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|	
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК СтрокаИсчисленныйИПН
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныйИПН.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныйИПН.МесяцНалоговогоПериода
		|			КОНЕЦ)  = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныйИПН.ОблагаемаяБаза <> 0
		|	ИЛИ СтрокаИсчисленныйИПН.ПримененныйВычет <> 0 
		|	ИЛИ СтрокаИсчисленныйИПН.ПримененнаяЛьгота <> 0
		|	ИЛИ СтрокаИсчисленныйИПН.РазрешенныйВычет <> 0 
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаНалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период,
		|	&ПериодРегистрации КАК ПериодРегистрации,
		|	СтрокаНалоговыеВычеты.ФизЛицо,
		|	NULL,
		|	NULL,
		|	NULL,
		|	NULL,
		|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
		|	СтрокаНалоговыеВычеты.ВычетИПН КАК ВидРасчета,
		|	0 КАК СуммаДохода,
		|	СтрокаНалоговыеВычеты.СуммаВычета КАК СуммаВычета,
		|	СтрокаНалоговыеВычеты.ДокументОснование КАК ДокументОснование,
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_НалоговыеВычеты КАК СтрокаНалоговыеВычеты
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаНалоговыеВычеты.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаНалоговыеВычеты.МесяцНалоговогоПериода
		|			КОНЕЦ) = МестоРаботы.Период
		|";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаИсчисленныйОПВ(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ИсчисленныйОПВ", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	ВЫБОР 
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ КАК МесяцНалоговогоПериода,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	СУММА(СтрокаИсчисленныйОПВ.Взнос),
		|	ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) КАК ВидПлатежа,
		|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление) КАК ВидСтроки,
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК СтрокаИсчисленныйОПВ
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныйОПВ.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|			КОНЕЦ)  = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныйОПВ.Взнос <> 0
		|
		|СГРУППИРОВАТЬ ПО 
		|	ВЫБОР 
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаОПВСведенияОДоходах(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ОПВСведенияОДоходах", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период,
		|	&ПериодРегистрации КАК ПериодРегистрации,
		|	&Налогоплательщик КАК Налогоплательщик,
		|	&ОбособленноеПодразделение КАК Организация,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	СУММА(СтрокаИсчисленныйОПВ.ОблагаемаяБаза),
		|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
		|	
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК СтрокаИсчисленныйОПВ
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныйОПВ.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|			КОНЕЦ) = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныйОПВ.ОблагаемаяБаза <> 0
		|
		|СГРУППИРОВАТЬ ПО 
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	СтрокаИсчисленныйОПВ.ФизЛицо,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаОПВПодлежитПеречислениюВФонды(НомераТаблиц, Реквизиты, ПараметрыПроведения) 
	
	Если Реквизиты.УпрощенныйУчетИПНиОПВ Тогда
		
		ТекстЗапроса =  
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	&ОкончаниеПериодаРегистрации КАК Период,
			|	&ПериодРегистрации КАК МесяцВыплатыДоходов,
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
			|	КОНЕЦ КАК МесяцНалоговогоПериода,
			|	СтрокаИсчисленныйОПВ.ФизЛицо,
			|	СУММА(СтрокаИсчисленныйОПВ.Взнос),
			|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
			|
			|	// СтруктурнаяЕдиница
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			ТОГДА 
			|				ВЫБОР
			|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
			|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
			|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|						ТОГДА &СтруктурноеПодразделение
			|					ИНАЧЕ &ОбособленноеПодразделение
			|				КОНЕЦ
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ КАК СтруктурнаяЕдиница,
			|
			|	// ПодразделениеОрганизации
			|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
			|	
			|ИЗ
			|	ВТ_ИсчисленныйОПВ КАК СтрокаИсчисленныйОПВ
			|
			|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
			|		ПО ИСТИНА
			|
			|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
			|		ПО СтрокаИсчисленныйОПВ.ФизЛицо = МестоРаботы.ФизЛицо
			|			И (ВЫБОР
			|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|					ТОГДА &ПериодРегистрации
			|				ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
			|			КОНЕЦ) = МестоРаботы.Период
			|
			|ГДЕ 
			|	СтрокаИсчисленныйОПВ.Взнос <> 0
			|
			|СГРУППИРОВАТЬ ПО 
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
			|	КОНЕЦ,
			|	СтрокаИсчисленныйОПВ.ФизЛицо,
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			ТОГДА 
			|				ВЫБОР
			|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
			|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
			|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|						ТОГДА &СтруктурноеПодразделение
			|					ИНАЧЕ &ОбособленноеПодразделение
			|				КОНЕЦ
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ
			|"+ ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
		НомераТаблиц.Вставить("ОПВПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	ИначеЕсли Реквизиты.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП Тогда
		ТекстЗапроса =  
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	&ОкончаниеПериодаРегистрации КАК Период,
			|	&ПериодРегистрации КАК МесяцВыплатыДоходов,
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
			|	КОНЕЦ КАК МесяцНалоговогоПериода,
			|	СтрокаИсчисленныйОПВ.ФизЛицо,
			|	СУММА(СтрокаИсчисленныйОПВ.Взнос),
			|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
			|
			|	// СтруктурнаяЕдиница
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			И НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|			ТОГДА &СтруктурноеПодразделение
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ КАК СтруктурнаяЕдиница,
			|
			|	// ПодразделениеОрганизации
			|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
			|	
			|ИЗ
			|	ВТ_ИсчисленныйОПВ КАК СтрокаИсчисленныйОПВ
			|
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
			|		ПО СтрокаИсчисленныйОПВ.ФизЛицо = Реквизиты.ИндивидуальныйПредприниматель
			|
			|ГДЕ 
			|	СтрокаИсчисленныйОПВ.Взнос <> 0
			|
			|СГРУППИРОВАТЬ ПО 
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныйОПВ.МесяцНалоговогоПериода
			|	КОНЕЦ,
			|	СтрокаИсчисленныйОПВ.ФизЛицо,
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			И НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|			ТОГДА &СтруктурноеПодразделение
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ
			|"+ ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
		НомераТаблиц.Вставить("ОПВПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	Иначе 
		ТекстЗапроса = "";
		ПараметрыПроведения.Вставить("ОПВПодлежитПеречислениюВФонды", Неопределено);
	КонецЕсли;
	
	Возврат ТекстЗапроса; 
	
КонецФункции

Функция ТекстЗапросаИсчисленныеВОСМС(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ИсчисленныеВОСМС", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	ВЫБОР 
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ КАК МесяцНалоговогоПериода,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	СУММА(СтрокаИсчисленныеВОСМС.Взнос),
		|	ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) КАК ВидПлатежа,
		|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление) КАК ВидСтроки,
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ИсчисленныеВОСМС КАК СтрокаИсчисленныеВОСМС
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныеВОСМС.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|			КОНЕЦ)  = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныеВОСМС.Взнос <> 0
		|
		|СГРУППИРОВАТЬ ПО 
		|	ВЫБОР 
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаВОСМССведенияОДоходах(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВОСМССведенияОДоходах", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период,
		|	&ПериодРегистрации КАК ПериодРегистрации,
		|	&Налогоплательщик КАК Налогоплательщик,
		|	&ОбособленноеПодразделение КАК Организация,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	СУММА(СтрокаИсчисленныеВОСМС.ОблагаемаяБаза),
		|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
		|	
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ИсчисленныеВОСМС КАК СтрокаИсчисленныеВОСМС
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаИсчисленныеВОСМС.ФизЛицо = МестоРаботы.ФизЛицо
		|			И (ВЫБОР
		|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|					ТОГДА &ПериодРегистрации
		|				ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|			КОНЕЦ) = МестоРаботы.Период
		|
		|ГДЕ 
		|	СтрокаИсчисленныеВОСМС.ОблагаемаяБаза <> 0
		|
		|СГРУППИРОВАТЬ ПО 
		|	ВЫБОР
		|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
		|			ТОГДА &ПериодРегистрации
		|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	СтрокаИсчисленныеВОСМС.ФизЛицо,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаВОСМСПодлежитПеречислениюВФонды(НомераТаблиц, Реквизиты, ПараметрыПроведения) 
	
	Если Реквизиты.УпрощенныйУчетИПНиОПВ Тогда
		
		ТекстЗапроса =  
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	&ОкончаниеПериодаРегистрации КАК Период,
			|	&ПериодРегистрации КАК МесяцВыплатыДоходов,
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
			|	КОНЕЦ КАК МесяцНалоговогоПериода,
			|	СтрокаИсчисленныеВОСМС.ФизЛицо,
			|	СУММА(СтрокаИсчисленныеВОСМС.Взнос),
			|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
			|
			|	// СтруктурнаяЕдиница
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			ТОГДА 
			|				ВЫБОР
			|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
			|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
			|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|						ТОГДА &СтруктурноеПодразделение
			|					ИНАЧЕ &ОбособленноеПодразделение
			|				КОНЕЦ
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ КАК СтруктурнаяЕдиница,
			|
			|	// ПодразделениеОрганизации
			|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
			|	
			|ИЗ
			|	ВТ_ИсчисленныеВОСМС КАК СтрокаИсчисленныеВОСМС
			|
			|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
			|		ПО ИСТИНА
			|
			|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
			|		ПО СтрокаИсчисленныеВОСМС.ФизЛицо = МестоРаботы.ФизЛицо
			|			И (ВЫБОР
			|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|					ТОГДА &ПериодРегистрации
			|				ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
			|			КОНЕЦ) = МестоРаботы.Период
			|
			|ГДЕ 
			|	СтрокаИсчисленныеВОСМС.ОблагаемаяБаза <> 0
			|
			|СГРУППИРОВАТЬ ПО 
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
			|	КОНЕЦ,
			|	СтрокаИсчисленныеВОСМС.ФизЛицо,
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			ТОГДА 
			|				ВЫБОР
			|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
			|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
			|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|						ТОГДА &СтруктурноеПодразделение
			|					ИНАЧЕ &ОбособленноеПодразделение
			|				КОНЕЦ
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ
			|"+ ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
		НомераТаблиц.Вставить("ВОСМСПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	ИначеЕсли Реквизиты.ЕжемесячныйРасчетВзносовИОтчисленийЗаИП Тогда
		ТекстЗапроса =  
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	&ОкончаниеПериодаРегистрации КАК Период,
			|	&ПериодРегистрации КАК МесяцВыплатыДоходов,
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
			|	КОНЕЦ КАК МесяцНалоговогоПериода,
			|	СтрокаИсчисленныеВОСМС.ФизЛицо,
			|	СУММА(СтрокаИсчисленныеВОСМС.Взнос),
			|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
			|
			|	// СтруктурнаяЕдиница
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			И НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|			ТОГДА &СтруктурноеПодразделение
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ КАК СтруктурнаяЕдиница,
			|
			|	// ПодразделениеОрганизации
			|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
			|	
			|ИЗ
			|	ВТ_ИсчисленныеВОСМС КАК СтрокаИсчисленныеВОСМС
			|
			|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
			|		ПО СтрокаИсчисленныеВОСМС.ФизЛицо = Реквизиты.ИндивидуальныйПредприниматель
			|
			|ГДЕ 
			|	СтрокаИсчисленныеВОСМС.Взнос <> 0
			|
			|СГРУППИРОВАТЬ ПО 
			|	ВЫБОР
			|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
			|			ТОГДА &ПериодРегистрации
			|		ИНАЧЕ СтрокаИсчисленныеВОСМС.МесяцНалоговогоПериода
			|	КОНЕЦ,
			|	СтрокаИсчисленныеВОСМС.ФизЛицо,
			|	ВЫБОР
			|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
			|			И НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
			|			ТОГДА &СтруктурноеПодразделение
			|		ИНАЧЕ &ОбособленноеПодразделение
			|	КОНЕЦ
			|"+ ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
		НомераТаблиц.Вставить("ВОСМСПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	Иначе 
		ТекстЗапроса = "";
		ПараметрыПроведения.Вставить("ВОСМСПодлежитПеречислениюВФонды", Неопределено);
	КонецЕсли;
	
	Возврат ТекстЗапроса; 
	
КонецФункции

Функция ТекстЗапросаВзаиморасчетыСРаботникамиОрганизаций(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВзаиморасчетыСРаботникамиОрганизаций", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СтрокиВзаиморасчетыОрганизаций.Период,
		|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
		|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
		|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
		|	СУММА(СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов),
		|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
		|	
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		| 	// ПодразделениеОрганизации
		| 	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_ВзаиморасчетыОрганизаций КАК СтрокиВзаиморасчетыОрганизаций
		|	
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокиВзаиморасчетыОрганизаций.ФизЛицо = МестоРаботы.ФизЛицо
		|			И СтрокиВзаиморасчетыОрганизаций.ПериодРаботника = МестоРаботы.Период
		|
		|ГДЕ
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом = ЛОЖЬ
		|	И СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	СтрокиВзаиморасчетыОрганизаций.Период,
		|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
		|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
		|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаВзаиморасчетыОрганизацийСКонтрагентамиФизЛицами(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВзаиморасчетыОрганизацийСКонтрагентамиФизЛицами", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СтрокиВзаиморасчетыОрганизаций.Период,
		|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
		|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
		|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
		|	СУММА(СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов),
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|				
		|ИЗ
		|	ВТ_ВзаиморасчетыОрганизаций КАК СтрокиВзаиморасчетыОрганизаций
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокиВзаиморасчетыОрганизаций.ФизЛицо = МестоРаботы.ФизЛицо
		|			И СтрокиВзаиморасчетыОрганизаций.ПериодРаботника = МестоРаботы.Период
		|
		|ГДЕ
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом = ИСТИНА
		|	И СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	СтрокиВзаиморасчетыОрганизаций.Период, 
		|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
		|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
		|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
		|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаВзаиморасчетыСПолучателямиИЛ(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВзаиморасчетыСПолучателямиИЛ", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	&ПериодРегистрации КАК ПериодВзаиморасчетов,
		|	СтрокаУдержания.Размер,
		|	СтрокаУдержания.ВидРасчета,
		|	СтрокаУдержания.Получатель,
		|	СтрокаУдержания.ДокументОснование,
		|	СУММА(СтрокаУдержания.СуммаУдержанияИЛ) КАК СуммаВзаиморасчетов,
		|	СУММА(СтрокаУдержания.СуммаСборов),
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_Удержания КАК СтрокаУдержания
		|
		|   ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаУдержания.ФизЛицо = МестоРаботы.ФизЛицо
		|			И &ПериодРегистрации = МестоРаботы.Период
		|
		|ГДЕ
		|	СтрокаУдержания.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ИсполнительныйЛист.ПустаяСсылка)
		|
		|СГРУППИРОВАТЬ ПО 
		|	СтрокаУдержания.Размер,
		|	СтрокаУдержания.ВидРасчета,
		|	СтрокаУдержания.Получатель,
		|	СтрокаУдержания.ДокументОснование,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ		
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции

Функция ТекстЗапросаВыплаченныеДоходыНУ(НомераТаблиц) 
	
	НомераТаблиц.Вставить("ВыплаченныеДоходыНУ", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	&ОкончаниеПериодаРегистрации КАК Период,
		|	&ПериодРегистрации КАК МесяцНалоговогоПериода,
		|	СтрокаУдержания.ФизЛицо,
		|	СУММА(СтрокаУдержания.СуммаДохода),
		|
		|	// СтруктурнаяЕдиница
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|
		|	// ПодразделениеОрганизации
		|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
		|
		|ИЗ
		|	ВТ_Удержания КАК СтрокаУдержания
		|		
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|
		|	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
		|		ПО СтрокаУдержания.ФизЛицо = МестоРаботы.ФизЛицо
		|			И &ПериодРегистрации = МестоРаботы.Период
		|
		|ГДЕ
		|	СтрокаУдержания.СуммаДохода <> 0
		|
		|СГРУППИРОВАТЬ ПО
		|	СтрокаУдержания.ФизЛицо,
		|	ВЫБОР
		|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ(МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
		|					КОГДА НЕ (&СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка))
		|						ТОГДА &СтруктурноеПодразделение
		|					ИНАЧЕ &ОбособленноеПодразделение
		|				КОНЕЦ
		|		ИНАЧЕ &ОбособленноеПодразделение 
		|	КОНЕЦ
		|";

	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции


// Выполняет распределение результатов по структурым единицам и подразделениям
//
Функция РаспределитьРезультатыПоСтруктурнымЕдиницам(НомераТаблиц, Реквизиты, Запрос)
	
	ПоддержкаРаботыСоСтруктурнымиПодразделениями = ПолучитьФункциональнуюОпцию("ПоддержкаРаботыСоСтруктурнымиПодразделениями");
	РаспределятьНалогиПоПодразделениямОрганизаций = Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций;
	
	ЗапросРаспределения = Новый Запрос;
	
	ЗапросРаспределения.УстановитьПараметр("Организация", 			   	Реквизиты.ГоловнаяОрганизация);
	ЗапросРаспределения.УстановитьПараметр("ОбособленноеПодразделение",	Реквизиты.Организация);
	ЗапросРаспределения.УстановитьПараметр("СтруктурноеПодразделение", 	Реквизиты.СтруктурноеПодразделение);
	ЗапросРаспределения.УстановитьПараметр("Период",  			   	   	Реквизиты.ПериодРегистрации);
	ЗапросРаспределения.УстановитьПараметр("Ссылка", 					Реквизиты.Ссылка);
	ЗапросРаспределения.УстановитьПараметр("Начало", 					НачалоМесяца(Реквизиты.ПериодРегистрации));
	ЗапросРаспределения.УстановитьПараметр("Окончание", 				КонецМесяца(Реквизиты.ПериодРегистрации));
	
	Если ПоддержкаРаботыСоСтруктурнымиПодразделениями Тогда   			
		Налогоплательщик = ПроцедурыНалоговогоУчетаВызовСервераПовтИсп.ПолучитьНалогоплательщикаСтруктурнойЕдиницы(Реквизиты.СтруктурноеПодразделение,
																													Реквизиты.Организация,
																													ПредопределенноеЗначение("Перечисление.РазделыНалоговогоУчета.НалогиСЗаработнойПлаты"));
	Иначе
		Налогоплательщик = Реквизиты.Организация;
	КонецЕсли;
	ЗапросРаспределения.УстановитьПараметр("Налогоплательщик",  Налогоплательщик);
	
	ЗапросРаспределения.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
		
	// ТАБЛИЧНЫЕ ЧАСТИ
	
	ЗапросРаспределения.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныйОПВ.Ссылка,
		|	ИсчисленныйОПВ.НомерСтроки,
		|	ИсчисленныйОПВ.ФизЛицо,
		|	ИсчисленныйОПВ.Взнос,
		|	ИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	ИсчисленныйОПВ.ОблагаемаяБаза,
		|	Реквизиты.Организация,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.ОтражениеПоПериодуРегистрации,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьОПВ
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйОПВ КАК ИсчисленныйОПВ
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|ГДЕ
		|	ИсчисленныйОПВ.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныйИПН.Ссылка,
		|	ИсчисленныйИПН.НомерСтроки,
		|	ИсчисленныйИПН.ФизЛицо,
		|	ИсчисленныйИПН.Налог,
		|	ИсчисленныйИПН.ПримененныйВычет,
		|	ИсчисленныйИПН.ПримененнаяЛьгота,
		|	ИсчисленныйИПН.МесяцНалоговогоПериода,
		|	ИсчисленныйИПН.РазрешенныйВычет,
		|	ИсчисленныйИПН.ОблагаемаяБаза,
		|	Реквизиты.Организация,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.ОтражениеПоПериодуРегистрации,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьИПН
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныйИПН КАК ИсчисленныйИПН
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|ГДЕ
		|	ИсчисленныйИПН.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	НалоговыеВычеты.Ссылка,
		|	НалоговыеВычеты.НомерСтроки,
		|	НалоговыеВычеты.ФизЛицо,
		|	НалоговыеВычеты.ВычетИПН,
		|	НалоговыеВычеты.ДокументОснование,
		|	НалоговыеВычеты.МесяцНалоговогоПериода,
		|	НалоговыеВычеты.СуммаВычета,
		|	НалоговыеВычеты.Ссылка.Организация,
		|	НалоговыеВычеты.Ссылка.ПериодРегистрации,
		|	Реквизиты.ОтражениеПоПериодуРегистрации
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьНалоговыеВычеты
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.НалоговыеВычеты КАК НалоговыеВычеты
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|ГДЕ
		|	НалоговыеВычеты.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ВычетыИПН.Ссылка,
		|	ВычетыИПН.НомерСтроки,
		|	ВычетыИПН.ФизЛицо,
		|	ВычетыИПН.ВидВычета Как ВидВычета,
		|	ВычетыИПН.МесяцНалоговогоПериода,
		|	ВычетыИПН.Ссылка.Организация,
		|	ВычетыИПН.Ссылка.ПериодРегистрации,
		|	Реквизиты.ОтражениеПоПериодуРегистрации,
		|	ВычетыИПН.РазрешенныйВычет,
		|	ВычетыИПН.ПримененныйВычет
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьВычетыИПН
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ВычетыИПН КАК ВычетыИПН
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|ГДЕ
		|	ВычетыИПН.Ссылка = &Ссылка
		|;
		|          
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИсчисленныеВОСМС.Ссылка,
		|	ИсчисленныеВОСМС.НомерСтроки,
		|	ИсчисленныеВОСМС.ФизЛицо,
		|	ИсчисленныеВОСМС.Взнос,
		|	ИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	ИсчисленныеВОСМС.ОблагаемаяБаза,
		|	Реквизиты.Организация,
		|	Реквизиты.ПериодРегистрации,
		|	Реквизиты.ОтражениеПоПериодуРегистрации,
		|	Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьВОСМС
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.ИсчисленныеВОСМС КАК ИсчисленныеВОСМС
		|
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|		ПО ИСТИНА
		|ГДЕ
		|	ИсчисленныеВОСМС.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Удержания.Ссылка,
		|	Удержания.НомерСтроки,
		|	Удержания.ФизЛицо,
		|	Удержания.ВидРасчета,
		|	Удержания.Размер,
		|	Удержания.ДокументОснование,
		|	Удержания.Результат,
		|	Удержания.Ссылка.Организация,
		|	Удержания.Ссылка.ПериодРегистрации,
		|	КОЛИЧЕСТВО(РАЗЛИЧНЫЕ БазовыеВидыРасчета.ВидРасчета) КАК КоличествоБазовыхРасчетов
		|ПОМЕСТИТЬ ВТ_ТабличнаяЧастьУдержания
		|ИЗ
		|	Документ.РасчетУдержанийРаботниковОрганизаций.Удержания КАК Удержания
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета.УдержанияОрганизаций.БазовыеВидыРасчета КАК БазовыеВидыРасчета
		|		ПО Удержания.ВидРасчета = БазовыеВидыРасчета.Ссылка
		|ГДЕ
		|	Удержания.Ссылка = &Ссылка
		|
		|СГРУППИРОВАТЬ ПО
		|	Удержания.Ссылка,
		|	Удержания.НомерСтроки,
		|	Удержания.ФизЛицо,
		|	Удержания.ВидРасчета,
		|	Удержания.Размер,
		|	Удержания.ДокументОснование,
		|	Удержания.Результат,
		|	Удержания.Ссылка.Организация,
		|	Удержания.Ссылка.ПериодРегистрации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабличнаяЧастьОПВ.ФизЛицо КАК ФизЛицо
		|ПОМЕСТИТЬ ВТ_СписокФизЛиц
		|ИЗ
		|	ВТ_ТабличнаяЧастьОПВ КАК ТабличнаяЧастьОПВ
		|
		|ОБЪЕДИНИТЬ // выбираем только различающиеся строки (без ВСЕ)
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьИПН.ФизЛицо
		|ИЗ
		|	ВТ_ТабличнаяЧастьИПН КАК ТабличнаяЧастьИПН
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьВОСМС.ФизЛицо
		|ИЗ
		|	ВТ_ТабличнаяЧастьВОСМС КАК ТабличнаяЧастьВОСМС
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьНалоговыеВычеты.ФизЛицо
		|ИЗ
		|	ВТ_ТабличнаяЧастьНалоговыеВычеты КАК ТабличнаяЧастьНалоговыеВычеты
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьУдержания.ФизЛицо
		|ИЗ
		|	ВТ_ТабличнаяЧастьУдержания КАК ТабличнаяЧастьУдержания
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьВычетыИПН.ФизЛицо
		|ИЗ
		|	ВТ_ТабличнаяЧастьВычетыИПН КАК ТабличнаяЧастьВычетыИПН";
		
	ЗапросРаспределения.Выполнить();
	
	// Ранее исчисленные налоги и взносы
	// Для корректного распределения в случае доначисления учтем все ранее начисленные суммы
	// (доначисление поддерживается только для ИПН и ОПВ, поэтому учитываем только их)
	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РанееИсчисленныйИПН.НомерСтроки,
		|	РанееИсчисленныйИПН.ФизЛицо,
		|	РанееИсчисленныйИПН.МесяцНалоговогоПериода,
		|	РанееИсчисленныйИПН.ПериодРегистрации,
		|	РанееИсчисленныйИПН.Организация,
		|	РанееИсчисленныйИПН.СтруктурнаяЕдиница,
		|	РанееИсчисленныйИПН.ПодразделениеОрганизации,
		|	СУММА(РанееИсчисленныйИПН.Налог) КАК Налог,
		|	СУММА(РанееИсчисленныйИПН.ОблагаемаяБаза) КАК ОблагаемаяБаза,
		|	СУММА(РанееИсчисленныйИПН.ПримененныйВычет) КАК ПримененныйВычет,
		|	СУММА(РанееИсчисленныйИПН.ПримененнаяЛьгота) КАК ПримененнаяЛьгота,
		|	СУММА(РанееИсчисленныйИПН.РазрешенныйВычет) КАК РазрешенныйВычет
		|ПОМЕСТИТЬ ВТ_РанееИсчисленныйИПН
		|ИЗ
		|	(ВЫБРАТЬ
		|		ТабличнаяЧастьИПН.НомерСтроки КАК НомерСтроки,
		|		ИПНРасчетыСБюджетом.ФизЛицо КАК ФизЛицо,
		|		ИПНРасчетыСБюджетом.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		НАЧАЛОПЕРИОДА(ИПНРасчетыСБюджетом.Период, МЕСЯЦ) КАК ПериодРегистрации,
		|		ТабличнаяЧастьИПН.Организация КАК Организация,
		|		ИПНРасчетыСБюджетом.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|		ВЫБОР
		|			КОГДА ТабличнаяЧастьИПН.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ИПНРасчетыСБюджетом.ПодразделениеОрганизации 
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ КАК ПодразделениеОрганизации,
		|		ИПНРасчетыСБюджетом.Налог КАК Налог,
		|		0 КАК ОблагаемаяБаза,
		|		0 КАК ПримененныйВычет,
		|		0 КАК ПримененнаяЛьгота,
		|		0 КАК РазрешенныйВычет
		|	ИЗ
		|		РегистрНакопления.ИПНРасчетыСБюджетом КАК ИПНРасчетыСБюджетом
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьИПН КАК ТабличнаяЧастьИПН
		|			ПО ИПНРасчетыСБюджетом.ФизЛицо = ТабличнаяЧастьИПН.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ИПНРасчетыСБюджетом.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьИПН.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ИПНРасчетыСБюджетом.МесяцНалоговогоПериода, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьИПН.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьИПН.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))
		|               И ИПНРасчетыСБюджетом.Налогоплательщик = &Налогоплательщик 
		|				И ИПНРасчетыСБюджетом.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 		
		|				И ИПНРасчетыСБюджетом.ВидСтроки = ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление)
		|			
		|	ГДЕ
		|		ИПНРасчетыСБюджетом.Активность
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьИПН.НомерСтроки,
		|		ИПНСведенияОДоходах.ФизЛицо,
		|		ИПНСведенияОДоходах.Период,
		|		ИПНСведенияОДоходах.ПериодРегистрации,
		|		ТабличнаяЧастьИПН.Организация,
		|		ИПНСведенияОДоходах.СтруктурнаяЕдиница,
		|		ВЫБОР
		|			КОГДА ТабличнаяЧастьИПН.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ИПНСведенияОДоходах.ПодразделениеОрганизации
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ,
		|		0,
		|		ИПНСведенияОДоходах.ОблагаемаяБазаОборот,
		|		ИПНСведенияОДоходах.ПримененныйВычетОборот,
		|		ИПНСведенияОДоходах.ПримененнаяЛьготаОборот,
		|		ИПНСведенияОДоходах.РазрешенныйВычетОборот
		|	ИЗ
		|		РегистрНакопления.ИПНСведенияОДоходах.Обороты(
		|				,
		|				,
		|				Месяц,
		|				Налогоплательщик = &Налогоплательщик
		|					И ПериодРегистрации = &Период
		|					И СпособНалогообложения = ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом)) КАК ИПНСведенияОДоходах
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьИПН КАК ТабличнаяЧастьИПН
		|			ПО ИПНСведенияОДоходах.ФизЛицо = ТабличнаяЧастьИПН.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ИПНСведенияОДоходах.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьИПН.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ИПНСведенияОДоходах.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьИПН.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьИПН.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))) КАК РанееИсчисленныйИПН
		|		
		|
		|СГРУППИРОВАТЬ ПО
		|	РанееИсчисленныйИПН.НомерСтроки,
		|	РанееИсчисленныйИПН.ФизЛицо,
		|	РанееИсчисленныйИПН.МесяцНалоговогоПериода,
		|	РанееИсчисленныйИПН.ПериодРегистрации,
		|	РанееИсчисленныйИПН.Организация,
		|	РанееИсчисленныйИПН.СтруктурнаяЕдиница,
		|	РанееИсчисленныйИПН.ПодразделениеОрганизации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РанееИсчисленныйОПВ.НомерСтроки,
		|	РанееИсчисленныйОПВ.ФизЛицо,
		|	РанееИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	РанееИсчисленныйОПВ.ПериодРегистрации,
		|	РанееИсчисленныйОПВ.Организация,
		|	РанееИсчисленныйОПВ.СтруктурнаяЕдиница,
		|	РанееИсчисленныйОПВ.ПодразделениеОрганизации,
		|	СУММА(РанееИсчисленныйОПВ.Взнос) КАК Взнос,
		|	СУММА(РанееИсчисленныйОПВ.ОблагаемаяБаза) КАК ОблагаемаяБаза
		|ПОМЕСТИТЬ ВТ_РанееИсчисленныйОПВ
		|ИЗ
		|	(ВЫБРАТЬ
		|		ТабличнаяЧастьОПВ.НомерСтроки КАК НомерСтроки,
		|		ОПВРасчетыСФондами.ФизЛицо КАК ФизЛицо,
		|		ОПВРасчетыСФондами.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		НАЧАЛОПЕРИОДА(ОПВРасчетыСФондами.Период, МЕСЯЦ) КАК ПериодРегистрации,
		|		ТабличнаяЧастьОПВ.Организация КАК Организация,
		|		ОПВРасчетыСФондами.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|		ВЫБОР
		|			КОГДА ТабличнаяЧастьОПВ.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ОПВРасчетыСФондами.ПодразделениеОрганизации 
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ КАК ПодразделениеОрганизации,
		|		ОПВРасчетыСФондами.Взнос КАК Взнос,
		|		0 КАК ОблагаемаяБаза
		|	ИЗ
		|		РегистрНакопления.ОПВРасчетыСФондами КАК ОПВРасчетыСФондами
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ТабличнаяЧастьОПВ
		|			ПО ОПВРасчетыСФондами.ФизЛицо = ТабличнаяЧастьОПВ.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ОПВРасчетыСФондами.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьОПВ.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ОПВРасчетыСФондами.МесяцНалоговогоПериода, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьОПВ.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьОПВ.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))
		|               И ОПВРасчетыСФондами.Налогоплательщик = &Налогоплательщик 
		|				И ОПВРасчетыСФондами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 
		|				И ОПВРасчетыСФондами.ВидПлатежа = ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) 
		|				И ОПВРасчетыСФондами.ВидСтроки = ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление)
		|
		|	ГДЕ
		|		ОПВРасчетыСФондами.Активность
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьОПВ.НомерСтроки,
		|		ОПВСведенияОДоходах.ФизЛицо,
		|		ОПВСведенияОДоходах.Период,
		|		ОПВСведенияОДоходах.ПериодРегистрации,
		|		ТабличнаяЧастьОПВ.Организация,
		|		ОПВСведенияОДоходах.СтруктурнаяЕдиница,
		|		ВЫБОР 
		|			КОГДА ТабличнаяЧастьОПВ.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ОПВСведенияОДоходах.ПодразделениеОрганизации
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ,
		|		0,
		|		ОПВСведенияОДоходах.ОблагаемаяБазаОборот
		|	ИЗ
		|		РегистрНакопления.ОПВСведенияОДоходах.Обороты(
		|				,
		|				,
		|				Месяц,
		|				Налогоплательщик = &Налогоплательщик
		|					И ПериодРегистрации = &Период
		|					И СпособНалогообложения = ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом)) КАК ОПВСведенияОДоходах
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ТабличнаяЧастьОПВ
		|			ПО ОПВСведенияОДоходах.ФизЛицо = ТабличнаяЧастьОПВ.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ОПВСведенияОДоходах.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьОПВ.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ОПВСведенияОДоходах.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьОПВ.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьОПВ.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))) КАК РанееИсчисленныйОПВ
		|		
		|СГРУППИРОВАТЬ ПО
		|	РанееИсчисленныйОПВ.НомерСтроки,
		|	РанееИсчисленныйОПВ.ФизЛицо,
		|	РанееИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	РанееИсчисленныйОПВ.ПериодРегистрации,
		|	РанееИсчисленныйОПВ.Организация,
		|	РанееИсчисленныйОПВ.СтруктурнаяЕдиница,
		|	РанееИсчисленныйОПВ.ПодразделениеОрганизации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	РанееИсчисленныеВОСМС.НомерСтроки,
		|	РанееИсчисленныеВОСМС.ФизЛицо,
		|	РанееИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	РанееИсчисленныеВОСМС.ПериодРегистрации,
		|	РанееИсчисленныеВОСМС.Организация,
		|	РанееИсчисленныеВОСМС.СтруктурнаяЕдиница,
		|	РанееИсчисленныеВОСМС.ПодразделениеОрганизации,
		|	СУММА(РанееИсчисленныеВОСМС.Взнос) КАК Взнос,
		|	СУММА(РанееИсчисленныеВОСМС.ОблагаемаяБаза) КАК ОблагаемаяБаза
		|ПОМЕСТИТЬ ВТ_РанееИсчисленныеВОСМС
		|ИЗ
		|	(ВЫБРАТЬ
		|		ТабличнаяЧастьВОСМС.НомерСтроки КАК НомерСтроки,
		|		ВОСМСРасчетыСФондами.ФизЛицо КАК ФизЛицо,
		|		ВОСМСРасчетыСФондами.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		НАЧАЛОПЕРИОДА(ВОСМСРасчетыСФондами.Период, МЕСЯЦ) КАК ПериодРегистрации,
		|		ТабличнаяЧастьВОСМС.Организация КАК Организация,
		|		ВОСМСРасчетыСФондами.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
		|		ВЫБОР
		|			КОГДА ТабличнаяЧастьВОСМС.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ВОСМСРасчетыСФондами.ПодразделениеОрганизации 
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ КАК ПодразделениеОрганизации,
		|		ВОСМСРасчетыСФондами.Взнос КАК Взнос,
		|		0 КАК ОблагаемаяБаза
		|	ИЗ
		|		РегистрНакопления.ВОСМСРасчетыСФондами КАК ВОСМСРасчетыСФондами
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ТабличнаяЧастьВОСМС
		|			ПО ВОСМСРасчетыСФондами.ФизЛицо = ТабличнаяЧастьВОСМС.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ВОСМСРасчетыСФондами.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьВОСМС.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ВОСМСРасчетыСФондами.МесяцНалоговогоПериода, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьВОСМС.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьВОСМС.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))
		|               И ВОСМСРасчетыСФондами.Налогоплательщик = &Налогоплательщик 
		|				И ВОСМСРасчетыСФондами.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 
		|				И ВОСМСРасчетыСФондами.ВидПлатежа = ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) 
		|				И ВОСМСРасчетыСФондами.ВидСтроки = ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление)
		|
		|	ГДЕ
		|		ВОСМСРасчетыСФондами.Активность
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьВОСМС.НомерСтроки,
		|		ВОСМССведенияОДоходах.ФизЛицо,
		|		ВОСМССведенияОДоходах.Период,
		|		ВОСМССведенияОДоходах.ПериодРегистрации,
		|		ТабличнаяЧастьВОСМС.Организация,
		|		ВОСМССведенияОДоходах.СтруктурнаяЕдиница,
		|		ВЫБОР 
		|			КОГДА ТабличнаяЧастьВОСМС.РаспределятьНалогиПоПодразделениямОрганизаций
		|				ТОГДА ВОСМССведенияОДоходах.ПодразделениеОрганизации
		|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|		КОНЕЦ,
		|		0,
		|		ВОСМССведенияОДоходах.ОблагаемаяБазаОборот
		|	ИЗ
		|		РегистрНакопления.ВОСМССведенияОДоходах.Обороты(
		|				,
		|				,
		|				Месяц,
		|				Налогоплательщик = &Налогоплательщик
		|					И ПериодРегистрации = &Период
		|					И СпособНалогообложения = ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом)) КАК ВОСМССведенияОДоходах
		|
		|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ТабличнаяЧастьВОСМС
		|			ПО ВОСМССведенияОДоходах.ФизЛицо = ТабличнаяЧастьВОСМС.ФизЛицо
		|				И (НАЧАЛОПЕРИОДА(ВОСМССведенияОДоходах.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ТабличнаяЧастьВОСМС.ПериодРегистрации, МЕСЯЦ))
		|				И (НАЧАЛОПЕРИОДА(ВОСМССведенияОДоходах.Период, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА ТабличнаяЧастьВОСМС.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьВОСМС.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ))) КАК РанееИсчисленныеВОСМС
		|		
		|СГРУППИРОВАТЬ ПО
		|	РанееИсчисленныеВОСМС.НомерСтроки,
		|	РанееИсчисленныеВОСМС.ФизЛицо,
		|	РанееИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	РанееИсчисленныеВОСМС.ПериодРегистрации,
		|	РанееИсчисленныеВОСМС.Организация,
		|	РанееИсчисленныеВОСМС.СтруктурнаяЕдиница,
		|	РанееИсчисленныеВОСМС.ПодразделениеОрганизации
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсчисленныйИПН.НомерСтроки,
		|	ИсчисленныйИПН.ФизЛицо,
		|	ИсчисленныйИПН.МесяцНалоговогоПериода,
		|	ИсчисленныйИПН.ПериодРегистрации,
		|	ИсчисленныйИПН.Организация,
		|	СУММА(ИсчисленныйИПН.Налог) КАК Налог,
		|	СУММА(ИсчисленныйИПН.ОблагаемаяБаза) КАК ОблагаемаяБаза,
		|	СУММА(ИсчисленныйИПН.ПримененныйВычет) КАК ПримененныйВычет,
		|	СУММА(ИсчисленныйИПН.ПримененнаяЛьгота) КАК ПримененнаяЛьгота,
		|	СУММА(ИсчисленныйИПН.РазрешенныйВычет) КАК РазрешенныйВычет
		|ПОМЕСТИТЬ ВТ_ИсчисленныйИПН
		|ИЗ
		|	(ВЫБРАТЬ
		|		РанееИсчисленныйИПН.НомерСтроки КАК НомерСтроки,
		|		РанееИсчисленныйИПН.ФизЛицо КАК ФизЛицо,
		|		РанееИсчисленныйИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		РанееИсчисленныйИПН.ПериодРегистрации КАК ПериодРегистрации,
		|		РанееИсчисленныйИПН.Организация КАК Организация,
		|		РанееИсчисленныйИПН.Налог КАК Налог,
		|		РанееИсчисленныйИПН.ОблагаемаяБаза КАК ОблагаемаяБаза,
		|		РанееИсчисленныйИПН.ПримененныйВычет КАК ПримененныйВычет,
		|		РанееИсчисленныйИПН.ПримененнаяЛьгота КАК ПримененнаяЛьгота,
		|		РанееИсчисленныйИПН.РазрешенныйВычет КАК РазрешенныйВычет
		|	ИЗ
		|		ВТ_РанееИсчисленныйИПН КАК РанееИсчисленныйИПН
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьИПН.НомерСтроки,
		|		ТабличнаяЧастьИПН.ФизЛицо,
		|		ТабличнаяЧастьИПН.МесяцНалоговогоПериода,
		|		ТабличнаяЧастьИПН.ПериодРегистрации,
		|		ТабличнаяЧастьИПН.Организация,
		|		ТабличнаяЧастьИПН.Налог,
		|		ТабличнаяЧастьИПН.ОблагаемаяБаза,
		|		ТабличнаяЧастьИПН.ПримененныйВычет,
		|		ТабличнаяЧастьИПН.ПримененнаяЛьгота,
		|		ТабличнаяЧастьИПН.РазрешенныйВычет
		|	ИЗ
		|		ВТ_ТабличнаяЧастьИПН КАК ТабличнаяЧастьИПН) КАК ИсчисленныйИПН
		|
		|СГРУППИРОВАТЬ ПО
		|	ИсчисленныйИПН.НомерСтроки,
		|	ИсчисленныйИПН.ФизЛицо,
		|	ИсчисленныйИПН.МесяцНалоговогоПериода,
		|	ИсчисленныйИПН.ПериодРегистрации,
		|	ИсчисленныйИПН.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсчисленныйОПВ.НомерСтроки,
		|	ИсчисленныйОПВ.ФизЛицо,
		|	ИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	ИсчисленныйОПВ.ПериодРегистрации,
		|	ИсчисленныйОПВ.Организация,
		|	СУММА(ИсчисленныйОПВ.Взнос) КАК Взнос,
		|	СУММА(ИсчисленныйОПВ.ОблагаемаяБаза) КАК ОблагаемаяБаза
		|ПОМЕСТИТЬ ВТ_ИсчисленныйОПВ
		|ИЗ
		|	(ВЫБРАТЬ
		|		РанееИсчисленныйОПВ.НомерСтроки КАК НомерСтроки,
		|		РанееИсчисленныйОПВ.ФизЛицо КАК ФизЛицо,
		|		РанееИсчисленныйОПВ.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		РанееИсчисленныйОПВ.ПериодРегистрации КАК ПериодРегистрации,
		|		РанееИсчисленныйОПВ.Организация КАК Организация,
		|		РанееИсчисленныйОПВ.Взнос КАК Взнос,
		|		РанееИсчисленныйОПВ.ОблагаемаяБаза КАК ОблагаемаяБаза
		|	ИЗ
		|		ВТ_РанееИсчисленныйОПВ КАК РанееИсчисленныйОПВ
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьОПВ.НомерСтроки,
		|		ТабличнаяЧастьОПВ.ФизЛицо,
		|		ТабличнаяЧастьОПВ.МесяцНалоговогоПериода,
		|		ТабличнаяЧастьОПВ.ПериодРегистрации,
		|		ТабличнаяЧастьОПВ.Организация,
		|		ТабличнаяЧастьОПВ.Взнос,
		|		ТабличнаяЧастьОПВ.ОблагаемаяБаза
		|	ИЗ
		|		ВТ_ТабличнаяЧастьОПВ КАК ТабличнаяЧастьОПВ) КАК ИсчисленныйОПВ
		|
		|СГРУППИРОВАТЬ ПО
		|	ИсчисленныйОПВ.НомерСтроки,
		|	ИсчисленныйОПВ.ФизЛицо,
		|	ИсчисленныйОПВ.МесяцНалоговогоПериода,
		|	ИсчисленныйОПВ.ПериодРегистрации,
		|	ИсчисленныйОПВ.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ИсчисленныеВОСМС.НомерСтроки,
		|	ИсчисленныеВОСМС.ФизЛицо,
		|	ИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	ИсчисленныеВОСМС.ПериодРегистрации,
		|	ИсчисленныеВОСМС.Организация,
		|	СУММА(ИсчисленныеВОСМС.Взнос) КАК Взнос,
		|	СУММА(ИсчисленныеВОСМС.ОблагаемаяБаза) КАК ОблагаемаяБаза
		|ПОМЕСТИТЬ ВТ_ИсчисленныеВОСМС
		|ИЗ
		|	(ВЫБРАТЬ
		|		РанееИсчисленныеВОСМС.НомерСтроки КАК НомерСтроки,
		|		РанееИсчисленныеВОСМС.ФизЛицо КАК ФизЛицо,
		|		РанееИсчисленныеВОСМС.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|		РанееИсчисленныеВОСМС.ПериодРегистрации КАК ПериодРегистрации,
		|		РанееИсчисленныеВОСМС.Организация КАК Организация,
		|		РанееИсчисленныеВОСМС.Взнос КАК Взнос,
		|		РанееИсчисленныеВОСМС.ОблагаемаяБаза КАК ОблагаемаяБаза
		|	ИЗ
		|		ВТ_РанееИсчисленныеВОСМС КАК РанееИсчисленныеВОСМС
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ТабличнаяЧастьВОСМС.НомерСтроки,
		|		ТабличнаяЧастьВОСМС.ФизЛицо,
		|		ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода,
		|		ТабличнаяЧастьВОСМС.ПериодРегистрации,
		|		ТабличнаяЧастьВОСМС.Организация,
		|		ТабличнаяЧастьВОСМС.Взнос,
		|		ТабличнаяЧастьВОСМС.ОблагаемаяБаза
		|	ИЗ
		|		ВТ_ТабличнаяЧастьВОСМС КАК ТабличнаяЧастьВОСМС) КАК ИсчисленныеВОСМС
		|
		|СГРУППИРОВАТЬ ПО
		|	ИсчисленныеВОСМС.НомерСтроки,
		|	ИсчисленныеВОСМС.ФизЛицо,
		|	ИсчисленныеВОСМС.МесяцНалоговогоПериода,
		|	ИсчисленныеВОСМС.ПериодРегистрации,
		|	ИсчисленныеВОСМС.Организация";
		
	ЗапросРаспределения.Выполнить();
	
	ЗапросРаспределения.Текст = "
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьИПН.ФизЛицо,
		|	ВЫБОР 
		|		КОГДА ВТ_ТабличнаяЧастьИПН.ОтражениеПоПериодуРегистрации
		|			ТОГДА ВТ_ТабличнаяЧастьИПН.ПериодРегистрации
		|		ИНАЧЕ ВТ_ТабличнаяЧастьИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ПОМЕСТИТЬ ВТ_ПериодыСотрудников
		|ИЗ
		|	ВТ_ТабличнаяЧастьИПН 
		|
		|ОБЪЕДИНИТЬ // выбираем только различающиеся строки (без ВСЕ)
		|
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьОПВ.ФизЛицо,
		|	ВЫБОР
		|		КОГДА ВТ_ТабличнаяЧастьОПВ.ОтражениеПоПериодуРегистрации
		|			ТОГДА ВТ_ТабличнаяЧастьОПВ.ПериодРегистрации
		|		ИНАЧЕ ВТ_ТабличнаяЧастьОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ИЗ
		|	ВТ_ТабличнаяЧастьОПВ
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьВОСМС.ФизЛицо,
		|	ВЫБОР
		|		КОГДА ВТ_ТабличнаяЧастьВОСМС.ОтражениеПоПериодуРегистрации
		|			ТОГДА ВТ_ТабличнаяЧастьВОСМС.ПериодРегистрации
		|		ИНАЧЕ ВТ_ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ИЗ
		|	ВТ_ТабличнаяЧастьВОСМС
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьУдержания.ФизЛицо,
		|	ВТ_ТабличнаяЧастьУдержания.ПериодРегистрации КАК Период
		|ИЗ
		|	ВТ_ТабличнаяЧастьУдержания
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьНалоговыеВычеты.ФизЛицо,
		|	ВЫБОР
		|		КОГДА ВТ_ТабличнаяЧастьНалоговыеВычеты.ОтражениеПоПериодуРегистрации
		|			ТОГДА ВТ_ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации
		|		ИНАЧЕ ВТ_ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ИЗ
		|	ВТ_ТабличнаяЧастьНалоговыеВычеты
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ВТ_ТабличнаяЧастьВычетыИПН.ФизЛицо,
		|	ВЫБОР
		|		КОГДА ВТ_ТабличнаяЧастьВычетыИПН.ОтражениеПоПериодуРегистрации
		|			ТОГДА ВТ_ТабличнаяЧастьВычетыИПН.ПериодРегистрации
		|		ИНАЧЕ ВТ_ТабличнаяЧастьВычетыИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК Период
		|ИЗ
		|	ВТ_ТабличнаяЧастьВычетыИПН
		|";
		
	ЗапросРаспределения.Текст = ЗапросРаспределения.Текст 
				 + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета()
				 + РасчетЗарплатыСервер.СформироватьТекстЗапросаСтруктурныеЕдиницы("ВТ_ПериодыСотрудников", Истина) 
				 + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	ЗапросРаспределения.Выполнить();
	
	// ОБЯЗАТЕЛЬНЫЕ ПЕНСИОННЫЕ ВЗНОСЫ
	
	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТабличнаяЧастьОПВ.НомерСтроки,
		|	ТабличнаяЧастьОПВ.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьОПВ.ПериодРегистрации,
		|	ТабличнаяЧастьОПВ.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ КАК ПериодДоходов,
		|	ВЫБОР 
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьОПВ.Организация
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|	ВЫБОР
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьОПВ.Организация
		|	КОНЕЦ КАК Организация,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций 
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ОПВСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ОПВСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ КАК ПодразделениеОрганизации,
		|	СУММА(ЕСТЬNULL(ОПВСведенияОДоходахОбороты.СуммаДоходаОборот, 0) - ЕСТЬNULL(ОПВСведенияОДоходахОбороты.СуммаВычетаОборот, 0)) КАК ОблагаемыйДоход
		|ПОМЕСТИТЬ ВТ_СведенияОДоходахОПВ
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК ТабличнаяЧастьОПВ
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОПВСведенияОДоходах.Обороты(
		|				,
		|				,
		|				Месяц,
		|				ПериодРегистрации = &Период
		|					И ФизЛицо В (ВЫБРАТЬ СписокФизЛиц.ФизЛицо ИЗ ВТ_СписокФизЛиц КАК СписокФизЛиц)
		|					И Налогоплательщик = &Налогоплательщик
		|					И СпособНалогообложения <> ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.НеОблагаетсяЦеликом)) КАК ОПВСведенияОДоходахОбороты
		|		ПО ТабличнаяЧастьОПВ.ФизЛицо = ОПВСведенияОДоходахОбороты.ФизЛицо
		|			И (НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьОПВ.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ОПВСведенияОДоходахОбороты.Период, МЕСЯЦ))
		|			И (НАЧАЛОПЕРИОДА(ТабличнаяЧастьОПВ.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ОПВСведенияОДоходахОбороты.ПериодРегистрации, МЕСЯЦ))
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестаРаботы
		|		ПО ТабличнаяЧастьОПВ.ФизЛицо = МестаРаботы.ФизЛицо
		|			И (ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьОПВ.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода КОНЕЦ) = МестаРаботы.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ТабличнаяЧастьОПВ.НомерСтроки,
		|	ТабличнаяЧастьОПВ.ФизЛицо,
		|	ТабличнаяЧастьОПВ.ПериодРегистрации,
		|	ТабличнаяЧастьОПВ.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьОПВ.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	ВЫБОР 
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьОПВ.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ (ОПВСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ОПВСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьОПВ.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций 
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ОПВСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ОПВСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабличнаяЧастьОПВ.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьОПВ.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьОПВ.Взнос КАК Взнос,
		|	ТабличнаяЧастьОПВ.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|	ТабличнаяЧастьОПВ.ОблагаемаяБаза КАК ОблагаемаяБаза,
		|	СведенияОДоходахОПВ.СтруктурнаяЕдиница,
		|	СведенияОДоходахОПВ.Организация КАК Организация,
		|	СведенияОДоходахОПВ.ПодразделениеОрганизации,
		|	СведенияОДоходахОПВ.ОблагаемыйДоход,
		|	ОбщаяСуммаДоходов.ОблагаемыйДоход КАК ОблагаемыйДоходВсего,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.ПорядокОкругления, ОбщийПорядокОкругления.ПорядокОкругления) КАК ПорядокОкругления,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.МетодОкругления, ОбщийПорядокОкругления.МетодОкругления) КАК МетодОкругления
		|ИЗ
		|	ВТ_ИсчисленныйОПВ КАК ТабличнаяЧастьОПВ
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахОПВ.НомерСтроки КАК НомерСтроки,
		|			СведенияОДоходахОПВ.ФизЛицо КАК ФизЛицо,
		|			СведенияОДоходахОПВ.ПериодРегистрации КАК ПериодРегистрации,
		|			СведенияОДоходахОПВ.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|			СведенияОДоходахОПВ.ПериодДоходов КАК ПериодДоходов,
		|			СУММА(СведенияОДоходахОПВ.ОблагаемыйДоход) КАК ОблагаемыйДоход
		|		ИЗ
		|			ВТ_СведенияОДоходахОПВ КАК СведенияОДоходахОПВ
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахОПВ.НомерСтроки,
		|			СведенияОДоходахОПВ.ФизЛицо,
		|			СведенияОДоходахОПВ.ПериодРегистрации,
		|			СведенияОДоходахОПВ.МесяцНалоговогоПериода,
		|			СведенияОДоходахОПВ.ПериодДоходов) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьОПВ.НомерСтроки = ОбщаяСуммаДоходов.НомерСтроки
		|			И ТабличнаяЧастьОПВ.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахОПВ КАК СведенияОДоходахОПВ
		|		ПО ТабличнаяЧастьОПВ.ФизЛицо = СведенияОДоходахОПВ.ФизЛицо
		|			И ТабличнаяЧастьОПВ.НомерСтроки = СведенияОДоходахОПВ.НомерСтроки
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО (ИндивидуальныйПорядокОкругления.ВидРасчета = ЗНАЧЕНИЕ(Справочник.НалогиСборыОтчисления.ОбязательныеПенсионныеВзносы))
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо,
		|	МесяцНалоговогоПериода
		|ИТОГИ
		|	МАКСИМУМ(Взнос),
		|	МАКСИМУМ(ОблагаемаяБаза),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";
	
	РезультатЗапросаОПВ = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияОПВ = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Дата"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("МесяцНалоговогоПериода", Новый ОписаниеТипов(МассивТипов, Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("Взнос", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияОПВ.Колонки.Добавить("ОблагаемаяБаза", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("Взнос");
	КолонкиДляРаспределения.Добавить("ОблагаемаяБаза");
	
	КолонкаКоэффициентов = "ОблагаемыйДоход";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияОПВ, РезультатЗапросаОПВ, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияОПВ.Свернуть("НомерСтроки, ФизЛицо, СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации, МесяцНалоговогоПериода", 
									 "Взнос, ОблагаемаяБаза");
									 
									 
	// ИНДИВИДУАЛЬНЫЙ ПОДОХОДНЫЙ НАЛОГ

	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИПНСведенияОДоходахОбороты.ФизЛицо,
		|	ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница,
		|	ИПНСведенияОДоходахОбороты.ПериодРегистрации,
		|	ИПНСведенияОДоходахОбороты.Организация,
		|	ИПНСведенияОДоходахОбороты.Налогоплательщик,
		|	ИПНСведенияОДоходахОбороты.СпособНалогообложения,
		|	ИПНСведенияОДоходахОбороты.ВидРасчета,
		|	ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации,
		|	ИПНСведенияОДоходахОбороты.Период,
		|	ИПНСведенияОДоходахОбороты.СуммаДоходаОборот КАК СуммаДохода,
		|	ИПНСведенияОДоходахОбороты.СуммаДоходаОборот - ИПНСведенияОДоходахОбороты.СуммаВычетаОборот КАК ОблагаемыйДоход
		|ПОМЕСТИТЬ ВТ_ИПНСведенияОДоходах
		|ИЗ
		|	РегистрНакопления.ИПНСведенияОДоходах.Обороты(
		|			,
		|			,
		|			Месяц,
		|			ПериодРегистрации = &Период
		|				И ФизЛицо В
		|					(ВЫБРАТЬ СписокФизЛиц.ФизЛицо ИЗ ВТ_СписокФизЛиц КАК СписокФизЛиц)
		|				И Налогоплательщик = &Налогоплательщик
		|				И НЕ ВидРасчета ССЫЛКА Справочник.ВычетыИПН) КАК ИПНСведенияОДоходахОбороты
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТабличнаяЧастьИПН.НомерСтроки,
		|	ТабличнаяЧастьИПН.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьИПН.ПериодРегистрации,
		|	ТабличнаяЧастьИПН.МесяцНалоговогоПериода,		
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода
		|	КОНЕЦ КАК ПериодДоходов,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьИПН.Организация
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьИПН.Организация
		|	КОНЕЦ КАК Организация,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ КАК ПодразделениеОрганизации,
		|	СУММА(ЕСТЬNULL(ИПНСведенияОДоходахОбороты.ОблагаемыйДоход, 0)) КАК ОблагаемыйДоход
		|ПОМЕСТИТЬ ВТ_СведенияОДоходахИПН
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК ТабличнаяЧастьИПН
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ИПНСведенияОДоходах КАК ИПНСведенияОДоходахОбороты
		|		ПО ТабличнаяЧастьИПН.ФизЛицо = ИПНСведенияОДоходахОбороты.ФизЛицо		
		|			И (НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьИПН.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ИПНСведенияОДоходахОбороты.Период, МЕСЯЦ))
		|			И (НАЧАЛОПЕРИОДА(ТабличнаяЧастьИПН.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ИПНСведенияОДоходахОбороты.ПериодРегистрации, МЕСЯЦ))
		|			И ИПНСведенияОДоходахОбороты.СпособНалогообложения <> ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.НеОблагаетсяЦеликом)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестаРаботы
		|		ПО ТабличнаяЧастьИПН.ФизЛицо = МестаРаботы.ФизЛицо
		|			И (ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьИПН.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода КОНЕЦ)= МестаРаботы.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ТабличнаяЧастьИПН.НомерСтроки,
		|	ТабличнаяЧастьИПН.ФизЛицо,
		|	ТабличнаяЧастьИПН.ПериодРегистрации,
		|	ТабличнаяЧастьИПН.МесяцНалоговогоПериода,		
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьИПН.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьИПН.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьИПН.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА 
		|				ВЫБОР
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабличнаяЧастьИПН.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьИПН.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьИПН.Налог КАК Налог,
		|	ТабличнаяЧастьИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,		
		|	ТабличнаяЧастьИПН.ОблагаемаяБаза КАК ОблагаемаяБаза,
		|	ТабличнаяЧастьИПН.ПримененныйВычет КАК ПримененныйВычет,
		|	ТабличнаяЧастьИПН.ПримененнаяЛьгота КАК ПримененнаяЛьгота,
		|	ТабличнаяЧастьИПН.РазрешенныйВычет КАК РазрешенныйВычет,
		|	СведенияОДоходахИПН.СтруктурнаяЕдиница,
		|	СведенияОДоходахИПН.Организация КАК Организация,
		|	СведенияОДоходахИПН.ПодразделениеОрганизации,
		|	СведенияОДоходахИПН.ОблагаемыйДоход,
		|	ОбщаяСуммаДоходов.ОблагаемыйДоход КАК ОблагаемыйДоходВсего,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.ПорядокОкругления, ОбщийПорядокОкругления.ПорядокОкругления) КАК ПорядокОкругления,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.МетодОкругления, ОбщийПорядокОкругления.МетодОкругления) КАК МетодОкругления
		|ИЗ
		|	ВТ_ИсчисленныйИПН КАК ТабличнаяЧастьИПН
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахИПН.НомерСтроки КАК НомерСтроки,
		|			СведенияОДоходахИПН.ФизЛицо КАК ФизЛицо,		
		|			СведенияОДоходахИПН.ПериодРегистрации КАК ПериодРегистрации,
		|			СведенияОДоходахИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|			СведенияОДоходахИПН.ПериодДоходов КАК ПериодДоходов,
		|			СУММА(СведенияОДоходахИПН.ОблагаемыйДоход) КАК ОблагаемыйДоход
		|		ИЗ
		|			ВТ_СведенияОДоходахИПН КАК СведенияОДоходахИПН
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахИПН.НомерСтроки,
		|			СведенияОДоходахИПН.ФизЛицо,		
		|			СведенияОДоходахИПН.ПериодРегистрации,
		|			СведенияОДоходахИПН.МесяцНалоговогоПериода,
		|			СведенияОДоходахИПН.ПериодДоходов) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьИПН.НомерСтроки = ОбщаяСуммаДоходов.НомерСтроки
		|			И ТабличнаяЧастьИПН.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо		
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахИПН КАК СведенияОДоходахИПН
		|		ПО ТабличнаяЧастьИПН.ФизЛицо = СведенияОДоходахИПН.ФизЛицо
		|			И ТабличнаяЧастьИПН.НомерСтроки = СведенияОДоходахИПН.НомерСтроки		
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО (ИндивидуальныйПорядокОкругления.ВидРасчета = ЗНАЧЕНИЕ(Справочник.НалогиСборыОтчисления.ИндивидуальныйПодоходныйНалог))
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо,
		|	МесяцНалоговогоПериода		
		|ИТОГИ
		|	МАКСИМУМ(Налог),
		|	МАКСИМУМ(ОблагаемаяБаза),
		|	МАКСИМУМ(ПримененныйВычет),
		|	МАКСИМУМ(ПримененнаяЛьгота),
		|	МАКСИМУМ(РазрешенныйВычет),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";
	
	РезультатЗапросаИПН = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияИПН = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Дата"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("МесяцНалоговогоПериода", Новый ОписаниеТипов(МассивТипов, Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияИПН.Колонки.Добавить("Налог", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияИПН.Колонки.Добавить("ОблагаемаяБаза", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
 	ТаблицаРаспределенияИПН.Колонки.Добавить("ПримененныйВычет", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияИПН.Колонки.Добавить("ПримененнаяЛьгота", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияИПН.Колонки.Добавить("РазрешенныйВычет", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("Налог");
	КолонкиДляРаспределения.Добавить("ОблагаемаяБаза");
	КолонкиДляРаспределения.Добавить("ПримененныйВычет");
	КолонкиДляРаспределения.Добавить("ПримененнаяЛьгота");
	КолонкиДляРаспределения.Добавить("РазрешенныйВычет");
	
	КолонкаКоэффициентов = "ОблагаемыйДоход";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияИПН, РезультатЗапросаИПН, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияИПН.Свернуть("НомерСтроки, ФизЛицо, СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации, МесяцНалоговогоПериода", 
									 "Налог, ОблагаемаяБаза, ПримененныйВычет, ПримененнаяЛьгота, РазрешенныйВычет");
	
	
	// НАЛОГОВЫЕ ВЫЧЕТЫ
	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТабличнаяЧастьНалоговыеВычеты.НомерСтроки,
		|	ТабличнаяЧастьНалоговыеВычеты.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьНалоговыеВычеты.ВычетИПН КАК ВычетИПН,
		|	ТабличнаяЧастьНалоговыеВычеты.ДокументОснование КАК ДокументОснование,
		|	ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации,
		|	ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ КАК ПериодДоходов,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.Организация
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.Организация
		|	КОНЕЦ КАК Организация,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА 
		|				ВЫБОР 
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ КАК ПодразделениеОрганизации,
		|	СУММА(ЕСТЬNULL(ИПНСведенияОДоходахОбороты.ОблагаемыйДоход, 0)) КАК ОблагаемыйДоход
		|ПОМЕСТИТЬ ВТ_СведенияОДоходахНалоговыеВычеты
		|ИЗ
		|	ВТ_ТабличнаяЧастьНалоговыеВычеты КАК ТабличнаяЧастьНалоговыеВычеты
		|
		|	    ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ИПНСведенияОДоходах КАК ИПНСведенияОДоходахОбороты
		|		ПО ТабличнаяЧастьНалоговыеВычеты.ФизЛицо = ИПНСведенияОДоходахОбороты.ФизЛицо
		|			И (НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ИПНСведенияОДоходахОбороты.Период, МЕСЯЦ))
		|			И (НАЧАЛОПЕРИОДА(ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ИПНСведенияОДоходахОбороты.ПериодРегистрации, МЕСЯЦ))
		|			И ИПНСведенияОДоходахОбороты.СпособНалогообложения <> ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.НеОблагаетсяЦеликом)		
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестаРаботы
		|		ПО ТабличнаяЧастьНалоговыеВычеты.ФизЛицо = МестаРаботы.ФизЛицо
		|			И (ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода КОНЕЦ)= МестаРаботы.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ТабличнаяЧастьНалоговыеВычеты.НомерСтроки,
		|	ТабличнаяЧастьНалоговыеВычеты.ФизЛицо,
		|	ТабличнаяЧастьНалоговыеВычеты.ВычетИПН,
		|	ТабличнаяЧастьНалоговыеВычеты.ДокументОснование,
		|	ТабличнаяЧастьНалоговыеВычеты.ПериодРегистрации,
		|	ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.Организация
		|	КОНЕЦ,
		|	ВЫБОР 
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьНалоговыеВычеты.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА 
		|				ВЫБОР 
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабличнаяЧастьНалоговыеВычеты.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьНалоговыеВычеты.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьНалоговыеВычеты.ВычетИПН КАК ВычетИПН,
		|	ТабличнаяЧастьНалоговыеВычеты.ДокументОснование КАК ДокументОснование,
		|	ТабличнаяЧастьНалоговыеВычеты.СуммаВычета КАК СуммаВычета,
		|	ТабличнаяЧастьНалоговыеВычеты.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|	СведенияОДоходахНалоговыеВычеты.СтруктурнаяЕдиница,
		|	СведенияОДоходахНалоговыеВычеты.Организация КАК Организация,
		|	СведенияОДоходахНалоговыеВычеты.ПодразделениеОрганизации,
		|	СведенияОДоходахНалоговыеВычеты.ОблагаемыйДоход,
		|	ОбщаяСуммаДоходов.ОблагаемыйДоход КАК ОблагаемыйДоходВсего,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.ПорядокОкругления, ОбщийПорядокОкругления.ПорядокОкругления) КАК ПорядокОкругления,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.МетодОкругления, ОбщийПорядокОкругления.МетодОкругления) КАК МетодОкругления
		|ИЗ
		|	ВТ_ТабличнаяЧастьНалоговыеВычеты КАК ТабличнаяЧастьНалоговыеВычеты
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахНалоговыеВычеты.НомерСтроки КАК НомерСтроки,
		|			СведенияОДоходахНалоговыеВычеты.ФизЛицо КАК ФизЛицо,
		|			СведенияОДоходахНалоговыеВычеты.ВычетИПН КАК ВычетИПН,
		|			СведенияОДоходахНалоговыеВычеты.ДокументОснование КАК ДокументОснование,
		|			СведенияОДоходахНалоговыеВычеты.ПериодРегистрации КАК ПериодРегистрации,
		|			СведенияОДоходахНалоговыеВычеты.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|			СведенияОДоходахНалоговыеВычеты.ПериодДоходов КАК ПериодДоходов,
		|			СУММА(СведенияОДоходахНалоговыеВычеты.ОблагаемыйДоход) КАК ОблагаемыйДоход
		|		ИЗ
		|			ВТ_СведенияОДоходахНалоговыеВычеты КАК СведенияОДоходахНалоговыеВычеты
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахНалоговыеВычеты.НомерСтроки,
		|			СведенияОДоходахНалоговыеВычеты.ФизЛицо,
		|			СведенияОДоходахНалоговыеВычеты.ВычетИПН,
		|			СведенияОДоходахНалоговыеВычеты.ДокументОснование,
		|			СведенияОДоходахНалоговыеВычеты.ПериодРегистрации,
		|			СведенияОДоходахНалоговыеВычеты.МесяцНалоговогоПериода,
		|			СведенияОДоходахНалоговыеВычеты.ПериодДоходов) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьНалоговыеВычеты.НомерСтроки = ОбщаяСуммаДоходов.НомерСтроки
		|			И ТабличнаяЧастьНалоговыеВычеты.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахНалоговыеВычеты КАК СведенияОДоходахНалоговыеВычеты
		|		ПО ТабличнаяЧастьНалоговыеВычеты.ФизЛицо = СведенияОДоходахНалоговыеВычеты.ФизЛицо
		|			И ТабличнаяЧастьНалоговыеВычеты.НомерСтроки = СведенияОДоходахНалоговыеВычеты.НомерСтроки
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО (ИндивидуальныйПорядокОкругления.ВидРасчета = ЗНАЧЕНИЕ(Справочник.НалогиСборыОтчисления.ИндивидуальныйПодоходныйНалог))
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо,
		|	МесяцНалоговогоПериода
		|ИТОГИ
		|	МАКСИМУМ(СуммаВычета),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";
	
	РезультатЗапросаНалоговыеВычеты = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияНалоговыхВычетов = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ВычетыИПН"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("ВычетИПН", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("ДокументСсылка.ИПНЗаявлениеНаПредоставлениеВычета"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("ДокументОснование", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Дата"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("МесяцНалоговогоПериода", Новый ОписаниеТипов(МассивТипов, Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияНалоговыхВычетов.Колонки.Добавить("СуммаВычета", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("СуммаВычета");
	
	КолонкаКоэффициентов = "ОблагаемыйДоход";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияНалоговыхВычетов, РезультатЗапросаНалоговыеВычеты, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияНалоговыхВычетов.Свернуть("НомерСтроки, ФизЛицо, ВычетИПН, ДокументОснование, СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации, МесяцНалоговогоПериода", 
												  "СуммаВычета");
	
	// ВЗНОСЫ НА ОБЯЗАТЕЛЬНОЕ СОЦИАЛЬНОЕ МЕДИЦИНСКОЕ СТРАХОВАНИЕ
	
	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТабличнаяЧастьВОСМС.НомерСтроки,
		|	ТабличнаяЧастьВОСМС.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьВОСМС.ПериодРегистрации,
		|	ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ КАК ПериодДоходов,
		|	ВЫБОР 
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.Организация
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|	ВЫБОР
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.Организация
		|	КОНЕЦ КАК Организация,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций 
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ВОСМССведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ВОСМССведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ КАК ПодразделениеОрганизации,
		|	СУММА(ЕСТЬNULL(ВОСМССведенияОДоходахОбороты.СуммаДоходаОборот, 0) - ЕСТЬNULL(ВОСМССведенияОДоходахОбороты.СуммаВычетаОборот, 0)) КАК ОблагаемыйДоход
		|ПОМЕСТИТЬ ВТ_СведенияОДоходахВОСМС
		|ИЗ
		|	ВТ_ИсчисленныеВОСМС КАК ТабличнаяЧастьВОСМС
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ВОСМССведенияОДоходах.Обороты(
		|				,
		|				,
		|				Месяц,
		|				ПериодРегистрации = &Период
		|					И ФизЛицо В (ВЫБРАТЬ СписокФизЛиц.ФизЛицо ИЗ ВТ_СписокФизЛиц КАК СписокФизЛиц)
		|					И Налогоплательщик = &Налогоплательщик
		|					И СпособНалогообложения <> ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.НеОблагаетсяЦеликом)) КАК ВОСМССведенияОДоходахОбороты
		|		ПО ТабличнаяЧастьВОСМС.ФизЛицо = ВОСМССведенияОДоходахОбороты.ФизЛицо
		|			И (НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьВОСМС.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода КОНЕЦ, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВОСМССведенияОДоходахОбороты.Период, МЕСЯЦ))
		|			И (НАЧАЛОПЕРИОДА(ТабличнаяЧастьВОСМС.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ВОСМССведенияОДоходахОбороты.ПериодРегистрации, МЕСЯЦ))
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестаРаботы
		|		ПО ТабличнаяЧастьВОСМС.ФизЛицо = МестаРаботы.ФизЛицо
		|			И (ВЫБОР КОГДА Реквизиты.ОтражениеПоПериодуРегистрации ТОГДА ТабличнаяЧастьВОСМС.ПериодРегистрации ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода КОНЕЦ) = МестаРаботы.Период
		|
		|СГРУППИРОВАТЬ ПО
		|	ТабличнаяЧастьВОСМС.НомерСтроки,
		|	ТабличнаяЧастьВОСМС.ФизЛицо,
		|	ТабличнаяЧастьВОСМС.ПериодРегистрации,
		|	ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода,
		|	ВЫБОР 
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.Период ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.Период
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода
		|	КОНЕЦ,
		|	ВЫБОР 
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ (ВОСМССведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ВОСМССведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьВОСМС.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций 
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ВОСМССведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ВОСМССведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ 
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТабличнаяЧастьВОСМС.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьВОСМС.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьВОСМС.Взнос КАК Взнос,
		|	ТабличнаяЧастьВОСМС.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|	ТабличнаяЧастьВОСМС.ОблагаемаяБаза КАК ОблагаемаяБаза,
		|	СведенияОДоходахВОСМС.СтруктурнаяЕдиница,
		|	СведенияОДоходахВОСМС.Организация КАК Организация,
		|	СведенияОДоходахВОСМС.ПодразделениеОрганизации,
		|	СведенияОДоходахВОСМС.ОблагаемыйДоход,
		|	ОбщаяСуммаДоходов.ОблагаемыйДоход КАК ОблагаемыйДоходВсего,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.ПорядокОкругления, ОбщийПорядокОкругления.ПорядокОкругления) КАК ПорядокОкругления,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.МетодОкругления, ОбщийПорядокОкругления.МетодОкругления) КАК МетодОкругления
		|ИЗ
		|	ВТ_ИсчисленныеВОСМС КАК ТабличнаяЧастьВОСМС
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахВОСМС.НомерСтроки КАК НомерСтроки,
		|			СведенияОДоходахВОСМС.ФизЛицо КАК ФизЛицо,
		|			СведенияОДоходахВОСМС.ПериодРегистрации КАК ПериодРегистрации,
		|			СведенияОДоходахВОСМС.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|			СведенияОДоходахВОСМС.ПериодДоходов КАК ПериодДоходов,
		|			СУММА(СведенияОДоходахВОСМС.ОблагаемыйДоход) КАК ОблагаемыйДоход
		|		ИЗ
		|			ВТ_СведенияОДоходахВОСМС КАК СведенияОДоходахВОСМС
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахВОСМС.НомерСтроки,
		|			СведенияОДоходахВОСМС.ФизЛицо,
		|			СведенияОДоходахВОСМС.ПериодРегистрации,
		|			СведенияОДоходахВОСМС.МесяцНалоговогоПериода,
		|			СведенияОДоходахВОСМС.ПериодДоходов) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьВОСМС.НомерСтроки = ОбщаяСуммаДоходов.НомерСтроки
		|			И ТабличнаяЧастьВОСМС.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахВОСМС КАК СведенияОДоходахВОСМС
		|		ПО ТабличнаяЧастьВОСМС.ФизЛицо = СведенияОДоходахВОСМС.ФизЛицо
		|			И ТабличнаяЧастьВОСМС.НомерСтроки = СведенияОДоходахВОСМС.НомерСтроки
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО (ИндивидуальныйПорядокОкругления.ВидРасчета = ЗНАЧЕНИЕ(Справочник.НалогиСборыОтчисления.ВзносыОбязательноеСоциальноеМедицинскоеСтрахование))
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо,
		|	МесяцНалоговогоПериода
		|ИТОГИ
		|	МАКСИМУМ(Взнос),
		|	МАКСИМУМ(ОблагаемаяБаза),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";
	
	РезультатЗапросаВОСМС = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияВОСМС = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Дата"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("МесяцНалоговогоПериода", Новый ОписаниеТипов(МассивТипов, Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("Взнос", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияВОСМС.Колонки.Добавить("ОблагаемаяБаза", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("Взнос");
	КолонкиДляРаспределения.Добавить("ОблагаемаяБаза");
	
	КолонкаКоэффициентов = "ОблагаемыйДоход";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияВОСМС, РезультатЗапросаВОСМС, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияВОСМС.Свернуть("НомерСтроки, ФизЛицо, СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации, МесяцНалоговогоПериода", 
									 "Взнос, ОблагаемаяБаза");
									 
	// УДЕРЖАНИЯ ОРГАНИЗАЦИЙ
	
	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ 
		|	ТабличнаяЧастьУдержания.НомерСтроки,
		|	ТабличнаяЧастьУдержания.ФизЛицо,
		|	ТабличнаяЧастьУдержания.ВидРасчета,
		|	ТабличнаяЧастьУдержания.ДокументОснование,
		|	ТабличнаяЧастьУдержания.Результат,
		|	ТабличнаяЧастьУдержания.Организация,
		|	ТабличнаяЧастьУдержания.ПериодРегистрации,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьУдержания.Организация
		|	КОНЕЦ КАК СтруктурнаяЕдиница,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьУдержания.Организация
		|	КОНЕЦ КАК Организация,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ КАК ПодразделениеОрганизации,
		|	СУММА(ЕСТЬNULL(ИПНСведенияОДоходахОбороты.СуммаДохода, 0)) КАК СуммаДохода
		|ПОМЕСТИТЬ ВТ_СведенияОДоходахУдержания
		|ИЗ
		|	ВТ_ТабличнаяЧастьУдержания КАК ТабличнаяЧастьУдержания
		|
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
		|			ПО ИСТИНА
		|	
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ИПНСведенияОДоходах КАК ИПНСведенияОДоходахОбороты
		|		ПО ТабличнаяЧастьУдержания.ФизЛицо = ИПНСведенияОДоходахОбороты.ФизЛицо
		|			И (НАЧАЛОПЕРИОДА(ТабличнаяЧастьУдержания.ПериодРегистрации, МЕСЯЦ) = НАЧАЛОПЕРИОДА(ИПНСведенияОДоходахОбороты.ПериодРегистрации, МЕСЯЦ))
 		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестаРаботы
		|		ПО ТабличнаяЧастьУдержания.ФизЛицо = МестаРаботы.ФизЛицо
		|			И ТабличнаяЧастьУдержания.ПериодРегистрации = МестаРаботы.Период
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета.УдержанияОрганизаций.БазовыеВидыРасчета КАК БазовыеРасчетыУдержаний
		|			ПО ТабличнаяЧастьУдержания.ВидРасчета = БазовыеРасчетыУдержаний.Ссылка
		|				И (ВЫБОР 
		|					КОГДА ТабличнаяЧастьУдержания.КоличествоБазовыхРасчетов > 0 
		|						ТОГДА ИПНСведенияОДоходахОбороты.ВидРасчета = БазовыеРасчетыУдержаний.ВидРасчета
		|					ИНАЧЕ ИСТИНА
		|				КОНЕЦ)
		|	
		|СГРУППИРОВАТЬ ПО
		|	ТабличнаяЧастьУдержания.НомерСтроки,
		|	ТабличнаяЧастьУдержания.ФизЛицо,
		|	ТабличнаяЧастьУдержания.ВидРасчета,
		|	ТабличнаяЧастьУдержания.ДокументОснование,
		|	ТабличнаяЧастьУдержания.Результат,
		|	ТабличнаяЧастьУдержания.Организация,
		|	ТабличнаяЧастьУдержания.ПериодРегистрации,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.СтруктурнаяЕдиница
		|		КОГДА НЕ (МестаРаботы.СтруктурнаяЕдиница ЕСТЬ NULL)
		|			ТОГДА МестаРаботы.СтруктурнаяЕдиница
		|		ИНАЧЕ ТабличнаяЧастьУдержания.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА НЕ (ИПНСведенияОДоходахОбороты.Организация ЕСТЬ NULL)
		|			ТОГДА ИПНСведенияОДоходахОбороты.Организация
		|		ИНАЧЕ ТабличнаяЧастьУдержания.Организация
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА Реквизиты.РаспределятьНалогиПоПодразделениямОрганизаций
		|			ТОГДА
		|				ВЫБОР
		|					КОГДА НЕ (ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА ИПНСведенияОДоходахОбороты.ПодразделениеОрганизации
		|					КОГДА НЕ (МестаРаботы.ПодразделениеОрганизации ЕСТЬ NULL)
		|						ТОГДА МестаРаботы.ПодразделениеОрганизации
		|					ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|				КОНЕЦ
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
		|	КОНЕЦ
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ТабличнаяЧастьУдержания.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьУдержания.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьУдержания.ВидРасчета КАК ВидРасчета,
		|	ТабличнаяЧастьУдержания.ДокументОснование КАК ДокументОснование,
		|	ТабличнаяЧастьУдержания.Результат КАК Результат,
		|	СведенияОДоходахУдержания.СтруктурнаяЕдиница,
		|	СведенияОДоходахУдержания.Организация КАК Организация,
		|	СведенияОДоходахУдержания.ПодразделениеОрганизации,
		|	СведенияОДоходахУдержания.СуммаДохода,
		|	ОбщаяСуммаДоходов.СуммаДохода КАК СуммаДоходаВсего,
		|	ОбщийПорядокОкругления.ПорядокОкругления КАК ПорядокОкругления,
		|	ОбщийПорядокОкругления.МетодОкругления КАК МетодОкругления
		|ИЗ
		|	ВТ_ТабличнаяЧастьУдержания КАК ТабличнаяЧастьУдержания
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахУдержания.НомерСтроки КАК НомерСтроки,
		|			СведенияОДоходахУдержания.ФизЛицо КАК ФизЛицо,
		|			СведенияОДоходахУдержания.ВидРасчета КАК ВидРасчета,
		|			СведенияОДоходахУдержания.ДокументОснование КАК ДокументОснование,
		|			СУММА(СведенияОДоходахУдержания.СуммаДохода) КАК СуммаДохода
		|		ИЗ
		|			ВТ_СведенияОДоходахУдержания КАК СведенияОДоходахУдержания
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахУдержания.НомерСтроки,
		|			СведенияОДоходахУдержания.ФизЛицо,
		|			СведенияОДоходахУдержания.ВидРасчета,
		|			СведенияОДоходахУдержания.ДокументОснование) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьУдержания.НомерСтроки = ОбщаяСуммаДоходов.НомерСтроки
		|			И ТабличнаяЧастьУдержания.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахУдержания КАК СведенияОДоходахУдержания
		|		ПО ТабличнаяЧастьУдержания.ФизЛицо = СведенияОДоходахУдержания.ФизЛицо
		|			И ТабличнаяЧастьУдержания.НомерСтроки = СведенияОДоходахУдержания.НомерСтроки
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО ТабличнаяЧастьУдержания.ВидРасчета = ИндивидуальныйПорядокОкругления.ВидРасчета
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо
		|ИТОГИ
		|	МАКСИМУМ(Результат),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";

	РезультатЗапросаУдержания = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияУдержаний = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("ДокументСсылка.ИсполнительныйЛист"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("ДокументОснование", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("ПланВидовРасчетаСсылка.УдержанияОрганизаций"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("ВидРасчета", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияУдержаний.Колонки.Добавить("Результат", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("Результат");
	
	КолонкаКоэффициентов = "СуммаДохода";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияУдержаний, РезультатЗапросаУдержания, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияУдержаний.Свернуть("НомерСтроки, ФизЛицо, ДокументОснование, ВидРасчета, СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации", 
										   "Результат");
    
	
										   
	// Вычеты ИПН

	ЗапросРаспределения.Текст = 
		"ВЫБРАТЬ
		|	ТабличнаяЧастьВычетыИПН.НомерСтроки КАК НомерСтроки,
		|	ТабличнаяЧастьВычетыИПН.ФизЛицо КАК ФизЛицо,
		|	ТабличнаяЧастьВычетыИПН.ВидВычета КАК ВидВычета,
		|	ТабличнаяЧастьВычетыИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|	ТабличнаяЧастьВычетыИПН.РазрешенныйВычет КАК РазрешенныйВычет,
		|	ТабличнаяЧастьВычетыИПН.ПримененныйВычет КАК ПримененныйВычет,
		|	СведенияОДоходахИПН.СтруктурнаяЕдиница,
		|	СведенияОДоходахИПН.Организация КАК Организация,
		|	СведенияОДоходахИПН.ПодразделениеОрганизации,
		|	СведенияОДоходахИПН.ОблагаемыйДоход,
		|	ОбщаяСуммаДоходов.ОблагаемыйДоход КАК ОблагаемыйДоходВсего,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.ПорядокОкругления, ОбщийПорядокОкругления.ПорядокОкругления) КАК ПорядокОкругления,
		|	ЕСТЬNULL(ИндивидуальныйПорядокОкругления.МетодОкругления, ОбщийПорядокОкругления.МетодОкругления) КАК МетодОкругления
		|ИЗ
		|	ВТ_ТабличнаяЧастьВычетыИПН КАК ТабличнаяЧастьВычетыИПН
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			СведенияОДоходахИПН.ФизЛицо КАК ФизЛицо,
		|			СведенияОДоходахИПН.ПериодРегистрации КАК ПериодРегистрации,
		|			СведенияОДоходахИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|			СведенияОДоходахИПН.ПериодДоходов КАК ПериодДоходов,
		|			СУММА(СведенияОДоходахИПН.ОблагаемыйДоход) КАК ОблагаемыйДоход
		|		ИЗ
		|			ВТ_СведенияОДоходахИПН КАК СведенияОДоходахИПН
		|		
		|		СГРУППИРОВАТЬ ПО
		|			СведенияОДоходахИПН.ФизЛицо,
		|			СведенияОДоходахИПН.ПериодРегистрации,
		|			СведенияОДоходахИПН.МесяцНалоговогоПериода,
		|			СведенияОДоходахИПН.ПериодДоходов) КАК ОбщаяСуммаДоходов
		|		ПО ТабличнаяЧастьВычетыИПН.ФизЛицо = ОбщаяСуммаДоходов.ФизЛицо
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СведенияОДоходахИПН КАК СведенияОДоходахИПН
		|		ПО ТабличнаяЧастьВычетыИПН.ФизЛицо = СведенияОДоходахИПН.ФизЛицо
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ВидРасчета = НЕОПРЕДЕЛЕНО) КАК ОбщийПорядокОкругления
		|		ПО (ИСТИНА)
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокОкругленияРезультатовРасчетаЗарплаты.СрезПоследних(&Период, ) КАК ИндивидуальныйПорядокОкругления
		|		ПО (ИндивидуальныйПорядокОкругления.ВидРасчета = ЗНАЧЕНИЕ(Справочник.НалогиСборыОтчисления.ИндивидуальныйПодоходныйНалог))
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки,
		|	ФизЛицо,
		|	МесяцНалоговогоПериода
		|ИТОГИ
		|	МАКСИМУМ(РазрешенныйВычет),
		|	МАКСИМУМ(ПримененныйВычет),
		|	МАКСИМУМ(ПорядокОкругления),
		|	МАКСИМУМ(МетодОкругления)
		|ПО
		|	НомерСтроки";
	
	РезультатЗапросаВычетыИПН = ЗапросРаспределения.Выполнить();;
	
	// Ключевое поле
	КолонкаДляПоиска = "НомерСтроки";
	
	// Сформируем структуру таблицы для промежуточного хранения результатов распределения ОПВ
	ТаблицаРаспределенияВычетыИПН = Новый ТаблицаЗначений();
	МассивТипов = Новый Массив; 
	МассивТипов.Добавить(Тип("Число"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("НомерСтроки", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(10)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ФизическиеЛица"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Контрагенты"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("ФизЛицо", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ВычетыИПН"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("ВидВычета", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("СтруктурнаяЕдиница", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.Организации"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("Организация", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("СправочникСсылка.ПодразделенияОрганизаций"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("ПодразделениеОрганизации", Новый ОписаниеТипов(МассивТипов));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Дата"));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("МесяцНалоговогоПериода", Новый ОписаниеТипов(МассивТипов, Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	МассивТипов.Очистить();
	МассивТипов.Добавить(Тип("Число"));
 	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("ПримененныйВычет", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));
	ТаблицаРаспределенияВычетыИПН.Колонки.Добавить("РазрешенныйВычет", Новый ОписаниеТипов(МассивТипов, , , Новый КвалификаторыЧисла(15,2)));

	// Распределяемые значения
	КолонкиДляРаспределения = Новый Массив;
	КолонкиДляРаспределения.Добавить("ПримененныйВычет");
	КолонкиДляРаспределения.Добавить("РазрешенныйВычет");
	
	КолонкаКоэффициентов = "ОблагаемыйДоход";
	ПроведениеРасчетовСервер.РаспределитьНалогиВзносыУдержанияПоСтруктурнымЕдиницам(ТаблицаРаспределенияВычетыИПН, РезультатЗапросаВычетыИПН, КолонкиДляРаспределения, КолонкаДляПоиска, КолонкаКоэффициентов);	
	
	ТаблицаРаспределенияВычетыИПН.Свернуть("НомерСтроки, ФизЛицо, ВидВычета,  СтруктурнаяЕдиница, Организация, ПодразделениеОрганизации, МесяцНалоговогоПериода", 
									 "ПримененныйВычет, РазрешенныйВычет");
	
	
										   
	// ФИНАЛЬНЫЙ ЗАПРОС
	
	СписокСпособыРасчетаИЛ = Новый СписокЗначений;
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.УдержаниеФиксированнойСуммой);	
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.ИсполнительныйЛистПроцентом);
	СписокСпособыРасчетаИЛ.Добавить(Перечисления.СпособыРасчетаОплатыТруда.ПоМесячномуРасчетномуПоказателю);
	Запрос.УстановитьПараметр("СписокСпособыРасчетаИЛ", СписокСпособыРасчетаИЛ);
	
	Запрос.УстановитьПараметр("ТаблицаОПВ"				, ТаблицаРаспределенияОПВ);
	Запрос.УстановитьПараметр("ТаблицаИПН"				, ТаблицаРаспределенияИПН);
	Запрос.УстановитьПараметр("ТаблицаВОСМС"			, ТаблицаРаспределенияВОСМС);
	Запрос.УстановитьПараметр("ТаблицаНалоговыеВычеты"	, ТаблицаРаспределенияНалоговыхВычетов);
	Запрос.УстановитьПараметр("ТаблицаУдержания"		, ТаблицаРаспределенияУдержаний);	
	Запрос.УстановитьПараметр("ТаблицаВычетыИПН"		, ТаблицаРаспределенияВычетыИПН);	
	
	Запрос.МенеджерВременныхТаблиц = ЗапросРаспределения.МенеджерВременныхТаблиц;

	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаОПВ.НомерСтроки,
	|	ТаблицаОПВ.ФизЛицо,
	|	ТаблицаОПВ.СтруктурнаяЕдиница,
	|	ТаблицаОПВ.Организация,
	|	ТаблицаОПВ.ПодразделениеОрганизации,
	|	ТаблицаОПВ.МесяцНалоговогоПериода,
	|	ТаблицаОПВ.Взнос,
	|	ТаблицаОПВ.ОблагаемаяБаза
	|ПОМЕСТИТЬ ВТ_ТаблицаОПВ
	|ИЗ
	|	&ТаблицаОПВ КАК ТаблицаОПВ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаИПН.НомерСтроки,
	|	ТаблицаИПН.ФизЛицо,
	|	ТаблицаИПН.СтруктурнаяЕдиница,
	|	ТаблицаИПН.Организация,
	|	ТаблицаИПН.ПодразделениеОрганизации,
	|	ТаблицаИПН.МесяцНалоговогоПериода,
	|	ТаблицаИПН.Налог,
	|	ТаблицаИПН.ОблагаемаяБаза,
	|	ТаблицаИПН.ПримененныйВычет,
	|	ТаблицаИПН.ПримененнаяЛьгота,
	|	ТаблицаИПН.РазрешенныйВычет
	|ПОМЕСТИТЬ ВТ_ТаблицаИПН
	|ИЗ
	|	&ТаблицаИПН КАК ТаблицаИПН
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВОСМС.НомерСтроки,
	|	ТаблицаВОСМС.ФизЛицо,
	|	ТаблицаВОСМС.СтруктурнаяЕдиница,
	|	ТаблицаВОСМС.Организация,
	|	ТаблицаВОСМС.ПодразделениеОрганизации,
	|	ТаблицаВОСМС.МесяцНалоговогоПериода,
	|	ТаблицаВОСМС.Взнос,
	|	ТаблицаВОСМС.ОблагаемаяБаза
	|ПОМЕСТИТЬ ВТ_ТаблицаВОСМС
	|ИЗ
	|	&ТаблицаВОСМС КАК ТаблицаВОСМС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаНалоговыеВычеты.НомерСтроки,
	|	ТаблицаНалоговыеВычеты.ФизЛицо,
	|	ТаблицаНалоговыеВычеты.СтруктурнаяЕдиница,
	|	ТаблицаНалоговыеВычеты.Организация,
	|	ТаблицаНалоговыеВычеты.ПодразделениеОрганизации,
	|	ТаблицаНалоговыеВычеты.МесяцНалоговогоПериода,
	|	ТаблицаНалоговыеВычеты.ВычетИПН,
	|	ТаблицаНалоговыеВычеты.ДокументОснование,
	|	ТаблицаНалоговыеВычеты.СуммаВычета
	|ПОМЕСТИТЬ ВТ_ТаблицаНалоговыеВычеты
	|ИЗ
	|	&ТаблицаНалоговыеВычеты КАК ТаблицаНалоговыеВычеты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаУдержания.НомерСтроки,
	|	ТаблицаУдержания.ФизЛицо,
	|	ТаблицаУдержания.СтруктурнаяЕдиница,
	|	ТаблицаУдержания.Организация,
	|	ТаблицаУдержания.ПодразделениеОрганизации,
	|	ТаблицаУдержания.ВидРасчета,
	|	ТаблицаУдержания.ДокументОснование,
	|	ТаблицаУдержания.Результат
	|ПОМЕСТИТЬ ВТ_ТаблицаУдержаний
	|ИЗ
	|	&ТаблицаУдержания КАК ТаблицаУдержания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаВычетыИПН.НомерСтроки,
	|	ТаблицаВычетыИПН.ФизЛицо КАК ФизическоеЛицо,
	|	ТаблицаВычетыИПН.СтруктурнаяЕдиница,
	|	ТаблицаВычетыИПН.Организация,
	|	ТаблицаВычетыИПН.ПодразделениеОрганизации,
	|	ТаблицаВычетыИПН.МесяцНалоговогоПериода,
	|	ТаблицаВычетыИПН.ВидВычета,
	|	ТаблицаВычетыИПН.РазрешенныйВычет,
	|	ТаблицаВычетыИПН.ПримененныйВычет
	|ПОМЕСТИТЬ ВТ_ТаблицаВычетыИПН
	|ИЗ
	|	&ТаблицаВычетыИПН КАК ТаблицаВычетыИПН
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Окончание КАК Период,
	|	&Начало КАК ПериодВзаиморасчетов,
	|	ЕСТЬNULL(ТаблицаИПН.ФизЛицо, РанееИсчисленныйИПН.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаИПН.ФизЛицо, РанееИсчисленныйИПН.ФизЛицо) КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ТаблицаИПН.ФизЛицо, РанееИсчисленныйИПН.ФизЛицо) ССЫЛКА Справочник.Контрагенты
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЯвляетсяКонтрагентом,
	|	-(ЕСТЬNULL(ТаблицаИПН.Налог, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.Налог, 0)) КАК СуммаВзаиморасчетов,
	|	ЕСТЬNULL(ТаблицаИПН.СтруктурнаяЕдиница, РанееИсчисленныйИПН.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаИПН.ПодразделениеОрганизации, РанееИсчисленныйИПН.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ПОМЕСТИТЬ ВТ_ВзаиморасчетыОрганизаций
	|ИЗ
	|	ВТ_ТаблицаИПН КАК ТаблицаИПН
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьИПН КАК ИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = ИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.ФизЛицо = ИсчисленныйИПН.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйИПН КАК РанееИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = РанееИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.СтруктурнаяЕдиница = РанееИсчисленныйИПН.СтруктурнаяЕдиница
	|			И ТаблицаИПН.ПодразделениеОрганизации = РанееИсчисленныйИПН.ПодразделениеОрганизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&Окончание,
	|	&Начало,
	|	ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо),
	|	ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо),
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо) ССЫЛКА Справочник.Контрагенты
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ ,
	|	-(ЕСТЬNULL(ТаблицаОПВ.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныйОПВ.Взнос, 0)),
	|	ЕСТЬNULL(ТаблицаОПВ.СтруктурнаяЕдиница, РанееИсчисленныйОПВ.СтруктурнаяЕдиница),
	|	ЕСТЬNULL(ТаблицаОПВ.ПодразделениеОрганизации, РанееИсчисленныйОПВ.ПодразделениеОрганизации)
	|ИЗ
	|	ВТ_ТаблицаОПВ КАК ТаблицаОПВ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = ИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.ФизЛицо = ИсчисленныйОПВ.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйОПВ КАК РанееИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = РанееИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.СтруктурнаяЕдиница = РанееИсчисленныйОПВ.СтруктурнаяЕдиница
	|			И ТаблицаОПВ.ПодразделениеОрганизации = РанееИсчисленныйОПВ.ПодразделениеОрганизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&Окончание,
	|	&Начало,
	|	ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо),
	|	ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо),
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо) ССЫЛКА Справочник.Контрагенты
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	-(ЕСТЬNULL(ТаблицаВОСМС.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныеВОСМС.Взнос, 0)),
	|	ЕСТЬNULL(ТаблицаВОСМС.СтруктурнаяЕдиница, РанееИсчисленныеВОСМС.СтруктурнаяЕдиница),
	|	ЕСТЬNULL(ТаблицаВОСМС.ПодразделениеОрганизации, РанееИсчисленныеВОСМС.ПодразделениеОрганизации)
	|ИЗ
	|	ВТ_ТаблицаВОСМС КАК ТаблицаВОСМС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = ИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.ФизЛицо = ИсчисленныеВОСМС.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныеВОСМС КАК РанееИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = РанееИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.СтруктурнаяЕдиница = РанееИсчисленныеВОСМС.СтруктурнаяЕдиница
	|			И ТаблицаВОСМС.ПодразделениеОрганизации = РанееИсчисленныеВОСМС.ПодразделениеОрганизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&Окончание,
	|	&Начало,
	|	ВТ_ТаблицаУдержаний.ФизЛицо,
	|	ВТ_ТаблицаУдержаний.ФизЛицо,
	|	ЛОЖЬ,
	|	-ВТ_ТаблицаУдержаний.Результат,
	|	ВТ_ТаблицаУдержаний.СтруктурнаяЕдиница,
	|	ВТ_ТаблицаУдержаний.ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаУдержаний КАК ВТ_ТаблицаУдержаний
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьУдержания КАК Удержания
	|		ПО ВТ_ТаблицаУдержаний.НомерСтроки = Удержания.НомерСтроки
	|			И ВТ_ТаблицаУдержаний.ФизЛицо = Удержания.ФизЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&Начало КАК ПериодРегистрации,
	|	ЕСТЬNULL(ТаблицаИПН.НомерСтроки, РанееИсчисленныйИПН.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА ИсчисленныйИПН.ОтражениеПоПериодуРегистрации
	|				ТОГДА ИсчисленныйИПН.ПериодРегистрации
	|			ИНАЧЕ ИсчисленныйИПН.МесяцНалоговогоПериода
	|		КОНЕЦ, РанееИсчисленныйИПН.МесяцНалоговогоПериода) КАК Период,
	|	ЕСТЬNULL(ТаблицаИПН.ФизЛицо, РанееИсчисленныйИПН.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаИПН.МесяцНалоговогоПериода, РанееИсчисленныйИПН.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериодаИлиВзаиморасчетов,
	|	ЕСТЬNULL(ТаблицаИПН.ПримененныйВычет, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.ПримененныйВычет, 0) КАК ПримененныйВычет,
	|	ЕСТЬNULL(ТаблицаИПН.ПримененнаяЛьгота, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.ПримененнаяЛьгота, 0) КАК ПримененнаяЛьгота,
	|	ЕСТЬNULL(ТаблицаИПН.РазрешенныйВычет, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.РазрешенныйВычет, 0) КАК РазрешенныйВычет,
	|	ЕСТЬNULL(ТаблицаИПН.ОблагаемаяБаза, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.ОблагаемаяБаза, 0) КАК ОблагаемаяБаза,
	|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
	|	NULL КАК СуммаДохода,
	|	NULL КАК СуммаВычета,
	|	NULL КАК ДокументОснование,
	|	NULL КАК ВидСтроки,
	|	NULL КАК ВидРасчета,
	|	ЕСТЬNULL(ТаблицаИПН.СтруктурнаяЕдиница, РанееИсчисленныйИПН.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаИПН.ПодразделениеОрганизации, РанееИсчисленныйИПН.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ПОМЕСТИТЬ ВТ_ТаблицИПННалоговыеВычеты
	|ИЗ
	|	ВТ_ТаблицаИПН КАК ТаблицаИПН
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьИПН КАК ИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = ИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.ФизЛицо = ИсчисленныйИПН.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйИПН КАК РанееИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = РанееИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.СтруктурнаяЕдиница = РанееИсчисленныйИПН.СтруктурнаяЕдиница
	|			И ТаблицаИПН.ПодразделениеОрганизации = РанееИсчисленныйИПН.ПодразделениеОрганизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&Начало,
	|	ВТ_ТаблицаНалоговыеВычеты.НомерСтроки,
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА НалоговыеВычеты.ПериодРегистрации
	|		ИНАЧЕ НалоговыеВычеты.МесяцНалоговогоПериода
	|	КОНЕЦ,
	|	ВТ_ТаблицаНалоговыеВычеты.ФизЛицо,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	NULL,
	|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом),
	|	0,
	|	ВТ_ТаблицаНалоговыеВычеты.СуммаВычета,
	|	ВТ_ТаблицаНалоговыеВычеты.ДокументОснование,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление),
	|	ВТ_ТаблицаНалоговыеВычеты.ВычетИПН,
	|	ВТ_ТаблицаНалоговыеВычеты.СтруктурнаяЕдиница,
	|	ВТ_ТаблицаНалоговыеВычеты.ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаНалоговыеВычеты КАК ВТ_ТаблицаНалоговыеВычеты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьНалоговыеВычеты КАК НалоговыеВычеты
	|		ПО ВТ_ТаблицаНалоговыеВычеты.НомерСтроки = НалоговыеВычеты.НомерСтроки
	|			И ВТ_ТаблицаНалоговыеВычеты.ФизЛицо = НалоговыеВычеты.ФизЛицо";
	
	Запрос.Выполнить();
	
	НомераТаблиц.Вставить("ИсчисленныйИПН", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ИсчисленныйОПВ", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ИсчисленныеВОСМС", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВзаиморасчетыСПолучателямиИЛ", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВыплаченныеДоходыНУ", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ИПНСведенияОДоходах", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ОПВСведенияОДоходах", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ОПВПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВОСМССведенияОДоходах", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВОСМСПодлежитПеречислениюВФонды", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВзаиморасчетыОрганизацийСКонтрагентамиФизЛицами", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("ВзаиморасчетыСРаботникамиОрганизаций", НомераТаблиц.Количество());
	НомераТаблиц.Вставить("СведенияОбИсчисленииВычетовИПН", НомераТаблиц.Количество());
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	""ИсчисленныйИПН"" КАК ВидСтрокиЗапроса,
	|	&Окончание КАК Период,
	|	ЕСТЬNULL(ТаблицаИПН.ФизЛицо, РанееИсчисленныйИПН.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаИПН.МесяцНалоговогоПериода, РанееИсчисленныйИПН.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода,
	|	ЕСТЬNULL(ТаблицаИПН.Налог, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.Налог, 0) КАК Налог,
	|	ЛОЖЬ КАК НеОтражатьВРеглУчете,
	|	ЕСТЬNULL(ТаблицаИПН.СтруктурнаяЕдиница, РанееИсчисленныйИПН.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаИПН.ПодразделениеОрганизации, РанееИсчисленныйИПН.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаИПН КАК ТаблицаИПН
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьИПН КАК ИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = ИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.ФизЛицо = ИсчисленныйИПН.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйИПН КАК РанееИсчисленныйИПН
	|		ПО ТаблицаИПН.НомерСтроки = РанееИсчисленныйИПН.НомерСтроки
	|			И ТаблицаИПН.СтруктурнаяЕдиница = РанееИсчисленныйИПН.СтруктурнаяЕдиница
	|			И ТаблицаИПН.ПодразделениеОрганизации = РанееИсчисленныйИПН.ПодразделениеОрганизации
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаИПН.Налог, 0) - ЕСТЬNULL(РанееИсчисленныйИПН.Налог, 0) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ИсчисленныйОПВ"" КАК ВидСтрокиЗапроса,
	|	&Окончание КАК Период,
	|	ЕСТЬNULL(ТаблицаОПВ.НомерСтроки, РанееИсчисленныйОПВ.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаОПВ.МесяцНалоговогоПериода, РанееИсчисленныйОПВ.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода,
	|	ЕСТЬNULL(ТаблицаОПВ.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныйОПВ.Взнос, 0) КАК Взнос,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) КАК ВидПлатежа,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление) КАК ВидСтроки,
	|	ЕСТЬNULL(ТаблицаОПВ.СтруктурнаяЕдиница, РанееИсчисленныйОПВ.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЛОЖЬ КАК НеОтражатьВРеглУчете,
	|	ЕСТЬNULL(ТаблицаОПВ.ПодразделениеОрганизации, РанееИсчисленныйОПВ.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаОПВ КАК ТаблицаОПВ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = ИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.ФизЛицо = ИсчисленныйОПВ.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйОПВ КАК РанееИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = РанееИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.СтруктурнаяЕдиница = РанееИсчисленныйОПВ.СтруктурнаяЕдиница
	|			И ТаблицаОПВ.ПодразделениеОрганизации = РанееИсчисленныйОПВ.ПодразделениеОрганизации
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаОПВ.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныйОПВ.Взнос, 0) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ИсчисленныеВОСМС"" КАК ВидСтрокиЗапроса,
	|	&Окончание КАК Период,
	|	ЕСТЬNULL(ТаблицаВОСМС.НомерСтроки, РанееИсчисленныеВОСМС.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаВОСМС.МесяцНалоговогоПериода, РанееИсчисленныеВОСМС.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода,
	|	ЕСТЬNULL(ТаблицаВОСМС.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныеВОСМС.Взнос, 0) КАК Взнос,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыПлатежейВБюджетИФонды.Налог) КАК ВидПлатежа,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Исчисление) КАК ВидСтроки,
	|	ЕСТЬNULL(ТаблицаВОСМС.СтруктурнаяЕдиница, РанееИсчисленныеВОСМС.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаВОСМС.ПодразделениеОрганизации, РанееИсчисленныеВОСМС.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаВОСМС КАК ТаблицаВОСМС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = ИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.ФизЛицо = ИсчисленныеВОСМС.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныеВОСМС КАК РанееИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = РанееИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.СтруктурнаяЕдиница = РанееИсчисленныеВОСМС.СтруктурнаяЕдиница
	|			И ТаблицаВОСМС.ПодразделениеОрганизации = РанееИсчисленныеВОСМС.ПодразделениеОрганизации
	|ГДЕ
	|	ЕСТЬNULL(ТаблицаВОСМС.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныеВОСМС.Взнос, 0) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВзаиморасчетыСПолучателямиИЛ"" КАК Поле1,
	|	ВТ_ТаблицаУдержаний.НомерСтроки КАК НомерСтроки,
	|	&Окончание КАК Период,
	|	&Период КАК ПериодВзаиморасчетов,
	|	ВТ_ТаблицаУдержаний.ФизЛицо КАК ФизЛицо,
	|	ЛОЖЬ КАК ЯвляетсяКонтрагентом,
	|	ВЫБОР
	|		КОГДА Реквизиты.ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ
	|			ТОГДА ВТ_ТаблицаУдержаний.Результат
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ВТ_ТаблицаУдержаний.ДокументОснование.Ссылка ЕСТЬ NULL
	|						ИЛИ НЕ ВТ_ТаблицаУдержаний.ДокументОснование.Ссылка ЕСТЬ NULL
	|							И НЕ ВТ_ТаблицаУдержаний.ДокументОснование ССЫЛКА Документ.ИсполнительныйЛист
	|					ТОГДА ВТ_ТаблицаУдержаний.Результат
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаВыплаченногоДохода,
	|	ВЫБОР
	|		КОГДА Удержания.ВидРасчета.СпособРасчета В (&СписокСпособыРасчетаИЛ)
	|				ИЛИ Удержания.ДокументОснование.СпособПеречисления = ЗНАЧЕНИЕ(Перечисление.СпособыПеречисленияПоИсполнительномуЛисту.ЧерезКассу)
	|			ТОГДА ВТ_ТаблицаУдержаний.Результат
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаВзаиморасчетов,
	|	ВЫБОР
	|		КОГДА НЕ Удержания.ВидРасчета.СпособРасчета В (&СписокСпособыРасчетаИЛ)
	|				И Удержания.ДокументОснование.СпособПеречисления <> ЗНАЧЕНИЕ(Перечисление.СпособыПеречисленияПоИсполнительномуЛисту.ЧерезКассу)
	|			ТОГДА ВТ_ТаблицаУдержаний.Результат
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаСборов,
	|	Удержания.ДокументОснование КАК ДокументОснование,
	|	Удержания.ДокументОснование.Получатель КАК Получатель,
	|	ВТ_ТаблицаУдержаний.ВидРасчета КАК ВидРасчета,
	|	Удержания.Размер КАК Размер,
	|	ВТ_ТаблицаУдержаний.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВТ_ТаблицаУдержаний.ПодразделениеОрганизации КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаУдержаний КАК ВТ_ТаблицаУдержаний
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьУдержания КАК Удержания
	|		ПО ВТ_ТаблицаУдержаний.НомерСтроки = Удержания.НомерСтроки
	|			И ВТ_ТаблицаУдержаний.ФизЛицо = Удержания.ФизЛицо
	|ГДЕ
	|	Удержания.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ИсполнительныйЛист.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВыплаченныеДоходыНУ"" КАК Поле1,
	|	ВТ_ТаблицаУдержаний.НомерСтроки КАК НомерСтроки,
	|	&Окончание КАК Период,
	|	&Период КАК МесяцНалоговогоПериода,
	|	ВТ_ТаблицаУдержаний.ФизЛицо КАК ФизЛицо,
	|	ВТ_ТаблицаУдержаний.Результат КАК СуммаУдержания,
	|	ВЫБОР
	|		КОГДА Реквизиты.ЗасчитыватьВВыплаченныеДоходыУдержанияПоИЛ
	|			ТОГДА ВТ_ТаблицаУдержаний.Результат
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ВТ_ТаблицаУдержаний.ДокументОснование.Ссылка ЕСТЬ NULL
	|						ИЛИ НЕ ВТ_ТаблицаУдержаний.ДокументОснование.Ссылка ЕСТЬ NULL
	|							И НЕ ВТ_ТаблицаУдержаний.ДокументОснование ССЫЛКА Документ.ИсполнительныйЛист
	|					ТОГДА ВТ_ТаблицаУдержаний.Результат
	|				ИНАЧЕ 0
	|			КОНЕЦ
	|	КОНЕЦ КАК СуммаДохода,
	|	ВТ_ТаблицаУдержаний.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ВТ_ТаблицаУдержаний.ПодразделениеОрганизации КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаУдержаний КАК ВТ_ТаблицаУдержаний
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьУдержания КАК Удержания
	|		ПО ВТ_ТаблицаУдержаний.НомерСтроки = Удержания.НомерСтроки
	|			И ВТ_ТаблицаУдержаний.ФизЛицо = Удержания.ФизЛицо
	|ГДЕ
	|	ВТ_ТаблицаУдержаний.Результат <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ИПНСведенияОДоходах"" КАК ВидСтрокиЗапроса,
	|	ТаблицИПННалоговыеВычеты.ПериодРегистрации КАК ПериодРегистрации,
	|	ТаблицИПННалоговыеВычеты.НомерСтроки КАК НомерСтроки,
	|	ТаблицИПННалоговыеВычеты.Период КАК Период,
	|	ТаблицИПННалоговыеВычеты.ФизЛицо КАК ФизЛицо,
	|	ТаблицИПННалоговыеВычеты.МесяцНалоговогоПериодаИлиВзаиморасчетов КАК МесяцНалоговогоПериодаИлиВзаиморасчетов,
	|	ТаблицИПННалоговыеВычеты.ПримененныйВычет КАК ПримененныйВычет,
	|	ТаблицИПННалоговыеВычеты.ПримененнаяЛьгота КАК ПримененнаяЛьгота,
	|	ТаблицИПННалоговыеВычеты.РазрешенныйВычет КАК РазрешенныйВычет,
	|	ТаблицИПННалоговыеВычеты.ОблагаемаяБаза КАК ОблагаемаяБаза,
	|	ТаблицИПННалоговыеВычеты.ОблагаетсяЦеликом КАК ОблагаетсяЦеликом,
	|	ТаблицИПННалоговыеВычеты.СуммаДохода КАК СуммаДохода,
	|	ТаблицИПННалоговыеВычеты.СуммаВычета КАК СуммаВычета,
	|	ТаблицИПННалоговыеВычеты.ДокументОснование КАК ДокументОснование,
	|	ТаблицИПННалоговыеВычеты.ВидСтроки КАК ВидСтроки,
	|	ТаблицИПННалоговыеВычеты.ВидРасчета КАК ВидРасчета,
	|	ТаблицИПННалоговыеВычеты.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	ТаблицИПННалоговыеВычеты.ПодразделениеОрганизации КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицИПННалоговыеВычеты КАК ТаблицИПННалоговыеВычеты
	|ГДЕ
	|	(ТаблицИПННалоговыеВычеты.ОблагаемаяБаза <> 0
	|			ИЛИ ТаблицИПННалоговыеВычеты.ПримененныйВычет <> 0
	|			ИЛИ ТаблицИПННалоговыеВычеты.ПримененнаяЛьгота <> 0
	|			ИЛИ ТаблицИПННалоговыеВычеты.РазрешенныйВычет <> 0
	|			ИЛИ ТаблицИПННалоговыеВычеты.СуммаВычета <> 0)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ОПВСведенияОДоходах"" КАК ВидСтрокиЗапроса,
	|	&Начало КАК ПериодРегистрации,
	|	ЕСТЬNULL(ТаблицаОПВ.НомерСтроки, РанееИсчисленныйОПВ.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА ИсчисленныйОПВ.ОтражениеПоПериодуРегистрации
	|				ТОГДА ИсчисленныйОПВ.ПериодРегистрации
	|			ИНАЧЕ ИсчисленныйОПВ.МесяцНалоговогоПериода
	|		КОНЕЦ, РанееИсчисленныйОПВ.МесяцНалоговогоПериода) КАК Период,
	|	ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаОПВ.ОблагаемаяБаза, 0) - ЕСТЬNULL(РанееИсчисленныйОПВ.ОблагаемаяБаза, 0) КАК ОблагаемаяБаза,
	|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
	|	ЕСТЬNULL(ТаблицаОПВ.СтруктурнаяЕдиница, РанееИсчисленныйОПВ.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаОПВ.ПодразделениеОрганизации, РанееИсчисленныйОПВ.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаОПВ КАК ТаблицаОПВ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = ИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.ФизЛицо = ИсчисленныйОПВ.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйОПВ КАК РанееИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = РанееИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.СтруктурнаяЕдиница = РанееИсчисленныйОПВ.СтруктурнаяЕдиница
	|			И ТаблицаОПВ.ПодразделениеОрганизации = РанееИсчисленныйОПВ.ПодразделениеОрганизации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ОПВПодлежитПеречислениюВФонды"" КАК ВидСтрокиЗапроса,
	|	&Окончание КАК Период,
	|	&Начало КАК МесяцВыплатыДоходов,
	|	ЕСТЬNULL(ТаблицаОПВ.НомерСтроки, РанееИсчисленныйОПВ.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА ИсчисленныйОПВ.ОтражениеПоПериодуРегистрации
	|				ТОГДА ИсчисленныйОПВ.ПериодРегистрации
	|			ИНАЧЕ ИсчисленныйОПВ.МесяцНалоговогоПериода
	|		КОНЕЦ, РанееИсчисленныйОПВ.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода,
	|	ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо) КАК ФизЛицо,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
	|	ЕСТЬNULL(ТаблицаОПВ.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныйОПВ.Взнос, 0) КАК Взнос,
	|	ЕСТЬNULL(ТаблицаОПВ.СтруктурнаяЕдиница, РанееИсчисленныйОПВ.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаОПВ.ПодразделениеОрганизации, РанееИсчисленныйОПВ.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаОПВ КАК ТаблицаОПВ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьОПВ КАК ИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = ИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.ФизЛицо = ИсчисленныйОПВ.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныйОПВ КАК РанееИсчисленныйОПВ
	|		ПО ТаблицаОПВ.НомерСтроки = РанееИсчисленныйОПВ.НомерСтроки
	|			И ТаблицаОПВ.СтруктурнаяЕдиница = РанееИсчисленныйОПВ.СтруктурнаяЕдиница
	|			И ТаблицаОПВ.ПодразделениеОрганизации = РанееИсчисленныйОПВ.ПодразделениеОрганизации
	|ГДЕ
	|	ВЫБОР
	|			КОГДА &ЕжемесячныйРасчетВзносовИОтчисленийЗаИП
	|				ТОГДА ЕСТЬNULL(ТаблицаОПВ.ФизЛицо, РанееИсчисленныйОПВ.ФизЛицо) = &ИндивидуальныйПредприниматель
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВОСМССведенияОДоходах"" КАК ВидСтрокиЗапроса,
	|	&Начало КАК ПериодРегистрации,
	|	ЕСТЬNULL(ТаблицаВОСМС.НомерСтроки, РанееИсчисленныеВОСМС.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА ИсчисленныеВОСМС.ОтражениеПоПериодуРегистрации
	|				ТОГДА ИсчисленныеВОСМС.ПериодРегистрации
	|			ИНАЧЕ ИсчисленныеВОСМС.МесяцНалоговогоПериода
	|		КОНЕЦ, РанееИсчисленныеВОСМС.МесяцНалоговогоПериода) КАК Период,
	|	ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо) КАК ФизЛицо,
	|	ЕСТЬNULL(ТаблицаВОСМС.ОблагаемаяБаза, 0) - ЕСТЬNULL(РанееИсчисленныеВОСМС.ОблагаемаяБаза, 0) КАК ОблагаемаяБаза,
	|	ЗНАЧЕНИЕ(Справочник.СпособыНалогообложенияДоходов.ОблагаетсяЦеликом) КАК ОблагаетсяЦеликом,
	|	ЕСТЬNULL(ТаблицаВОСМС.СтруктурнаяЕдиница, РанееИсчисленныеВОСМС.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаВОСМС.ПодразделениеОрганизации, РанееИсчисленныеВОСМС.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаВОСМС КАК ТаблицаВОСМС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = ИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.ФизЛицо = ИсчисленныеВОСМС.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныеВОСМС КАК РанееИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = РанееИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.СтруктурнаяЕдиница = РанееИсчисленныеВОСМС.СтруктурнаяЕдиница
	|			И ТаблицаВОСМС.ПодразделениеОрганизации = РанееИсчисленныеВОСМС.ПодразделениеОрганизации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВОСМСПодлежитПеречислениюВФонды"" КАК ВидСтрокиЗапроса,
	|	&Окончание КАК Период,
	|	&Начало КАК МесяцВыплатыДоходов,
	|	ЕСТЬNULL(ТаблицаВОСМС.НомерСтроки, РанееИсчисленныеВОСМС.НомерСтроки) КАК НомерСтроки,
	|	ЕСТЬNULL(ВЫБОР
	|			КОГДА ИсчисленныеВОСМС.ОтражениеПоПериодуРегистрации
	|				ТОГДА ИсчисленныеВОСМС.ПериодРегистрации
	|			ИНАЧЕ ИсчисленныеВОСМС.МесяцНалоговогоПериода
	|		КОНЕЦ, РанееИсчисленныеВОСМС.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода,
	|	ЕСТЬNULL(ТаблицаВОСМС.ФизЛицо, РанееИсчисленныеВОСМС.ФизЛицо) КАК ФизЛицо,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
	|	ЕСТЬNULL(ТаблицаВОСМС.Взнос, 0) - ЕСТЬNULL(РанееИсчисленныеВОСМС.Взнос, 0) КАК Взнос,
	|	ЕСТЬNULL(ТаблицаВОСМС.СтруктурнаяЕдиница, РанееИсчисленныеВОСМС.СтруктурнаяЕдиница) КАК СтруктурнаяЕдиница,
	|	ЕСТЬNULL(ТаблицаВОСМС.ПодразделениеОрганизации, РанееИсчисленныеВОСМС.ПодразделениеОрганизации) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ТаблицаВОСМС КАК ТаблицаВОСМС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТабличнаяЧастьВОСМС КАК ИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = ИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.ФизЛицо = ИсчисленныеВОСМС.ФизЛицо
	|		ПОЛНОЕ СОЕДИНЕНИЕ ВТ_РанееИсчисленныеВОСМС КАК РанееИсчисленныеВОСМС
	|		ПО ТаблицаВОСМС.НомерСтроки = РанееИсчисленныеВОСМС.НомерСтроки
	|			И ТаблицаВОСМС.СтруктурнаяЕдиница = РанееИсчисленныеВОСМС.СтруктурнаяЕдиница
	|			И ТаблицаВОСМС.ПодразделениеОрганизации = РанееИсчисленныеВОСМС.ПодразделениеОрганизации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВзаиморасчетыОрганизацийСКонтрагентамиФизЛицами"" КАК ВидСтрокиЗапроса,
	|	СтрокиВзаиморасчетыОрганизаций.Период КАК Период,
	|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
	|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо КАК ФизЛицо,
	|	СтрокиВзаиморасчетыОрганизаций.Контрагент КАК Контрагент,
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом КАК ЯвляетсяКонтрагентом,
	|	СУММА(СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов) КАК СуммаВзаиморасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
	|	СтрокиВзаиморасчетыОрганизаций.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СтрокиВзаиморасчетыОрганизаций.ПодразделениеОрганизации КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ВзаиморасчетыОрганизаций КАК СтрокиВзаиморасчетыОрганизаций
	|ГДЕ
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом = ИСТИНА
	|	И СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	СтрокиВзаиморасчетыОрганизаций.Период,
	|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
	|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
	|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
	|	СтрокиВзаиморасчетыОрганизаций.СтруктурнаяЕдиница,
	|	СтрокиВзаиморасчетыОрганизаций.ПодразделениеОрганизации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""ВзаиморасчетыСРаботникамиОрганизаций"" КАК ВидСтрокиЗапроса,
	|	СтрокиВзаиморасчетыОрганизаций.Период КАК Период,
	|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
	|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо КАК ФизЛицо,
	|	СтрокиВзаиморасчетыОрганизаций.Контрагент КАК Контрагент,
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом КАК ЯвляетсяКонтрагентом,
	|	СУММА(СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов) КАК СуммаВзаиморасчетов,
	|	ЗНАЧЕНИЕ(Перечисление.РасчетыСБюджетомФондамиВидСтроки.Удержание) КАК ВидСтроки,
	|	СтрокиВзаиморасчетыОрганизаций.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СтрокиВзаиморасчетыОрганизаций.ПодразделениеОрганизации КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ВзаиморасчетыОрганизаций КАК СтрокиВзаиморасчетыОрганизаций
	|ГДЕ
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом = ЛОЖЬ
	|	И СтрокиВзаиморасчетыОрганизаций.СуммаВзаиморасчетов <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	СтрокиВзаиморасчетыОрганизаций.Период,
	|	СтрокиВзаиморасчетыОрганизаций.ПериодВзаиморасчетов,
	|	СтрокиВзаиморасчетыОрганизаций.ФизЛицо,
	|	СтрокиВзаиморасчетыОрганизаций.Контрагент,
	|	СтрокиВзаиморасчетыОрганизаций.ЯвляетсяКонтрагентом,
	|	СтрокиВзаиморасчетыОрганизаций.СтруктурнаяЕдиница,
	|	СтрокиВзаиморасчетыОрганизаций.ПодразделениеОрганизации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	""СведенияОбИсчисленииВычетовИПН"" КАК ВидСтрокиЗапроса,
	|	СтрокиВычетыИПН.СтруктурнаяЕдиница КАК СтруктурнаяЕдиница,
	|	СтрокиВычетыИПН.Организация КАК Организация,
	|	СтрокиВычетыИПН.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	|	СтрокиВычетыИПН.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
	|	СтрокиВычетыИПН.ВидВычета КАК ВидВычета,
	|	СУММА(СтрокиВычетыИПН.РазрешенныйВычет) КАК РазрешенныйВычет,
	|	СУММА(СтрокиВычетыИПН.ПримененныйВычет) КАК ПримененныйВычет,
	|	СтрокиВычетыИПН.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА &Период
	|		ИНАЧЕ СтрокиВычетыИПН.МесяцНалоговогоПериода
	|	КОНЕЦ КАК Период
	|ИЗ
	|	ВТ_ТаблицаВычетыИПН КАК СтрокиВычетыИПН
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|
	|СГРУППИРОВАТЬ ПО
	|	СтрокиВычетыИПН.Организация,
	|	СтрокиВычетыИПН.СтруктурнаяЕдиница,
	|	СтрокиВычетыИПН.ВидВычета,
	|	СтрокиВычетыИПН.ПодразделениеОрганизации,
	|	СтрокиВычетыИПН.МесяцНалоговогоПериода,
	|	СтрокиВычетыИПН.ФизическоеЛицо,
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА &Период
	|		ИНАЧЕ СтрокиВычетыИПН.МесяцНалоговогоПериода
	|	КОНЕЦ";

	Возврат ТекстЗапроса;
	
КонецФункции

////////////////////////////////////////////////////////////////////////////////
// Интерфейс для работы с подсистемой Печать.

// Заполняет список команд печати.
// 
// Параметры:
//   КомандыПечати - ТаблицаЗначений - состав полей см. в функции УправлениеПечатью.СоздатьКоллекциюКомандПечати
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
КонецПроцедуры

Функция ТекстЗапросаСведенияОбИсчисленииВычетовИПН(НомераТаблиц) 
	
	НомераТаблиц.Вставить("СведенияОбИсчисленииВычетовИПН", НомераТаблиц.Количество());
	
	ТекстЗапроса =  
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА &ПериодРегистрации
	|		ИНАЧЕ СтрокаВычетыИПН.МесяцНалоговогоПериода
	|	КОНЕЦ КАК Период,
	|	&ПериодРегистрации КАК ПериодРегистрации,
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА &ПериодРегистрации
	|		ИНАЧЕ СтрокаВычетыИПН.МесяцНалоговогоПериода
	|	КОНЕЦ КАК МесяцНалоговогоПериода,
	|	СтрокаВычетыИПН.ФизЛицо КАК ФизическоеЛицо,
	|	СУММА(СтрокаВычетыИПН.РазрешенныйВычет) КАК РазрешенныйВычет,
	|	СУММА(СтрокаВычетыИПН.ПримененныйВычет) КАК ПримененныйВычет,
	|	СтрокаВычетыИПН.ВидВычета КАК ВидВычета,
	|	ВЫБОР
	|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL 
	|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
	|					КОГДА НЕ &СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|						ТОГДА &СтруктурноеПодразделение
	|					ИНАЧЕ &ОбособленноеПодразделение
	|				КОНЕЦ
	|		ИНАЧЕ &ОбособленноеПодразделение
	|	КОНЕЦ КАК СтруктурнаяЕдиница,
	|	ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка) КАК ПодразделениеОрганизации
	|ИЗ
	|	ВТ_ВычетыИПН КАК СтрокаВычетыИПН
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Реквизиты КАК Реквизиты
	|		ПО (ИСТИНА)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_МестоРаботы КАК МестоРаботы
	|		ПО СтрокаВычетыИПН.ФизЛицо = МестоРаботы.ФизЛицо
	|			И (ВЫБОР
	|				КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|					ТОГДА &ПериодРегистрации
	|				ИНАЧЕ СтрокаВычетыИПН.МесяцНалоговогоПериода
	|			КОНЕЦ = МестоРаботы.Период)
	|ГДЕ
	|	(СтрокаВычетыИПН.РазрешенныйВычет <> 0
	|			ИЛИ СтрокаВычетыИПН.ПримененныйВычет <> 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА Реквизиты.ОтражениеПоПериодуРегистрации
	|			ТОГДА &ПериодРегистрации
	|		ИНАЧЕ СтрокаВычетыИПН.МесяцНалоговогоПериода
	|	КОНЕЦ,
	|	СтрокаВычетыИПН.ФизЛицо,
	|	СтрокаВычетыИПН.ВидВычета,
	|	ВЫБОР
	|		КОГДА &ПоддержкаРаботыСоСтруктурнымиПодразделениями
	|			ТОГДА ВЫБОР
	|					КОГДА НЕ МестоРаботы.СтруктурнаяЕдиница ЕСТЬ NULL 
	|						ТОГДА МестоРаботы.СтруктурнаяЕдиница
	|					КОГДА НЕ &СтруктурноеПодразделение = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|						ТОГДА &СтруктурноеПодразделение
	|					ИНАЧЕ &ОбособленноеПодразделение
	|				КОНЕЦ
	|		ИНАЧЕ &ОбособленноеПодразделение
	|	КОНЕЦ";
	
	Возврат ТекстЗапроса + ОбщегоНазначенияБКВызовСервера.ТекстРазделителяЗапросовПакета();
	
КонецФункции
	
////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.ВерсионированиеОбъектов

// Определяет настройки объекта для подсистемы ВерсионированиеОбъектов.
//
// Параметры:
//  Настройки - Структура - настройки подсистемы.
Процедура ПриОпределенииНастроекВерсионированияОбъектов(Настройки) Экспорт

КонецПроцедуры

// Конец СтандартныеПодсистемы.ВерсионированиеОбъектов

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецЕсли
