#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

////////////////////////////////////////////////////////////////////////////////
// ПРОГРАММНЫЙ ИНТЕРФЕЙС

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ

Процедура ПередЗаписью(Отказ)

	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ПроверитьДублирующиесяНастройки(Отказ);
	
	Если Не Отказ Тогда
		ПроверитьИспользованиеРезерва(Отказ);
	КонецЕсли;
	
	Если Не Отказ Тогда
		ПроверитьИспользованиеВидаРезерва(Отказ);
	КонецЕсли;

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

Процедура ПроверитьДублирующиесяНастройки(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка",        Ссылка);
	Запрос.УстановитьПараметр("Организация",   Организация);
	Запрос.УстановитьПараметр("Резерв",        Резерв);
	Запрос.УстановитьПараметр("ВидРезерва",    ВидРезерва);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  КонецПериода);
	Запрос.Текст =
	"ВЫБРАТЬ
    |   НастройкиРасчетаРезервовПоОплатеТруда.Ссылка КАК Ссылка
    |ИЗ
    |   Справочник.НастройкиРасчетаРезервовПоОплатеТруда КАК НастройкиРасчетаРезервовПоОплатеТруда
    |ГДЕ
    |   НастройкиРасчетаРезервовПоОплатеТруда.Ссылка <> &Ссылка
    |   И НастройкиРасчетаРезервовПоОплатеТруда.Организация = &Организация
    |   И НастройкиРасчетаРезервовПоОплатеТруда.Резерв = &Резерв
    |   И НастройкиРасчетаРезервовПоОплатеТруда.ВидРезерва = &ВидРезерва
    |   И (НастройкиРасчетаРезервовПоОплатеТруда.НачалоПериода = &НачалоПериода
    |           ИЛИ НастройкиРасчетаРезервовПоОплатеТруда.КонецПериода = &КонецПериода)";
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Отказ = Истина;
		ТекстСообщения = НСтр("ru = 'Запись с подобными настройками уже существует.'");
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьИспользованиеВидаРезерва(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка",        Ссылка);
	Запрос.УстановитьПараметр("Организация",   Организация);
	Запрос.УстановитьПараметр("Резерв",        Резерв);
	Запрос.УстановитьПараметр("ВидРезерва",    ВидРезерва);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НастройкиРасчетаРезервовПоОплатеТруда.Ссылка КАК Ссылка,
	|	НастройкиРасчетаРезервовПоОплатеТруда.ВидРезерва КАК ВидРезерва
	|ИЗ
	|	Справочник.НастройкиРасчетаРезервовПоОплатеТруда КАК НастройкиРасчетаРезервовПоОплатеТруда
	|ГДЕ
	|	НастройкиРасчетаРезервовПоОплатеТруда.Ссылка <> &Ссылка
	|	И НастройкиРасчетаРезервовПоОплатеТруда.Организация = &Организация
	|	И НастройкиРасчетаРезервовПоОплатеТруда.Резерв = &Резерв
	|	И НастройкиРасчетаРезервовПоОплатеТруда.ВидРезерва <> &ВидРезерва";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Отказ = Истина;
		ТекстСообщения = СтрШаблон(НСтр("ru = 'Выбранный резерв уже использован в настройках как вид резерва ""%1"".'"), Выборка.ВидРезерва);
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПроверитьИспользованиеРезерва(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка",        Ссылка);
	Запрос.УстановитьПараметр("Организация",   Организация);
	Запрос.УстановитьПараметр("Резерв",        Резерв);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НастройкиРасчетаРезервовПоОплатеТруда.Ссылка КАК Ссылка,
	|	НастройкиРасчетаРезервовПоОплатеТруда.Резерв КАК Резерв
	|ИЗ
	|	Справочник.НастройкиРасчетаРезервовПоОплатеТруда КАК НастройкиРасчетаРезервовПоОплатеТруда
	|ГДЕ
	|	НастройкиРасчетаРезервовПоОплатеТруда.Ссылка <> &Ссылка
	|	И НастройкиРасчетаРезервовПоОплатеТруда.Организация = &Организация
	|	И НастройкиРасчетаРезервовПоОплатеТруда.Резерв = &Резерв
	|	И НастройкиРасчетаРезервовПоОплатеТруда.ВидРезерва <> Значение(Перечисление.ВидыРезервовПоОплатеТруда.Отпуск)";
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Отказ = Истина;
		ТекстСообщения = НСтр("ru = 'Повторное использование резерва в настройках допустимо только для вида резерва ""Отпуск"".'");
		ВызватьИсключение ТекстСообщения;
	КонецЕсли;
	
КонецПроцедуры
    
#КонецЕсли
